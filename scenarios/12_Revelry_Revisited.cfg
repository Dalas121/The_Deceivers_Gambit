#textdomain wesnoth-tdg

#
# Garard's death is expected here. Plenty of foreshadowing, and any veteran Wesnoth player already knows how the story goes down.
# Deoran's death is hopefully somewhat surprising, and establishes Eldred as a credible threat to player characters.
#

#
# Mechanically, this scenario helps reconcile the difference between a player with a huge recall list vs a tiny recall list.
# If you have a large recall list, you'll need gold in the next scenario to recall them, which means you need to kill a lot of enemy leaders
# But, to recall troops, they also need to escape, which means they can't stick around and kill enemy leaders
# Therefore, the player is forced to choose between evacuating their veterans or using them to kill enemy leaders
#
# A player with a tiny recall list has no such dilemma, and can devote 100% of their gold to killing enemy leaders
#



#define ESCAPE_TURNS
6#enddef # no variation with difficulty, so units need to be committed to escape or fight, not fight-then-escape. Only the 2 eastern leaders are easy to kill and still escape

[scenario]
    id,map_file,name=12_Revelry_Revisited,12_Revelry_Revisited.map,_"Revelry, Revisited"
    next_scenario,victory_when_enemies_defeated=12x_The_King_is_Dead,no
    theme=Cutscene_Minimal
    {DEFAULT_SCHEDULE_FIRST_WATCH} turns=-1 # same as S10x
    {SCENARIO_MUSIC breaking_the_chains.ogg}
    
    {DE_TRACK {JOURNEY_12_NEW}}
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name,user_team_name=good,_"Deoran’s Company"
        {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES 1 4}
    
    
    #############################
    # ELDRED
    #############################
#define ELDRED_SIDE SIDE TYPE X Y ID TRAITS RECRUIT_LIST
    [side]
        side,controller,color={SIDE},ai,wesred
        type,id,x,y={TYPE},{ID},{X},{Y} {MODIFICATIONS( {TRAITS} )}
        gold,income,recruit={ON_DIFFICULTY4 15 30 30 45},-2,{RECRUIT_LIST} # no income - instead, give scaling gold each time Deoran kills a leader
        team_name,user_team_name=good,_"Army of Wesnoth" {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES_AREA {SIDE} {X} {Y} 6}
    {SILENTLY_LIMIT_LEADER_MOVES {SIDE} 1}
    [event]
        name,first_time_only=side {SIDE} turn,no
        {RESET_SIDE_AI {SIDE} defensive 0.2 0.6}
#         {VARY_AI_BY_SCHEDULE_ENEMY_NIGHTTIME {SIDE} 1} # slow
    [/event]
#enddef
    {ELDRED_SIDE 2 "Silver Mage"   15 18 eldred2 ({TRAIT_RESILIENT  }{TRAIT_STRONG     }) "Fencer,Mage"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "Red Mage" {ON_DIFFICULTY4 0 1 1 2}}
    
    {ELDRED_SIDE 3 "Iron Mauler"   10 16 eldred3 ({TRAIT_RESILIENT  }{TRAIT_INTELLIGENT}) "Heavy Infantryman,Spearman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Shock Trooper" {ON_DIFFICULTY4 0 1 1 2}}
    
    {ELDRED_SIDE 4 "Lieutenant"    14 12 eldred4 ({TRAIT_STRONG     }{TRAIT_RESILIENT  }) "Spearman,Fencer"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Swordsman" {ON_DIFFICULTY4 0 1 1 2}}
    
    {ELDRED_SIDE 5 "Shock Trooper" 21  9 eldred5 ({TRAIT_INTELLIGENT}{TRAIT_RESILIENT  }) "Heavy Infantryman,Spearman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Swordsman" {ON_DIFFICULTY4 0 1 1 2}}
    
    
    {ELDRED_SIDE 6 "Lieutenant"    38 15 eldred6 ({TRAIT_RESILIENT  }{TRAIT_INTELLIGENT}) "Spearman,Bowman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 6 "Longbowman" {ON_DIFFICULTY4 0 1 1 2}}
    
    {ELDRED_SIDE 7 "Javelineer"    36 10 eldred7 ({TRAIT_QUICK      }{TRAIT_RESILIENT  }) "Spearman,Bowman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 "Javelineer" {ON_DIFFICULTY4 0 1 1 2}}
    
    
    {ELDRED_SIDE 8 "Duelist"        1  8 eldred8 ({TRAIT_STRONG     }{TRAIT_QUICK      }) "Fencer,Spearman"}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Pikeman" {ON_DIFFICULTY4 0 1 1 2}}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 8 "Duelist" {ON_DIFFICULTY4 0 1 1 2}}
    {STARTING_VILLAGES_AREA 8 13 1 1} # otherwise multiple side send scouts to this one village
    
    
    #############################
    # ORCS
    #############################
    [side]
        side,controller,color=9,ai,white
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=bad,_"Clan Whitefang" {FLAG_VARIANT6 ragged}
    [/side]
    [side]
        side,controller,color=10,ai,black
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=bad,_"Clan Blackcrest" {FLAG_VARIANT6 ragged}
    [/side]
    
    [event]
        name,first_time_only=side 9 turn,no
        {RESET_SIDE_AI 9,10 defensive 0.9 0.1} # make orcs group up, so they advance a little slower. Gives the player more time to do things
#        {VARY_AI_BY_SCHEDULE 9,10} # this was slow
    [/event]
    
    # dummy side, used to store escaped units until the scenario ends (at which point they get swapped back to side 1, for the player to use next scenario)
    [side]
        side,controller,color=11,ai,black
        no_leader,hidden,gold,income=yes,yes,0,-2
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # GOLD PICKUP
        #############################
        # ensure the player has enough gold to recall all their veterans. This is bad for balance, but good for enjoyment.
        # players won't be happy if they have no chance to save parts of their recall list.
        {VARIABLE gold_pickup 0}
        [store_unit]
            {FILTER( side,level=1,2-99 )}
            variable=stored_veterans
        [/store_unit]
        [foreach]
            array=stored_veterans
            [do] {VARIABLE_OP gold_pickup add 25} [/do] # give 25 instead of 20, to account for upkeep while recalling.
        [/foreach]
        {VARIABLE_OP gold_pickup sub 200} # the player starts with 8 free recalls
        {CLEAR_VARIABLE stored_veterans}
        
        # minimum 500/300 gold. I expect this to be plenty for the average playthrough; you only get more if you have more than 20 veterans (not including cavalry)
        # if you have a really massive recall list, turn limit may be a problem, but there's not much I can do about that
        [if] {VARIABLE_CONDITIONAL gold_pickup less_than {ON_DIFFICULTY4 500 500 300 300}} {THEN({VARIABLE gold_pickup {ON_DIFFICULTY4 500 500 300 300}} )} [/if] 
        {GOLD_PICKUP 18 14 items/gold-coins-large.png $gold_pickup "" _"I’ve pillaged $gold_pickup gold from Eldred’s treasury!"} # matching S10x
        
        
        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE scenery/signpost.png 12 1}
        {PLACE_IMAGE terrain/castle/encampment/tent2.png 10 16} # these are "keeps"
        {PLACE_IMAGE terrain/castle/encampment/tent2.png 15 18}
        
        
        #############################
        # GUARDS
        #############################
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none" "Mage"              "Mage"              "Mage"             } 13 19 ({FACING sw} {ZONE_GUARDIAN 13 19 x,y,radius=12,17,4})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 "none" "Fencer"            "Fencer"            "Duelist"          } 15 16 ({FACING se} )}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"}  9 18 ({FACING ne} {ZONE_GUARDIAN  9 18 x,y,radius=12,17,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none" "none"              "none"              "Spearman"         }  9 15 ({FACING sw} {ZONE_GUARDIAN  9 15 x,y,radius=12,17,4})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none" "Shock Trooper"     "Shock Trooper"     "Shock Trooper"    } 12 15 ({FACING nw} {ZONE_GUARDIAN 12 15 x,y,radius=12,17,4})}
        
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none" "Spearman"          "Spearman"          "Swordsman"        } 12 11 ({FACING sw} {ZONE_GUARDIAN 12 11 x,y,radius=14,12,4})}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none" "Spearman"          "Spearman"          "Spearman"         } 17 13 ({FACING ne} )}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 "none" "Spearman"          "Spearman"          "Spearman"         } 20 12 ({FACING nw} )}
        
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none" "Spearman"          "Spearman"          "Swordsman"        } 22 10 ({FACING sw} {ZONE_GUARDIAN 22 10 x,y,radius=21,8,4})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none" "Shock Trooper"     "Shock Trooper"     "Shock Trooper"    } 19  8 ({FACING nw} {ZONE_GUARDIAN 19  8 x,y,radius=21,8,4})}
        {GENERIC_UNITC 5 {ON_DIFFICULTY4 "none" "Heavy Infantryman" "Heavy Infantryman" "Heavy Infantryman"} 23  9 ({FACING ne} {ZONE_GUARDIAN 23  9 x,y,radius=21,8,4})}
        
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none" "Bowman"            "Bowman"            "Bowman"           } 40 12 ({FACING se} {ZONE_GUARDIAN 40 12 x,y,radius=40,11,6})}
        {GENERIC_UNITC 6 {ON_DIFFICULTY4 "none" "Bowman"            "Bowman"            "Longbowman"       } 37 15 ({FACING sw} {ZONE_GUARDIAN 37 15 x,y,radius=40,11,6})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none" "none"              "none"              "Spearman"         } 38 10 ({FACING sw} {ZONE_GUARDIAN 38 10 x,y,radius=40,11,6})}
        {GENERIC_UNITC 7 {ON_DIFFICULTY4 "none" "Javelineer"        "Javelineer"        "Javelineer"       } 34 10 ({FACING sw} {ZONE_GUARDIAN 34 10 x,y,radius=40,11,6})}
        
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none" "Spearman"          "Spearman"          "Spearman"         }  4  6 ({FACING sw} {ZONE_GUARDIAN  4  6 x,y,radius=4,8,3})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none" "Fencer"            "Fencer"            "Fencer"           }  6  8 ({FACING nw} {ZONE_GUARDIAN  6  8 x,y,radius=4,8,3})}
        {GENERIC_UNITC 8 {ON_DIFFICULTY4 "none" "Spearman"          "Spearman"          "Pikeman"          }  2 10 ({FACING ne} {ZONE_GUARDIAN  2 10 x,y,radius=4,8,3})}
        
        
        #############################
        # ELDRED AND GARARD
        #############################
        [unit]
            {SINGLEUNITWML_GARARD}
            side,x,y,facing=2,28,12,se
        [/unit]
        {RESTORE_GARARD}
        [unit]
            {SINGLEUNITWML_ELDRED_UNARMED}
            side,x,y,facing=2,34,13,sw
        [/unit]
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,38,13,se
        [/unit]
        
        
        #############################
        # HIDE DELFADOR
        #############################
        [store_unit]
            {FILTER id=Delfador}
            variable,kill=stored_delfador,yes
        [/store_unit]
        
        
        #############################
        # RESTORE RECALL LIST
        #############################
        [foreach]
            array=stored_units_s10x
            [do]
                [unstore_unit]
                    variable=this_item
                    x,y,find_vacant=recall,recall,yes
                [/unstore_unit]
                {FULL_HEAL id=$this_item.id}
            [/do]
        [/foreach]
        {CLEAR_VARIABLE stored_units_s10x}
        
        
        #############################
        # DEORAN
        #############################
        [unstore_unit]
            variable=stored_deoran
            x,y=26,14
        [/unstore_unit]
        [if] {VARIABLE_CONDITIONAL poachers_were_recruited equals yes} {THEN(
            [set_extra_recruit]
                id=Deoran
                extra_recruit={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT},Poacher
            [/set_extra_recruit]
        )} {ELSE(
            [set_extra_recruit]
                id=Deoran
                extra_recruit={DELFADOR_MIDDLE_RECRUIT},{DELFADOR_BANDIT_RECRUIT}
            [/set_extra_recruit]
        )} [/if]
        [modify_unit]
            {FILTER id=Deoran}
            facing=sw
            [filter_recall]
            [/filter_recall]
        [/modify_unit]
        [remove_event]
            id=herodeath_deoran
        [/remove_event]
        
        
        #############################
        # COMPANION
        #############################
        {RECALL_COMPANION 24 15}
        {MODIFY_UNIT id=$companion_id facing ne}
        
        
        #############################
        # GOLD
        #############################
        [store_gold]
            side,variable=1,s11_carryover
        [/store_gold]
        [modify_side]
            side,gold=1,0
        [/modify_side]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        #############################
        # AWKWARD CHAT
        #############################
        {DELAY 1500}
        [message]
            speaker=$companion_id
            message= _ "So."
        [/message]
        [message]
            speaker=Deoran
            message= _ "So."
        [/message]
        {DELAY 5000} # awkward silences
        
        [message]
            speaker=$companion_id
            message= _ "Guess yer th’ boss now."
        [/message]
        [message]
            speaker=Deoran
            message= _ "It would seem as such. Would that Delfador had stayed."
        [/message]
        {DELAY 5000}
        
        [message]
            speaker=$companion_id
            message= _ "Hey, is it true what they says? Tha’ elves are th’ greatest bestest most beautifulest creatures there are? I’ve always wanted to meet ’em."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Elves? No. Be not fooled by a pretty face — I have seen even the noblest elven sage corrupted to such darkness as to rival the foulest human or orc."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Although, I suppose there is at least one young elf of my acquaintance to whom I might ascribe such virtues. My thoughts find her often, in these dark times."
        [/message]
        {DELAY 5000}
        
        [message]
            speaker=$companion_id
            message= _ "Ooh, ooh, did’ja ever fight a dragon? I hear they’s wings’re wider than a city, and their breath hotter th’ a volcano!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "No, I have not. Such a majestic crea—"
        [/message]
        {MODIFY_UNIT id=Garard facing sw}
        {MODIFY_UNIT id=Deoran facing se}
        [message]
            speaker=Garard
            message= _ "If you want DRAGONS— HA, let me tell— let me tell you the tale of king Haldric, my ancestor, first king of Wesnoth! And how he defeated the great dragon Shek’ha— She’ka— Se—"
        [/message]
        {DELAY 500}
        [message]
            speaker=Garard
            message= _ "Oh, forget it. Sometime when I’m sober."
        [/message]
        {DELAY 1000}
        {MODIFY_UNIT id=Deoran facing sw}
        {DELAY 4000}
        
        
        #############################
        # GARARD DIES
        #############################
        {MOVE_UNIT id=Kestrel 40 14}
        {KILL id=Kestrel}
        {DELAY 1500}
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,40,14,sw
        [/unit]
        {MOVE_UNIT id=Kestrel 35 13}
        {MODIFY_UNIT id=Eldred facing se}
        [message]
            speaker=Kestrel
            message= _ "Sir, Delfador and the Royal Cavalry are out of sight."
        [/message]
        {DELAY 500}
        {MOVE_UNIT id=Eldred 29 12}
        {MODIFY_UNIT id=Garard facing se}
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Father.</span>"
        [/message]
        [message]
            speaker=Garard
            message= _ "All healed up? Excellent. I admit, I was worried about you, son. “Soft” I thought — more like to take whispered orders from the wenc—  his mother, than to think for himself."
        [/message]
        {KILL id=Eldred}
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,29,12,sw
        [/unit]
        [message]
            speaker=Garard
            #po: I think this is the only time Garard actually calls Eldred by his name. Not "boy" or "son"
            message= _ "But now: sniffing out treachery in our own family, taking it upon yourself to bring Arand to justice! You may have failed, but failure does not diminish the trying. I’m proud of you, Eldred. I haven’t said that enough before."
        [/message]
        {MODIFY_UNIT id=Eldred side 9}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Too late.</span>"
        [/message]
        [harm_unit]
            {FILTER id=Garard} {FILTER_SECOND id=Eldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,43
        [/harm_unit]
        [object]
            {FILTER id=Garard}
            [effect]
                apply_to=image_mod
                add="R(100)"
            [/effect]
        [/object]
        [message]
            speaker=Garard
            message= _ "(shocked) Wha—"
        [/message]
        [harm_unit]
            {FILTER id=Garard} {FILTER_SECOND id=Eldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,79
        [/harm_unit]
        {KILL id=Garard ANIMATE=yes}
        
        {MODIFY_UNIT x,y=0-28,0-12 facing se}
        {MODIFY_UNIT x,y=0-28,13-99 facing ne}
        {MODIFY_UNIT x,y=29-99,0-12 facing sw}
        {MODIFY_UNIT x,y=29-99,13-99 facing nw}
        [message]
            speaker=Deoran
            message= _ "No!"
        [/message]
        
        
        #############################
        # ELDRED RALLIES THE TROOPS
        #############################
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>You all saw tha—</span> (gulp, deep breath)"
        [/message]
        {REPLACE_SCENARIO_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        {APPEND_MUSIC weight_of_revenge.ogg}
        {DELAY 2300} # it takes 2.3 seconds for the_dangerous_symphony to start playing properly
        [message]
            speaker=Eldred
            message= _ "You all saw that! DEORAN HAS SLAIN THE KING!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "What!?"
        [/message]
        [message]
            speaker=Eldred
            message= _ "First he schemes his way back into Wesnoth, exploiting this war to reclaim his old rank! And now that we are defenseless in celebration Deoran strikes at my father himself, in revenge for his long years of exile!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "You—"
        [/message]
        [message]
            speaker=Eldred
            message= _ "Mark my words, my father shall yet be avenged! Deoran dies today! And if his accomplice Delfador thinks that his crusade against my innocent uncle Arand will stave off my wrath, he is sorely mistaken!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I—"
        [/message]
        [message]
            speaker=Eldred
            message= _ "To arms, soldiers; TO ARMS!! DEORAN HAS SLAIN THE KING!!"
        [/message]
        {DELAY 500}
        
        [message]
            speaker=eldred4
            message= _ "What!! Did the prince just say the king is dead?!"
        [/message]
        [message]
            speaker=eldred2
            message= _ "Yes, slain by Deoran’s hand! And they say Delfador is an accomplice!!"
        [/message]
        {MODIFY_UNIT id=Deoran facing sw}
        [message]
            speaker=Deoran
            message= _ "No, no! Delfador is not my accomplice— I mean, neither of us are accomplices— that is to say—"
        [/message]
        [modify_side]
            {FILTER_SIDE side=2-99}
            team_name=bad
        [/modify_side]
        [message]
            speaker=eldred3
            message= _ "I knew it was a bad idea to let that exile back into our homeland!! Get Deoran! Avenge the king!"
        [/message]
        {MODIFY_UNIT id=Deoran facing se}
        [message]
            speaker=eldred7
            message= _ "For king Garard! Attack!"
        [/message]
        {DELAY 1500}
        
        
        #############################
        # DEORAN DECIDES ON HIS PLAN
        #############################
        {MODIFY_UNIT id=Deoran facing sw}
        [message]
            speaker=Deoran
            message= _ "(aghast) Horrors below, what has happened to my beautiful kingdom? I don’t— what do I do? They all believe Eldred!? I’m not ready for a fight!"
        [/message] # Such calamity... Garard’s own son; how could Eldred do such a thing? And turning the army against us?!
        {DELAY 1500}
        {GET_COMPANION_ID}
        [message]
            speaker=$companion_id
            message= _ "Listen boss, I ’aint much fer politics, but I knows when to run and that’s now! We gots to get out of here!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "I— yes, you’re right! With Garard dead Delfador commands the greatest honest force left in Wesnoth, and he has no idea what just transpired! Delfador must be warned."
        [/message]
        [message]
            speaker=Deoran
            message= _ "If we are lucky, we may yet be able to save Arand from Delfador’s ill-informed assault. But even barring that, Delfador’s leadership can surely rally enough soldiers to oppose Eldred by force of arms!

$companion_name, go, now! Slip away along the eastern road!"
        [/message]
        {MOVE_UNIT id=$companion_id 32 12}
        {DELAY 500}
        
        {MODIFY_UNIT id=$companion_id facing nw}
        {MODIFY_UNIT id=Deoran facing ne}
        [message]
            speaker=$companion_id
            message= _ "Hey, wait jus’ a moment! How come you yerself ’aint movin’? Don’t be stayin’ behind to sacrifice yourself or nothin’ like that now, you hear?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Nothing so heroic. Wesnoth’s forces may believe me a consiprator now, but I will not give up so easily. If I fight my way into a private audience with each leader I’m sure I can make them see the truth about Eldred — Garard’s poor family relationships were no secret.

Even if I can but convince commanders to delay their support for the traitor prince, that will give Delfador and I much-needed time to gather gold before our next battle!"
        [/message]
        [message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "<i>Defeating enemy leaders will increase your starting gold in the next scenario.</i>"
        [/message]
        [message]
            speaker=Deoran
            message= _ "When at last my strength is spent, I will flee through the forest — my steed is elf-stock, and no rival bred in Wesnoth can outpace its haste amongst the trees. But the more support I can garner now, the better our position will be in the future!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Now make haste, and godspeed! You must reunite with Delfador; I will send what soldiers I can spare after you!"
        [/message]
        
        {MOVE_UNIT id=$companion_id 36 11}
        {MODIFY_UNIT id=Deoran facing se}
        {MODIFY_UNIT id=Kestrel facing se}
        [message]
            x,y=36,10
            message= _ "Hey, you’re one of Delfador’s woodsmen!"
        [/message]
        {MOVE_UNIT id=$companion_id 37 12}
        {ANIMATE_ATTACK x,y=36,10 () no x,y=36,11}
        
        {MOVE_UNIT id=$companion_id 40 13}
        
        {MODIFY_UNIT id=$companion_id side 11}
        {PUT_TO_RECALL_LIST id=$companion_id}
        
        {ANIMATE_ATTACK x,y=40,12 () no x,y=40,13}
        
        
        #############################
        # RECALL DEORAN'S STARTING TROOPS
        #############################
        # once again we use L2 units for backups, as a catch-up mechanic for a player with no recall list
        {DELAY 500}
        {MODIFY_UNIT id=Deoran facing sw}
        {RECALL_INFANTRYMAN 2 27 15 "White Mage" ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_RESILIENT}}   {ANIMATE} )}
        {RECALL_INFANTRYMAN 2 25 16 "Javelineer" ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
        {RECALL_BANDIT      2 25 13 "Rogue"      ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_INFANTRYMAN 2 26 13 "Javelineer" ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
        {RECALL_BANDIT      2 28 13 "Outlaw"     ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_RESILIENT}}   {ANIMATE} )}
        {RECALL_BANDIT      2 22 14 "Rogue"      ( {ADD_MODIFICATION {TRAIT_RESILIENT}} {ADD_MODIFICATION {TRAIT_STRONG}}      {ANIMATE} )}
        {RECALL_BANDIT      0 27 16 "Footpad"    ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_INFANTRYMAN 0 30 14 "Spearman"   ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
#ifndef NIGHTMARE
#ifndef HARD
        # on lower difficulties give the player a few more units with which to fight
        {RECALL_INFANTRYMAN 0 25 16 "Fencer"     ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
        {RECALL_BANDIT      0 25 13 "Footpad"    ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_BANDIT      0 27 16 "Thief"      ( {ADD_MODIFICATION {TRAIT_STRONG}}    {ADD_MODIFICATION {TRAIT_QUICK}}       {ANIMATE} )}
        {RECALL_INFANTRYMAN 0 30 14 "Fencer"     ( {ADD_MODIFICATION {TRAIT_QUICK}}     {ADD_MODIFICATION {TRAIT_INTELLIGENT}} {ANIMATE} )}
#endif
#endif
        {DELAY 500}
        
        
        #############################
        # PREPARE BATTLEFIELD
        #############################
        {VARIABLE escape_turns_remaining {ESCAPE_TURNS}}
        [event]
            name=side 1 turn end
            first_time_only=no
            {VARIABLE_OP escape_turns_remaining sub 1}
        [/event]
        
        {KILL id=Eldred}
        {KILL id=Kestrel}
        
        {SET_LABEL 18 14 _"$gold_pickup gold"} # do this now instead of at the beginning, so it's not so obvious that this is a combat scenario
        [change_theme]
        [/change_theme]
        {VARIABLE bonus_gold 0}
        [capture_village]
            side,x,y,radius=1,26,14,3
        [/capture_village]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat as many enemy leaders as possible (bonus gold next scenario)."
                condition=win
            [/objective]
            [objective]
                {OPTIONAL_OBJECTIVE_CAPTION}
                # po: probably between 0 and 10
                description= _ "Evacuate veteran units ($|escape_turns_remaining turns remaining)"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                red,blue,green=0,255,255
                description="<b>" + _"This is the second-to-last scenario." + "</b>" # same formatting as {IS_LAST_SCENARIO}. Included here so players won't feel too bad about losing veterans
            [/note]
        [/objectives]
        
        [listen_for_mousemove]
        [/listen_for_mousemove]
        [event]
            name=mousemove_synced
            [do_command]
                [fire_event]
                    raise=mousemove # convert to a synced context
                [/fire_event]
            [/do_command]
        [/event]
        [event]
            name=select
            [do_command]
                [fire_event]
                    raise=mousemove # convert to a synced context
                [/fire_event]
            [/do_command]
        [/event]
        [event]
            name=mousemove,recruit,recall,side 1 turn end
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message= _ "Units that escape to the east will be available to recall in the next scenario, but units that do not escape will be lost (either killed or scattered). The eastern path will remain open until the end of turn {ESCAPE_TURNS}.

You should evacuate enough veterans to have a strong recall list next scenario, but also defeat enough enemy leaders so that you’ll have gold for recalling."
            [/message]
            
            {PLACE_IMAGE items/gohere.png 40 10}
            {PLACE_IMAGE items/gohere.png 40 11}
            {PLACE_IMAGE items/gohere.png 40 13}
            {HIGHLIGHT_IMAGE 40 12 items/gohere.png ()}
        [/event]
    [/event]
    
    #############################
    # UNIT ESCAPES
    #############################
    [event]
        name,first_time_only=moveto,no
        {FILTER( side,x,y=1,40,10-13 {NOT id=Deoran} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL escape_turns_remaining greater_than 0} )}
         
        {MODIFY_UNIT id=$unit.id side 11}
        {PUT_TO_RECALL_LIST id=$unit.id}
    [/event]
    [event]
        name,first_time_only=moveto,no
        {FILTER( side,x,y=1,40,10-13 {AND id=Deoran} )}
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL escape_turns_remaining greater_than 0} )}
        [message]
            speaker=Deoran
            message= _ "Fleeing too quickly will only seal my guilt in the eyes of Wesnoth’s commanders. I do not intend to run until I have no other choice!"
        [/message]
        [allow_undo]
        [/allow_undo]
    [/event]
    
    #############################
    # WARN ABOUT ORCS
    #############################
    [event]
        name=turn {ESCAPE_TURNS}
        [message]
            speaker=Deoran
            message= _ "I hear orc-drums approaching the eastern road! Any who wish to flee — now is your last chance."
        [/message]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   LEADER DEATHS
    #######################################################################################################################################################
#define GIVE_AIS_GOLD AMOUNT
    [gold]
        side=2,3,4,5,6,7,8
        amount={AMOUNT}
    [/gold]
#enddef
    #############################
    # GIVE BONUS GOLD
    #############################
    [event]
        name=prestart
        {VARIABLE bonus_per_leader {ON_DIFFICULTY4 125 125 75 75}}
        # not quite half, because the normal -50% rule expects you'll be getting a portion of your gold from carryover, which isn't affected directly by difficulty settings
    [/event]
    [event]
        name,first_time_only=give_bonus_gold,no
        
        # the first time you kill a leader, Deoran reminds you to evacuate some units
        {FIRE_EVENT keep_captured_explanation}
        
        # each leader gives Delfador gold in the next scenario
        {VARIABLE_OP bonus_gold add $bonus_per_leader}
        [if] {VARIABLE_CONDITIONAL s11_carryover greater_than 0}{THEN([message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "You will start the next scenario with $bonus_gold total gold (plus $s11_carryover carryover from Delfador)"
        [/message])} {ELSE([message]
            speaker,image=narrator,wesnoth-icon.png
            message= _ "You will start the next scenario with $bonus_gold total gold!"
        [/message])} [/if]
        
        # special event if you kill all leaders (which is very unlikely on high difficulties)
        {FIRE_EVENT are_all_leaders_dead}
        
        # give enemies gold each time you kill a leader
        # no variation with difficulty; you don't need much gold in the next scenario on easy anyway
        [if] {HAVE_UNIT canrecruit,count=yes,7} {THEN( {GIVE_AIS_GOLD  0} )} [/if]
        [if] {HAVE_UNIT canrecruit,count=yes,6} {THEN( {GIVE_AIS_GOLD 10} )} [/if]
        [if] {HAVE_UNIT canrecruit,count=yes,5} {THEN( {GIVE_AIS_GOLD 20} )} [/if]
        [if] {HAVE_UNIT canrecruit,count=yes,4} {THEN( {GIVE_AIS_GOLD 30} )} [/if]
        [if] {HAVE_UNIT canrecruit,count=yes,3} {THEN( {GIVE_AIS_GOLD 40} )} [/if]
        [if] {HAVE_UNIT canrecruit,count=yes,2} {THEN( {GIVE_AIS_GOLD 50} )} [/if]
        [if] {HAVE_UNIT canrecruit,count=yes,1} {THEN( )} [/if] # at this point only Deoran is left alive
    [/event]
    [event]
        name=keep_captured_explanation
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "One leader is defeated. I had hoped to gain a new ally, but depriving Eldred and buying time is good enough. And now that this keep is ours, I can recruit more soldiers to aid in the fight."
        [/message]
        [message]
            speaker=Deoran
            message= _ "I should remember — soldiers I evacuate east will be available to fight Eldred later, but if I evacuate too many I will be too weak to fight effectively here!"
        [/message]
    [/event]
    
    
    #############################
    # ELDRED-2 DIES (SILVER MAGE)
    #############################
    [event]
        name=last breath {FILTER id=eldred2}
        [message]
            speaker=Deoran
            message= _ "You are defeated, mage! Lend me your ear and hear the truth about Garard’s death! ’twas not I who struck the blow, but Prince Eldred!"
        [/message]
        [message]
            speaker=unit
            message= _ "I’m not stupid, Deoran; I’ve heard the whispers about how Asheviere is raising her son. But isn’t it all for the best? Garard wasn’t going to give up warmongering until we were all dead; at least this way maybe I can get back to Alduin in one piece!"
        [/message]
        
        [if] {HAVE_UNIT side,canrecruit=$unit.side,no} {THEN([message]
            speaker=Deoran
            message= _ "You care so little for the affairs of Wesnoth? Then go; lead your magi home, and trouble the mainland no more."
        [/message])} {ELSE([message]
            speaker=Deoran
            message= _ "You care so little for the affairs of Wesnoth? Then go; return home to Alduin, and trouble the mainland no more."
        [/message])} [/if]
        {KILL side=$unit.side}
        {FIRE_EVENT give_bonus_gold}
    [/event]
    
    
    #############################
    # ELDRED-3 DIES (IRON MAULER)
    #############################
    [event]
        name=last breath {FILTER id=eldred3}
        [message]
            speaker=Deoran
            message= _ "Your flail has failed you, mauler! Now use your ears instead, and hear the truth about our king Garard’s death!"
        [/message]
        [message]
            speaker=unit
            message= _ "Spare me the theatrics, Deoran, I knew Eldred was going to knock off the old tyrant. But gold is gold, and our prince has offered me a whole lot of it to stick with the “official” story."
        [/message]
        [message]
            speaker=unit
            message= _ "Prince Eldred knows how to reward his allies. Give up now, accept the blame, and he might even let you spend the rest of your days back in exile instead of prison."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Garard was no hero, but you, soldier, are a villian. May your heirs prove wiser than you were."
        [/message]
        {ANIMATE_ATTACK id=$second_unit.id () no x,y=$unit.x,$unit.y}
        {KILL id=$unit ANIMATE=yes}
        {KILL side=$unit.side}
        {FIRE_EVENT give_bonus_gold}
    [/event]
    
    
    #############################
    # ELDRED-4 DIES (LIEUTENANT)
    #############################
    [event]
        name=last breath {FILTER id=eldred4}
        [message]
            speaker=unit
            message= _ "I would rather fall upon my own blade than be captured by you, traitor! May I rejoin my king in death!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "No, wait! You don’t—"
        [/message]
        {KILL id=$unit.id ANIMATE=yes}
        [message]
            speaker=Deoran
            message= _ "—need to die."
        [/message]
        [message]
            speaker=Deoran
            message= _ "Eldred, wherever you’re hiding, may you someday feel remorse for all the good men and women of Wesnoth who have died today."
        [/message]
        {KILL side=$unit.side}
        {FIRE_EVENT give_bonus_gold}
    [/event]
    
    
    #############################
    # ELDRED-5 DIES (SHOCK TROOPER)
    #############################
    [event]
        name=last breath {FILTER id=eldred5}
        [message]
            speaker=Deoran
            message= _ "You—"
        [/message]
        [message]
            speaker=unit
            message= _ "Don’t even start. Garard dragged me away from my life of luxury to be an officer in his lousy war. I always wanted him dead, and I’m glad someone finally built up the courage to do it."
        [/message]
        [message]
            speaker=unit
            message= _ "Kill me if you must, but I’ll never condemn the prince’s actions. From what I hear, Garard was a pretty lousy father and husband too. Now am I free to go, or not?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "..."
        [/message]
        [message]
            speaker=unit
            message= _ "That’s what I thought. Now if you’ll get out of my way, my men and I are going back home."
        [/message]
        {KILL side=$unit.side}
        {FIRE_EVENT give_bonus_gold}
        [message]
            speaker=Deoran
            message= _ "Garard earned himself so much ill will..."
        [/message]
    [/event]
    
    
    #############################
    # ELDRED-6 DIES (LIEUTENANT)
    #############################
    [event]
        name=last breath {FILTER id=eldred6}
        [message]
            speaker=unit
            message= _ "*spits* Traitor. Kill me if you must, but I will never betray my country."
        [/message]
        [message]
            speaker=Deoran
            message= _ "My comrade-in-arms, you already have. Look around! Eldred commands you to fight and die on his behalf, while he himself has fled the battlefield.

Are these the actions of an orphaned son, filled with a righeous desire for vengeance? Or is this a scheming usurper, pitting his kingdom against itself while he watches from a safe distance?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "You know me, $unit.name; we have fought side by side for many years now. Do you truly believe that I would conspire with Delfador to assassinate the king?"
        [/message]
        [if] {HAVE_UNIT side,canrecruit=$unit.side,no} {THEN([message]
            speaker=unit
            message= _ "I *thought* I knew you... I’m just not sure anymore. Who speaks the truth? Maybe I need to get away from all this fighting and take time to think. Men, let’s get out of here!"
        [/message])} {ELSE([message]
            speaker=unit
            message= _ "I *thought* I knew you... I’m just not sure anymore. Who speaks the truth? Maybe I need to get away from all this fighting and take time to think."
        [/message])} [/if]
        {KILL side=$unit.side}
        {FIRE_EVENT give_bonus_gold}
    [/event]
    
    
    #############################
    # ELDRED-7 DIES (JAVELINEER)
    #############################
    [event]
        name=last breath {FILTER id=eldred7}
        [message]
            speaker=unit
            message= _ "Wait, please don’t kill me! Deoran, I know that you would never betray Garard, but I’m just so scared! If even the king can be killed, what hope do I have if I speak up?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Then stand alongside me, and we will fight together for the truth! Eldred’s lies cannot be allowed to spread."
        [/message]
        [message]
            speaker=unit
            message= _ "Fighting together with you didn’t do the king much good, did it? No, my company and I are getting out of here while we still have the chance!"
        [/message]
        {KILL side=$unit.side}
        {FIRE_EVENT give_bonus_gold}
    [/event]
    
    
    #############################
    # ELDRED-8 DIES (DUELIST)
    #############################
    [event]
        name=last breath {FILTER id=eldred8}
        [message]
            speaker=Deoran
            message= _ "Stand down! Hold your sword and hear me out! By the very sceptre itself, I swear I did not kill the king!"
        [/message]
        [message]
            speaker=unit
            message= _ "Wait, what!? King Garard is dead!? I heard a commotion in camp and sent my fighters to help - how did the king die? What are you doing here?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "Your ignorance is truly a relief to hear, for Prince Eldred has slain the king, and blamed me for the fell deed! I have been fighting most fiercly against Eldred and his allies. If you are in any shape to help, I could sorely use your aid."
        [/message]
        [message]
            speaker=unit
            message= _ "I— yes, of course! Anything I can do."
        [/message]
        
        {MODIFY_UNIT id=$unit.id hitpoints 23}
        {MODIFY_UNIT id=$unit.id canrecruit no}
        {MODIFY_UNIT side=8 side 1}
        
        {FIRE_EVENT give_bonus_gold}
    [/event]
    
    
    #############################
    # ALL LEADERS ARE DEAD
    #############################
    [event]
        name=are_all_leaders_dead
        {FILTER_CONDITION({HAVE_UNIT( count,canrecruit=0,yes {AND side=2,3,4,5,6,7,8} )})}
        
        {DELAY 500}
        [message]
            speaker=Deoran
            message= _ "That’s the last of the leaders. Eldred has been deprived of his entire northern force! Well done, well done all!"
        [/message]
        {ACHIEVE s12}
        [message]
            speaker=Deoran
            message= _ "All that now remains is for us to hold as long as possible, and be a nuisance to Eldred’s orcish allies! The longer we survive, the longer Delfador will have to prepare!"
        [/message]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Survive as long as possible (bonus gold next scenario)."
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                red,blue,green=0,255,255
                description="<b>" + _"This is the second-to-last scenario." + "</b>"
            [/note]
        [/objectives]
        
        
        #############################
        # GAIN GOLD EACH TURN
        #############################
        [event]
            name=new turn
            first_time_only=no
            {VARIABLE_OP bonus_gold add 5} # small amount per-turn; this is only here for the rare few players who survive this long
            [if] {VARIABLE_CONDITIONAL s11_carryover greater_than 0}{THEN([message]
                speaker,image=narrator,wesnoth-icon.png
                message= _ "You will start the next scenario with $bonus_gold total gold (plus $s11_carryover carryover from Delfador)"
            [/message])} {ELSE([message]
                speaker,image=narrator,wesnoth-icon.png
                message= _ "You will start the next scenario with $bonus_gold total gold!"
            [/message])} [/if]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                 INFINITE ORC SPAWNS
    #######################################################################################################################################################
    [event]
        name=side 8 turn {ESCAPE_TURNS} end
        [replace_map]
            map_file=12b_Revelry_Revisited.map
            expand=yes
        [/replace_map]
        
        #############################
        # SPAWN WHITEFANGS 
        #############################
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   } 48 15 ()} # these guys were previously off-map; no need to animate
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"       "Orcish Grunt"       "Orcish Grunt"      } 46 16 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   } 48 16 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"       "Orcish Warrior"     "Orcish Warrior"    } 47 19 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "none"            "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   } 48 16 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "none"            "Orcish Crossbowman" "Orcish Crossbowman" "Orcish Crossbowman"} 48 20 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "none"            "none"               "none"               "Goblin Spearman"   } 46 21 ()}
        
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"       "Orcish Grunt"       "Orcish Warrior"    } 47 10 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   } 43  7 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin"    "Orcish Slayer"      "Orcish Slayer"     } 47  8 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   } 48 10 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "none"            "Orcish Grunt"       "Orcish Grunt"       "Orcish Grunt"      } 47  7 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "none"            "Orcish Archer"      "Orcish Archer"      "Orcish Archer"     } 46  5 ()}
        {GENERIC_UNITC 9 {ON_DIFFICULTY4 "none"            "none"               "none"               "Goblin Spearman"   } 44 10 ()}
        [unit]
            type,id,name=Orcish Sovereign,Ushka'e,_"Chief Ushka'e"
            x,y=44,8 {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_RESILIENT} )}
            side,canrecruit,facing=9,yes,sw
        [/unit]
        
        
        #############################
        # SPAWN BLACKCRESTS 
        #############################
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "Orcish Adept"    "Orcish Adept"    "Orcish Adept"      "Orcish Adept"      }  6  1 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"            "Orcish Grunt"    "Orcish Grunt"      "Orcish Grunt"      }  5  1 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"            "Orcish Adept"    "Orcish Adept"      "Orcish Adept"      }  7  3 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"            "none"            "none"              "Orcish Assassin"   }  5  3 ({ANIMATE})}
        
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "Orcish Adept"    "Orcish Adept"    "Orcish Shaman"     "Orcish Shaman"     } 11  1 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"    "Orcish Warrior"    "Orcish Warrior"    } 17  1 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin" "Orcish Assassin"   "Orcish Assassin"   } 15  2 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"    "Orcish Grunt"      "Orcish Grunt"      } 10  1 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"            "Orcish Adept"    "Orcish Adept"      "Orcish Adept"      } 12  2 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"            "Orcish Grunt"    "Orcish Grunt"      "Orcish Grunt"      } 20  1 ({ANIMATE})}
        {GENERIC_UNITC 10 {ON_DIFFICULTY4 "none"            "none"            "none"              "Orcish Shaman"     } 21  1 ({ANIMATE})}
        [unit]
            type,id,name=Orcish Sovereign,Ghuvog,_"Chief Ghuvog"
            profile=portraits/orcs/grunt-6.webp
            x,y=13,2 {MODIFICATIONS( {TRAIT_STRONG} {TRAIT_RESILIENT} )}
            side,canrecruit,facing=10,yes,se
            animate=yes
        [/unit]
        
        
        #############################
        # INTRODUCE ORCS
        #############################
        {REMOVE_IMAGE 40 10}
        {REMOVE_IMAGE 40 11}
        {REMOVE_IMAGE 40 12}
        {REMOVE_IMAGE 40 13}
        [message]
            speaker=Ghuvog
            message= _ "You’d better keep your human-queen’s promise of pillage, worms! Chief Ghuvog of the Blackcrests is not cheap to buy!"
        [/message]
        [message]
            speaker=Ushka'e
            message= _ "And don’t dare forget about Chief Ushka'e of the Whitefangs, princeling! Asheviere promised me that Fort Garard would burn to the ground!"
        [/message]
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,34,3,sw
        [/unit]
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,33,3,sw
        [/unit]
        [message]
            speaker=Eldred
            message= _ "Ah, mother’s promised reinforcements! You’re late; the king is already dead. But help me squash this little rebel problem, and once we have consolidated control of Wesnoth my mother will surely reward you generously."
        [/message]
        {DELAY 500}
        
        [message]
            speaker=Deoran 
            message= _ "Eldred has recruited the orcish clans to support his cause! With orcs swarming across the mountains, the road east to Delfador is no longer safe. There will be no more escape that way."
        [/message]
        {KILL id=Eldred} {KILL id=Kestrel}
        {KILL id=Ghuvog} {KILL id=Ushka'e}
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat as many enemy leaders as possible (bonus gold next scenario)."
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=0,no
            [/gold_carryover]
            [note]
                red,blue,green=0,255,255
                description="<b>" + _"This is the second-to-last scenario." + "</b>"
            [/note]
        [/objectives]
        
        
        #############################
        # PREVENT SURPRISE ATTACK
        #############################
        # since this is the first time the orcs have spawned, don't let them attack immediately.
        # We won't be as nice for future spawns
        [event]
            name=side 9 turn refresh
            {MODIFY_UNIT side=9 moves 2}
            {MODIFY_UNIT side=9 attacks_left 0}
        [/event]
        [event]
            name=side 10 turn refresh
            {MODIFY_UNIT side=10 moves 2}
            {MODIFY_UNIT side=10 attacks_left 0}
        [/event]
    [/event]
    
    
    #############################
    # CONTINUAL SPAWNS 
    #############################
#define SLOW_UNIT SIDE TYPE X Y
    {GENERIC_UNITC 9 {TYPE} {X} {Y} ([+unit]
        moves=3 # don't let newly spawned units move too far (but they are allowed to attack!)
    [/unit])}
#enddef
    [event]
        name,first_time_only=side 9 turn refresh,no
        {FILTER_CONDITION(
                  {VARIABLE_CONDITIONAL turn_number equals 12}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 15}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 18}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 21}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 23}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number greater_than_equal_to 25}  )}
        )}
        {SCROLL_TO 47 13}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   }) 48 15}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"       "Orcish Grunt"       "Orcish Grunt"      }) 46 16}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   }) 48 16}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"       "Orcish Warrior"     "Orcish Warrior"    }) 47 19}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "none"            "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   }) 48 16}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "none"            "Orcish Crossbowman" "Orcish Crossbowman" "Orcish Crossbowman"}) 48 20}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "none"            "none"               "none"               "Goblin Spearman"   }) 46 21}
        
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"       "Orcish Grunt"       "Orcish Warrior"    }) 47 10}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   }) 43  7}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin"    "Orcish Slayer"      "Orcish Slayer"     }) 47  8}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "Goblin Spearman" "Goblin Spearman"    "Goblin Spearman"    "Goblin Spearman"   }) 48 10}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "none"            "Goblin Impaler"     "Goblin Impaler"     "Goblin Impaler"    }) 47  7}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "none"            "Orcish Archer"      "Orcish Archer"      "Orcish Archer"     }) 46  5}
        {SLOW_UNIT 9 ({ON_DIFFICULTY4 "none"            "none"               "none"               "Goblin Spearman"   }) 44 10}
    [/event]
    
    [event]
        name,first_time_only=side 10 turn refresh,no
        {FILTER_CONDITION(
                  {VARIABLE_CONDITIONAL turn_number equals 12}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 15}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 18}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 21}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number equals 23}  )}
            {OR(  {VARIABLE_CONDITIONAL turn_number greater_than_equal_to 25}  )}
        )}
        {SCROLL_TO 13 1}
        
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "Orcish Adept"    "Orcish Adept"    "Orcish Adept"      "Orcish Adept"      }  6  1}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "none"            "Orcish Grunt"    "Orcish Grunt"      "Orcish Grunt"      }  5  1}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "none"            "Orcish Adept"    "Orcish Adept"      "Orcish Adept"      }  7  3}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "none"            "none"            "none"              "Orcish Assassin"   }  5  3}
        
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "Orcish Adept"    "Orcish Adept"    "Orcish Shaman"     "Orcish Shaman"     } 11  1}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"    "Orcish Warrior"    "Orcish Warrior"    } 17  1}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "Orcish Assassin" "Orcish Assassin" "Orcish Assassin"   "Orcish Assassin"   } 15  2}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "Orcish Grunt"    "Orcish Grunt"    "Orcish Grunt"      "Orcish Grunt"      } 10  1}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "none"            "Orcish Adept"    "Orcish Adept"      "Orcish Adept"      } 12  2}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "none"            "Orcish Grunt"    "Orcish Grunt"      "Orcish Grunt"      } 20  1}
        {SLOW_UNIT 10 {ON_DIFFICULTY4 "none"            "none"            "none"              "Orcish Shaman"     } 21  1}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                INFINITE HUMAN SPAWNS
    #######################################################################################################################################################
    [event]
        name=side 7 turn 11
        [message]
            side,canrecruit=2-9,yes
            message= _ "Deoran’s still putting up a fight! Reinforcements — call reinforcements from across the river!"
        [/message]
        {GENERIC_UNITC 3 "Boat"              1 20 ({ANIMATE}{IMMOBILE}{FACING ne})}
        {GENERIC_UNITC 3 "Transport Galleon" 2 21 ({ANIMATE}{IMMOBILE}{FACING ne})}
        {GENERIC_UNITC 3 "Boat"              4 21 ({ANIMATE}{IMMOBILE}{FACING nw})}
        
        #############################
        # ONE SPAWN 
        #############################
        [event]
            name=reinforce_eldred
            first_time_only=no
            
            {SCROLL_TO 14 20}
            [if] {HAVE_UNIT type=Boat,"Transport Galleon"} {THEN(
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "Spearman" "Spearman" "Spearman" "Spearman"}) 2 20 ()}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"  }) 3 21 ()}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "Fencer"   "Fencer"   "Fencer"  }) 3 19 ()}
                {GENERIC_UNITC 3 ({ON_DIFFICULTY4 "none"     "none"     "none"     "Bowman"  }) 5 21 ()}
            )} [/if]
            
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Heavy Infantryman" "Heavy Infantryman" "Shock Trooper" "Shock Trooper"    }) 24 21 ()}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "Mage"              "Mage"          "Mage"             }) 25 21 ()}
            {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"              "none"              "none"          "Heavy Infantryman"}) 24 20 ()}
            
            {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "Fencer"   "Fencer"   "Fencer"   "Fencer"  }) 30 21 ()}
            {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"     "Fencer"   "Duelist"  "Fencer"  }) 31 21 ()}
            {GENERIC_UNITC 6 ({ON_DIFFICULTY4 "none"     "none"     "none"     "Spearman"}) 32 21 ()}
        [/event]
        {FIRE_EVENT reinforce_eldred}
        
        #############################
        # CONTINUAL SPAWNS 
        #############################
        [event]
            name,first_time_only=side 8 turn end,no
            {FILTER_CONDITION(
                      {VARIABLE_CONDITIONAL turn_number equals 13}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 15}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 17}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 19}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 21}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number equals 23}  )}
                {OR(  {VARIABLE_CONDITIONAL turn_number greater_than_equal_to 25}  )}
            )}
            {FIRE_EVENT reinforce_eldred}
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # DEORAN DIES
    #############################
    [event]
        name=last breath {FILTER id=Deoran}
        
        {FADE_MUSIC_OUT 500}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {FADE_MUSIC_IN 100}
        
        #############################
        # DEORAN FLEES
        #############################
        [if] {HAVE_UNIT side,canrecruit=1,no} {THEN(
            [message]
                speaker=unit
                message= _ "Agony!! My arm goes limp, I can fight no longer. Any allies yet standing, scatter, scatter to the hills! It is I they will chase, not you."
            [/message]
            [message]
                speaker=unit
                message= _ "And as for me, well, I may have cut things rather closer than I had planned. But what’s done is done — my thoughts must now turn to flight. Make haste, my loyal steed!"
            [/message]
        )} {ELSE(
            [message]
                speaker=Deoran
                message= _ "Agony!! My arm goes limp, I can fight no longer. This may be cutting things rather closer than I had planned, but what’s done is done."
            [/message]
            [message]
                speaker=unit
                message= _ "My thoughts must now turn to flight: make haste, my loyal steed!"
            [/message]
        )} [/if]
        {KILL( side=1 {NOT id=Deoran} )}
        {KILL( x,y=17,6 {FILTER_LOCATION radius=2} {NOT id=Deoran} )} # clear out the cutscene area
        {KILL( x,y=12,4 {FILTER_LOCATION radius=2} {NOT id=Deoran} )}
        {KILL( x,y=8,2  {FILTER_LOCATION radius=3} {NOT id=Deoran} )}
        
        {MOVE_UNIT id=Deoran 17 6}
        {MOVE_UNIT id=Deoran 12 4}
        {MOVE_UNIT id=Deoran  8 2}
        {REPLACE_SCENARIO_MUSIC heroes_rite.ogg}
        
        
        #############################
        # KESTREL STRIKES
        #############################
        [unit]
            {SINGLEUNITWML_KESTREL}
            side,x,y,facing=2,9,2,sw
        [/unit]
        [harm_unit]
            {FILTER id=Deoran} {FILTER_SECOND id=Kestrel}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=no,yes,11
        [/harm_unit]
        [message]
            speaker=Deoran
            message= _ "Where did you come from! My horse is lamed; I can ride no further!"
        [/message]
        
        
        #############################
        # ELDRED GLOATS
        #############################
        [unit]
            {SINGLEUNITWML_ELDRED}
            side,x,y,facing=2,5,1,se
            animate=yes
        [/unit]
        {MOVE_UNIT id=Eldred 7 2}
        [message]
            speaker=Eldred
            message= _ "(grins)"
        [/message]
        {MODIFY_UNIT id=Deoran facing nw}
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Well, if it isn’t Deo—</span> ...If it isn’t Deoran the exile, one-time commander of the South Guard, a soldier through the very end. Mother told me all about you, you know. A perfect example of who not to be."
        [/message]
        [message]
            speaker=Deoran
            message= _ "At last the usurper dares to face me, now that I am too injured for battle. He knows he cannot face me in a fair fight."
        [/message]
        [message]
            speaker=Eldred
            message= _ "I also know you’re a man of your word, so I’m going to give you a choice. You can surrender, leave Wesnoth, and swear to never again raise arms up against my mother’s— ...<b><i>my</i></b> rule."
        [/message]
        [message]
            speaker=Eldred
            message= _ "Or you can fight, die, and have your corpse hoisted upon the walls of Weldyn as a warning to others. Which will it be, Deoran?"
        [/message]
        [message]
            speaker=Deoran
            message= _ "..."
        [/message]
        [message]
            speaker=Deoran
            message= _ "More than anything does my spirit yearn to go on fighting, to risk it all on a chance at vanquishing the one responsible for all this wretched destruction!"
        [/message]
        [message]
            speaker=Deoran
            message= _ "But my heart remembers better places, happier times. There are... people I wish to speak to, things I have left unsaid. Prince Eldred, I lay down my arms and accept your offer of surrender."
        [/message]
        
        
        #############################
        # DEORAN DIES
        #############################
        [harm_unit]
            {FILTER id=Deoran} {FILTER_SECOND id=Eldred}
            [primary_attack]
                range=melee
            [/primary_attack]
            kill,animate,amount=yes,yes,17
        [/harm_unit]
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Idiot.</span>"
        [/message]
        {DELAY 1500}
        [message]
            speaker=Eldred
            message= _ "<span size='x-small'>Mother was right, as usual. Not a deceitful bone in his body.</span>"
        [/message]
        [message]
            speaker=Kestrel
            message= _ "The traitor is vanquished! Now hail, hail to your new king!"
        [/message]
        
        
        #############################
        # HAIL TO THE KING
        #############################
        # speaker 1
        {STORE_UNIT_VAR (race,canrecruit=human,yes {AND side=3,4,5,6,7,8}) id speaker1_id}
        [if] {VARIABLE_CONDITIONAL speaker1_id equals $null} {THEN(
            {STORE_UNIT_VAR (race,canrecruit=human,no {AND side=3,4,5,6,7,8}) id speaker1_id}
        )} [/if]
        [message]
            id=$speaker1_id
            message= _ "Hail king Eldred!"
        [/message]
        
        # speaker 2
        {STORE_UNIT_VAR (race,canrecruit=human,yes {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}) id speaker2_id}
        [if] {VARIABLE_CONDITIONAL speaker2_id equals $null} {THEN(
            {STORE_UNIT_VAR (race,canrecruit=human,no {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}) id speaker2_id}
        )} [/if]
        [message]
            id=$speaker2_id
            image_pos=right
            message= _ "Hail, long live king Eldred!"
        [/message]
        
        # speaker 3
        {STORE_UNIT_VAR (race,canrecruit=human,yes {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}{NOT id=$speaker2_id}) id speaker3_id}
        [if] {VARIABLE_CONDITIONAL speaker3_id equals $null} {THEN(
            {STORE_UNIT_VAR (race,canrecruit=human,no {AND side=3,4,5,6,7,8} {NOT id=$speaker1_id}{NOT id=$speaker2_id}) id speaker3_id}
        )} [/if]
        [message]
            id=$speaker3_id
            message= _ "Long live the king!"
        [/message]
        {CLEAR_VARIABLE speaker1_id,speaker2_id,speaker3_id}
        
        # closing
        {DELAY 500}
        [message]
            speaker=Eldred
            message= _ "Yes... long live the king."
        [/message]
        {DELAY 1500}
        
        
        #############################
        # CLEANUP
        #############################
        {KILL side=1}
        {MODIFY_UNIT side=11 side 1} # so they're available for Delfador to recall
        {CLEAR_VARIABLE escape_turns_remaining}
        [unstore_unit]
            variable=stored_delfador # unstore this so we have the correct leader name / side id / whatever for the next scenario
            x,y=recall,recall
        [/unstore_unit]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 0}
        [/endlevel]
    [/event]
    
    {HERODEATHS}
[/scenario]

#undef ELDRED_SIDE
#undef ESCAPE_TURNS

