#textdomain wesnoth-tdg


#
# this mission revolves around defending delfador's cave, while also destroying enough cave entrances that you don't get overwhelmed
# it's a lot easier if you have poachers from S08 - they're very strong vs the zombie drakes
#
# it's also your first mission without Delfador
#



[scenario]
    id,map_file,name=09_Omaranth,09_Omaranth.map,_"Omaranth"
    next_scenario,victory_when_enemies_defeated=09x_Elensefar_Outskirts,no
    {WINTER_SCHEDULE} turns=15
    current_time=3
          {SCENARIO_MUSIC weight_of_revenge.ogg}
    {EXTRA_SCENARIO_MUSIC nunc_dimittis.ogg}
    
    {DE_TRACK {JOURNEY_09_NEW}}
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,{ON_DIFFICULTY4 100 100 50 50}
        team_name,user_team_name=wesnoth,_"Delfador’s Hirelings"
        shroud=yes
        {FLAG_VARIANT loyalist}
    [/side]
    
    #############################
    # UNDEAD
    #############################
    [side]
        side,controller,color=2,ai,white
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=undead,_"Omaranth’s Flight"
        {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI  2 defensive 0.99 0.01}
        {MODIFY_SIDE_AI 2 retreat_factor=0}
        {MODIFY_SIDE_AI 2 ({GOAL_LOCATION 1 x,y=16,6})}
    [/event]
    
    #############################
    # ANIMALS
    #############################
    [side]
        side,controller,color=3,ai,green
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=fauna,_"Fauna"
        {FLAG_VARIANT6 ragged}
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # SCENERY
        #############################
        {PLACE_IMAGE scenery/cave-entrance2.png 17 1}
        {PLACE_IMAGE scenery/village-human-burned3.png  20 8}
        {PLACE_IMAGE "items/bones.png"      21 7}
        {PLACE_IMAGE "items/bones.png"      14 6}
        {PLACE_IMAGE "items/bones.png~FL()" 19 5}
        {PLACE_IMAGE "items/bones.png~FL()" 18 8}
        {PLACE_IMAGE "items/bones.png"      18 9}
        {PLACE_IMAGE "items/bones.png~FL()" 19 9}
        {PLACE_IMAGE "items/bones.png~FL()" 22 8}
        
        #############################
        # GOLD PICKUP
        #############################
        {PLACE_IMAGE items/gold-coins-small.png 19 8}
        [event]
            name=moveto
            id=gold_pickup
            {FILTER side,x,y=1,19,8}
            [message]
                speaker=Delfador
                message=_"Well, at least whoever cleared this place out left behind some gold. That’s {ON_DIFFICULTY4 50 50 30 30} more for the treasury."
            [/message]
            {SOUND gold.ogg}
            [gold]
                side,amount=1,{ON_DIFFICULTY4 50 50 30 30}
            [/gold]
            {REMOVE_IMAGE $unit.x $unit.y}
        [/event]
        
        #############################
        # FAUNA
        #############################
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Dragonfly" "Dragonfly" "Grand Dragonfly" "Grand Dragonfly"  } 12 18 ({GUARDIAN})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"      "Dragonfly" "Dragonfly"       "Grand Dragonfly"  } 25 14 ({GUARDIAN})}
        
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"      "Dragonfly" "Dragonfly"       "Grand Dragonfly"  }  4  9 ({ROLE dflies}{ZONE_GUARDIAN  4  9  ( radius=5 {FILTER role=dflies} )}) }
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Dragonfly" "Dragonfly" "Dragonfly"       "Grand Dragonfly"  }  5 11 ({ROLE dflies}{ZONE_GUARDIAN  5 11  ( radius=5 {FILTER role=dflies} )}) }
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Dragonfly" "Dragonfly" "Grand Dragonfly" "Grand Dragonfly"  } 10 11 ({ROLE dflies}{ZONE_GUARDIAN 10 11  ( radius=5 {FILTER role=dflies} )}) }
        
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Icemonax" "Icemonax"       "Icemonax"       "Icemonax"      } 25 8 ({ZONE_GUARDIAN 25 8  ( radius=5 {FILTER type=Icemonax,"Great Icemonax"} )}) }
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Icemonax" "Icemonax"       "Icemonax"       "Great Icemonax"} 26 8 ({ZONE_GUARDIAN 26 8  ( radius=5 {FILTER type=Icemonax,"Great Icemonax"} )}) }
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "Icemonax" "Great Icemonax" "Great Icemonax" "Great Icemonax"} 26 9 ({ZONE_GUARDIAN 26 9  ( radius=5 {FILTER type=Icemonax,"Great Icemonax"} )}) }
        
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"     "none"    "none"    "Gryphon"} 1 4 ({ZONE_GUARDIAN 1 4  x,y=0-99,0-5 }) }
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"     "none"    "Gryphon" "Gryphon"} 7 3 ({ZONE_GUARDIAN 7 3  x,y=0-99,0-5 }) }
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 "none"     "Gryphon" "Gryphon" "Gryphon"} 5 1 ({ZONE_GUARDIAN 5 1  x,y=0-99,0-5 }) }
        
        #############################
        # DELFADOR
        #############################
        {RECALL_XY Delfador 26 20}
        {RECALL_XY $saurian_guide_id 23 19}
        {MODIFY_UNIT id=$saurian_guide_id canrecruit no}
        {GIVE_OBJECT_TO id=$saurian_guide_id ({EFFECT overlay add=misc/leader-expendable.png})}
        {SCROLL_TO 23 19}
    [/event]
    
    
    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        {DELAY 1500}
        {MOVE_UNIT id=Delfador 22 19}
        {DELAY 500}
        
        [message]
            speaker=Delfador
            message=_"Why have you stopped? If you’ve led me all the way out here for nothing you’re going to regret it."
        [/message]
        [message]
            speaker=$saurian_guide_id
            message=_"Oh Great One, the other Great One livesss in thessse cold mountain sssnowsss. But it is dangerousss! We mussst tread causssiousssly, even usss sssauriansss, for much lurksss beneath the ssswampsss."
        [/message]
        [message]
            speaker=$saurian_guide_id
            message=_"You are mighty, oh Great One! Your fire ssshall warm usss in the cold and protect usss from the dangersss!"
        [/message]
        {GENERIC_UNIT 1 "Saurian Skirmisher" 25 20} {ANIMATE} {FACING nw}
        {GENERIC_UNIT 1 "Saurian Skirmisher" 26 20} {ANIMATE} {FACING nw}
        
        {SCROLL_TO 17 1}
        [remove_shroud]
            side,x,y,radius=1,13,2,1
        [/remove_shroud]
        {HIGHLIGHT_IMAGE 13 2 items/gohere.png ()}
        {SCROLL_TO 22 19}
        
        #############################
        # OBJECTIVES
        #############################
        {STORE_UNIT_VAR id=$saurian_guide_id name saurian_guide_name}
        [objectives]
            [objective]
                description= _ "Move $saurian_guide_name to the marked hex"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of $saurian_guide_name"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            [note]
                description= _ "The saurians will not follow you to the next scenario."
            [/note]
            [note]
                description= _ "Amidst the craggy mountains, daylight is scarce. <i>(shorter days / longer nights)</i>"
            [/note]
        [/objectives]
        
        {UNSTORE_SKILLS} # restore the skills we chose in S08
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
    [/event]
    
    #############################
    # MATRIARCHY MESSAGE
    #############################
    [event]
        name=die {FILTER side=3}
        [event]
            name=new turn
            {FILTER_CONDITION( {NOT( {HAVE_UNIT( side=3 {FILTER_VISION side=1} )} )} )}
            [message]
                speaker=Delfador
                message=_"$saurian_guide_name, I still think we should’ve brought some of those Augurs along. Every hero needs a good medic to patch them up after a fight, you know?"
            [/message]
            [message]
                speaker=$saurian_guide_id
                #po: the matriarch assumes both Delfador and the drake are female
                message=_"Oh Great One, you know it isss forbidden! The malesss are not permitted! Only you and I; usss femalesss may look upon the other Great One; your sssister, our massster, our god!"
            [/message]
            [message]
                speaker=Delfador
                message=_"Us females? Err yeah, that’s absolutely correct."
            [/message]
        [/event]
    [/event]
    
    #############################
    # BONES MESSAGE
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=18,6,5} )}
        [remove_shroud]
            side,x,y,radius=1,19,8,3
        [/remove_shroud]
        {SCROLL_TO 19 8}
        [message]
            speaker=Delfador
            scroll=no
            message=_"Whoah, look at all these old bones! Is this death the work of your great dragon?"
        [/message]
        [message]
            speaker=$saurian_guide_id
            #po: there were living drakes here only 10-20 years ago (they died during AA), but saurians have a very short lifespan.
            message=_"No, this valley is cursssed... The eldersss tell usss there were once many great creaturesss in thisss place, but they were ssslain long before I wasss hatched. Now only our Great One remainsss."
        [/message]
        [message]
            speaker=$saurian_guide_id
            message=_"But once you find her, then there ssshall be two! Together the Great Onesss will be unssstoppable!"
        [/message]
        [message]
            speaker=Delfador
            message=_"Yes, that’s absolutely right! I’m definitely coming to help the dragon, not hunt it."
        [/message]
    [/event]
    
    #############################
    # MATRIARCH DIES
    #############################
    [event]
        name=last breath
        {FILTER id=$saurian_guide_id}
        {FILTER_CONDITION( {NOT( {CONTINGENCY_GLOBAL_CONDITIONS} )} )}
        [message]
            speaker=$saurian_guide_id
            message=_"Oh Great One! Sssave me!"
        [/message]
        {KILL id=$saurian_guide_id ANIMATE=yes}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=saved_by_contingency
        first_time_only=no
        {FILTER_CONDITION( {HAVE_UNIT race=lizard} )}
        [event]
            name=new turn
            delayed_variable_substitution=no
            {RECALL $unit.id}
            {MODIFY_UNIT id=$unit.id status.slowed yes}
            [fire_event]
                name=explain_lizard_contingency
                [primary_unit]
                    id=$unit.id
                [/primary_unit]
            [/fire_event]
        [/event]
    [/event]
    [event]
        name=explain_lizard_contingency
        [message]
            speaker=$unit.id
            message=_"I am injured but you have sssaved me! I mussst not rest, I ssshall ssserve you well, oh Great One!"
        [/message]
    [/event]
    
    #############################
    # TIME OVER
    #############################
    [event]
        name=turn 11
        {FILTER_CONDITION( {HAVE_UNIT race=lizard} )}
        [message]
            speaker=$saurian_guide_id
            message=_"The sssnow, the windsss, it chillsss usss... Oh Great One, even with your warmth, we cannot ssstay here long!"
        [/message]
    [/event]
    [event]
        name=turn 14
        {FILTER_CONDITION( {HAVE_UNIT race=lizard} )}
        [message]
            speaker=$saurian_guide_id
            message=_"The cold chillsss me ssso! I cannot sssurvive much longer!"
        [/message]
    [/event]
    [event]
        name=time over
        {FILTER_CONDITION( {HAVE_UNIT race=lizard} )}
        [message]
            speaker=$saurian_guide_id
            message=_"Ssso... cccold... Oh Great One, we have failed you..."
        [/message]
        {KILL race=lizard ANIMATE=yes}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
    #############################
    # PART 1 VICTORY
    #############################
    [event]
        name=moveto
        {FILTER id,x,y=$saurian_guide_id,13,2}
        
        {MOVE_UNIT id=Delfador 12 2}
        {MODIFY_UNIT id=Delfador,$saurian_guide_id facing nw}
        {FIRE_EVENT skill_polymorph_stoat_cancel}
        {FIRE_EVENT skill_polymorph_bear_cancel}
        {FIRE_EVENT skill_polymorph_crab_cancel}
        {FIRE_EVENT skill_polymorph_roc_cancel}
        {KILL side=3}
        
        [message]
            speaker=Delfador
            message=_"Well?"
        [/message]
        [message]
            speaker=$saurian_guide_id
            message=_"Yesss, oh Great One, thisss is the place! Thisss is the lair of the other Great One, your sssister, our massster, our god!"
        [/message]
        
        #############################
        # CLEAN UP OLD MAP
        #############################
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        {SCREEN_FADER 0,0,0 255 500}
        {REMOVE_IMAGE 0-99 0-99}
        {KILL( race=lizard {NOT id=$saurian_guide_id} )}
        [remove_event]
            id=gold_pickup
        [/remove_event]
        {STORE_SKILLS}
        {VARIABLE skill_fireball3 yes}
        {FIRE_EVENT refresh_delfador_skills} # get rid of Delfador's familiar, if it exists
        [store_time_of_day]
            variable=s09_tod
        [/store_time_of_day]
        
        #############################
        # PREPARE NEW MAP
        #############################
        [replace_map]
            map_file=09b_Omaranth.map
            expand,shrink=yes,yes
        [/replace_map]
        [modify_side]
            side,shroud=1,no
        [/modify_side]
        [modify_turns]
            value,current=15,1
        [/modify_turns]
        {SCROLL_TO 27 18}
        
        #############################
        # CHANGE TIME
        #############################
        # to make the transition from S05 more seamless, start at the same time
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals dawn        } {THEN( {VARIABLE current_time 0} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals morning     } {THEN( {VARIABLE current_time 1} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals midday      } {THEN( {VARIABLE current_time 1} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals afternoon   } {THEN( {VARIABLE current_time 1} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals dusk        } {THEN( {VARIABLE current_time 2} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals first_watch } {THEN( {VARIABLE current_time 3} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals midnight    } {THEN( {VARIABLE current_time 4} )} [/if]
        [if] {VARIABLE_CONDITIONAL s09_tod.id equals second_watch} {THEN( {VARIABLE current_time 5} )} [/if]
        [replace_schedule]
            {WINTER_SCHEDULE}
            current_time=$current_time
        [/replace_schedule]
        
        {FIRE_EVENT play_survival}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                      PART 2
    #######################################################################################################################################################
    [event]
        name=play_survival
        #############################
        # KEEPS
        #############################
        {PLACE_IMAGE scenery/dwarven-keep-tile.png 14  9}
        {PLACE_IMAGE scenery/dwarven-keep-tile.png 18 15}
        {PLACE_IMAGE scenery/dwarven-keep-tile.png  5 20}
        {PLACE_IMAGE scenery/dwarven-keep-tile.png 26  8}
        
        
        #############################
        # CAVES
        #############################
        {PLACE_IMAGE scenery/cave-entrance1.png 16  6}
        
        {PLACE_IMAGE scenery/cave-entrance2.png  9  6}
        {PLACE_IMAGE scenery/cave-entrance3.png  4  8}
        {PLACE_IMAGE scenery/cave-entrance4.png  3 15}

        {PLACE_IMAGE scenery/cave-entrance3.png 11 17}
        {PLACE_IMAGE scenery/cave-entrance4.png  8 19}
        {PLACE_IMAGE scenery/cave-entrance2.png 14 19}

        {PLACE_IMAGE scenery/cave-entrance2.png 31 17}
        {PLACE_IMAGE scenery/cave-entrance4.png 30 13}

        {PLACE_IMAGE scenery/cave-entrance2.png 24  2}
        {PLACE_IMAGE scenery/cave-entrance4.png 29  4}
        {PLACE_IMAGE scenery/cave-entrance2.png 31  7}
        
        
        #############################
        # MATRIARCH FLEES
        #############################
        {TELEPORT_UNIT id=Delfador          26 18}
        {TELEPORT_UNIT id=$saurian_guide_id 27 18}
        {MODIFY_UNIT id=Delfador,$saurian_guide_id facing nw}
        
        {FADE_MUSIC_OUT 1000}
        {SCREEN_FADER 0,0,0 000 500}
        [change_theme]
        [/change_theme]
        {DELAY 100}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        {DELAY 100}
        {FADE_MUSIC_IN 100}
        {DELAY 1000}
        
        [message]
            speaker=$saurian_guide_id
            message=_"Sssimply continue down the valley, and you ssshall meet your sssissster! I dare go no further. Oh massstersss, please forgive usss..."
        [/message]
        {MOVE_UNIT id=$saurian_guide_id 27 19}
        {MODIFY_UNIT id=Delfador facing se}
        {MOVE_UNIT id=$saurian_guide_id 30 20}
        {KILL id=$saurian_guide_id}
        {DELAY 500}
        
        
        #############################
        # DELFADOR BECOMES AFRAID
        #############################
        {MODIFY_UNIT id=Delfador facing nw}
        [message]
            speaker=Delfador
            message=_"Hmmph, what’s she so afraid of; it’s just one measly dragon. I’ll burn it to cinders and call myself Delfador Dragonsbane! The poets will sing my praises through the streets of Weldyn!"
        [/message]
        
        {DELAY 250}{MOVE_UNIT id=Delfador 23 15}{DELAY 250}
        [message]
            speaker=Delfador
            message=_"After all, the heroes of old used to slay dragons all the time, right?"
        [/message]
        
        {DELAY 500}{MOVE_UNIT id=Delfador 21 13}{DELAY 500}
        [message]
            speaker=Delfador
            message=_"Well, now that I think of it, I only remember reading about one single slain dragon..."
        [/message]
        
        {DELAY 750}{MOVE_UNIT id=Delfador 21 12}{DELAY 750}
        [message]
            speaker=Delfador
            message=_"And Prince Haldric did have a whole company of the Green Isle’s best knights to help..."
        [/message]
        
        {DELAY 2000}
        [message]
            speaker=Delfador
            message=_"Uh oh."
        [/message]
        {DELAY 100}
        {MOVE_UNIT id=Delfador 23 15}
        
        
        #############################
        # DRAKE APPEARS
        #############################
        {SOUND drake-hit-2.ogg}
        {MODIFY_UNIT id=Delfador facing nw}
        {NAMED_NOTRAIT_UNIT  2 (Armageddon Drake) 18 9 Omaranth _"Omaranth"} {ANIMATE} {FACING se}
        [modify_unit]
            {FILTER id=Omaranth}
            canrecruit=yes
            {TRAIT_FEARLESS} {TRAIT_STRONG} # fearless is important, since the ToD he reappears in part 2 depends on when Delfador finishes part 1. Fearless reduces the ToD variation.
            [object]
                {EFFECT hitpoints (increase_total,heal_full=65,yes)} # total 163 hp (164 bc strong)
                {EFFECT movement set=4} # slow movement, so Delfador can run away if he needs to
                {EFFECT status add=unpoisonable} # since he's really an undead unit
                {EFFECT status add=undrainable}  # since he's really an undead unit
                
                # change animations so he's permanently flying (animation looks cool, and not distracting when there's only 1 drake)
                {EFFECT new_animation ([standing_anim]
                    base_score=99
                    {FRAME image="units/drakes/armageddon-fly-[1~5,4].png:100"}
                    {FRAME image="units/drakes/armageddon-fly-[3,2]-upstroke.png:100"}
                [/standing_anim])}
            [/object]
        [/modify_unit]
        {DELAY 250}
        
        [message]
            speaker=Omaranth
            message=_"SOMETHING STIRRS.
A HUMAN COMES."
        [/message]
        {DELAY 250}{QUAKE drake-die.ogg}{DELAY 750}
        [message]
            speaker=Omaranth
            message=_"IT IS FEEBLE.
IT IS WEAK.
IT WILL DIE."
        [/message]
        
        
        [message]
            speaker=Delfador
            message=_"...wait a minute, that’s not a dragon, it’s just a drake! The saurians must have mistaken it for a true dragon on account of it’s fire breath."
        [/message]
        [message]
            speaker=Delfador
            message=_"Delfador Drake-Slayer isn’t quite so catchy as Dragonsbane, but I’ll take what fame I can get. Your head is mine!"
        [/message]
        {MOVE_UNIT id=Delfador 19 10}
        
        {MOVE_UNIT id=Omaranth 16 6}
        [store_unit]
            {FILTER id=Omaranth}
            kill,variable=yes,stored_omaranth
        [/store_unit]
        
        {MOVE_UNIT id=Delfador 18 9}
        [message]
            speaker=Delfador
            message=_"Hey, get back here!"
        [/message]
        {MODIFY_UNIT id=Delfador facing se}
        {DELAY 500}
        [message]
            speaker=Delfador
            message=_"The rest of you, guard this cave entrance while I chase the drake inside. When next you see me, I’ll be holding the beast’s scalp!"
        [/message]
        
        
        #############################
        # RECALL INITIAL UNITS
        #############################
        {RECALL_COMPANION 20 10}
        {MODIFY_UNIT x,y=20,10 canrecruit yes}
        [set_extra_recruit]
            x,y=20,10
            extra_recruit={DELFADOR_BANDIT_RECRUIT}
        [/set_extra_recruit]
        [if] {VARIABLE_CONDITIONAL poachers_were_recruited equals yes} {THEN([allow_extra_recruit]
            x,y,extra_recruit=20,10,Poacher
        [/allow_extra_recruit])} [/if]
        {RECALL_BANDIT 0 20 11 "Thief"   ({ADD_MODIFICATION {TRAIT_STRONG}} {ADD_MODIFICATION {TRAIT_QUICK}}     {ANIMATE})}  {MODIFY_UNIT x,y=20,11 role speaker1}
        {RECALL_BANDIT 0 22 10 "Footpad" ({ADD_MODIFICATION {TRAIT_STRONG}} {ADD_MODIFICATION {TRAIT_RESILIENT}} {ANIMATE})}  {MODIFY_UNIT x,y=22,10 role speaker2}
        
        [message]
            speaker=$companion_id
            message=_"You got it, boss. We’ll watch th’ cave entrance, an’ make sure you don’ get trapped inside."
        [/message]
        
        {MOVE_UNIT id=Delfador 16 6}
        [store_unit]
            {FILTER id=Delfador}
            kill,variable=yes,stored_delfador
        [/store_unit]
        
        {DELAY 500}
        [message]
            speaker=$companion_id
            message=_"Sounds like a pretty easy job. All we gots to do is wait ’round ’ere for the boss to come back out."
        [/message]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Relax. What could go wrong?"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            [note]
                description= _ "Amidst the craggy mountains, daylight is scarce. <i>(shorter days / longer nights)</i>"
            [/note]
        [/objectives]
        
        
        #############################
        # CREATE CAVES
        #############################
#define INITIALIZE_CAVE ID X Y
        {NAMED_UNIT 2 (Cave Entrance) {X} {Y} {ID} "" ([object]
            {EFFECT status add=unhealable}
        [/object])}
        
        #------------------------
        # STORE CAVE WHEN TRIGGERED
        #------------------------
        [event]
            name,first_time_only=store_cave,no {FILTER id={ID}}
            [store_unit]
                {FILTER id={ID}}
                kill,variable=yes,{ID}
            [/store_unit]
            #------------------------
            # UNSTORE CAVE WHEN CLEAR
            #------------------------
            [event]
                name=exit hex  {FILTER x,y={X},{Y}}
                {FILTER_CONDITION( {VARIABLE_CONDITIONAL {ID} length greater_than=0} )}
                [event]
                    name=enter hex # wait until after the unit finishes exiting, or we overwrite it
                    {FILTER_CONDITION( {VARIABLE_CONDITIONAL {ID} length greater_than=0} )}
                    [unstore_unit]
                        variable={ID}
                    [/unstore_unit]
                    {CLEAR_VARIABLE {ID}}
                [/event]
            [/event]
            [event]
                name=die  {FILTER( x,y={X},{Y} {NOT(type=Cave Entrance)} )}
                {FILTER_CONDITION( {VARIABLE_CONDITIONAL {ID} length greater_than=0} )}
                [unstore_unit]
                    variable={ID}
                [/unstore_unit]
                {CLEAR_VARIABLE {ID}}
            [/event]
        [/event]
        
        #------------------------
        # COLLAPSE WHEN DESTROYED
        #------------------------
        [event]
            name=die {FILTER id={ID}}
            {QUAKE cave-in.ogg}
            {QUAKE cave-in.ogg}
            {REMOVE_IMAGE {X} {Y}}
            {PLACE_IMAGE terrain/misc/rubble-water.png {X} {Y}}
            {PLACE_IMAGE terrain/misc/detritus/detritusA-5.png {X} {Y}}
        [/event]
        
        #------------------------
        # CAVE DEFENDERS
        #------------------------
        [event]
            name=pre attack  {FILTER_SECOND id,side={ID},2}
            
            # spawn defenders in a fixed sequence, instead of random. Luckily/unluckily multiple empty caves (or multiple full caves) in a row can make a big difference, so prevent that
            [set_variables]
                name=defenders
                [value]
                    type={ON_DIFFICULTY4 "none"            "none"            "none"            "Walking Corpse"}
                [/value]
                [value]
                    type={ON_DIFFICULTY4 "Walking Corpse"  "Walking Corpse"  "Walking Corpse"  "Walking Corpse"}
                [/value]
                [value]
                    type={ON_DIFFICULTY4 "Walking Corpse"  "Soulless"        "Soulless"        "Soulless"      }
                [/value]
                [value]
                    type={ON_DIFFICULTY4 "none"            "none"            "none"            "none"          }
                [/value]
                [value]
                    type={ON_DIFFICULTY4 "none"            "Walking Corpse"  "Walking Corpse"  "Soulless"      }
                [/value]
            [/set_variables]
            [if] {VARIABLE_CONDITIONAL next_defender equals $empty} {THEN( 
                {VARIABLE next_defender 0}
            )} {ELSE(
                {VARIABLE_OP next_defender add 1}
                {VARIABLE_OP next_defender modulo $defenders.length}
            )} [/if]
            
            [if] {VARIABLE_CONDITIONAL defenders[$next_defender].type not_equals none} {THEN(
                [fire_event]
                    name=store_cave
                    [primary_unit]
                        x,y,type={X},{Y},"Cave Entrance"
                    [/primary_unit]
                [/fire_event]
                {GENERIC_UNIT 2 $defenders[$next_defender].type {X} {Y}}  {ANIMATE} {VARIATION drake}
                {FIRE_EVENT explain_cave_defenders}
            )} [/if]
            {CLEAR_VARIABLE defenders}
        [/event]
#enddef
        #------------------------
        # CREATE CAVES
        #------------------------
        {INITIALIZE_CAVE cave00 16 6}
        {MODIFY_UNIT id=cave00 side 1}
        {GIVE_OBJECT_TO x,y=16,6 ({EFFECT hitpoints (increase_total,heal_full={ON_DIFFICULTY4 75 50 25 0},yes)} )}
        
        {INITIALIZE_CAVE cave01  9  6}
        {INITIALIZE_CAVE cave02  4  8}
        {INITIALIZE_CAVE cave03  3 15}
        
        {INITIALIZE_CAVE cave04 11 17}
        {INITIALIZE_CAVE cave05  8 19}
        {INITIALIZE_CAVE cave06 14 19}
        
        {INITIALIZE_CAVE cave07 31 17}
        {INITIALIZE_CAVE cave08 30 13}
        
        {INITIALIZE_CAVE cave09 24  2}
        {INITIALIZE_CAVE cave10 29  4}
        {INITIALIZE_CAVE cave11 31  7}
        [event]
            name=explain_cave_defenders
            {GET_COMPANION_ID}
            [message]
                speaker=$companion_id
                message=_"Look out! One o’ them was lurkin’ just inside the cave entrance!"
            [/message]
        [/event]
        [event]
            name=die {FILTER side,type=2,"Cave Entrance"}
            {GET_COMPANION_ID}
            [message]
                speaker=$companion_id
                message=_"Whew, that cave ’aint open no more! We won’t be fightin’ any more dead from down there."
            [/message]
        [/event]
        [event]
            name=die
            {FILTER side=2}
            {FILTER_CONDITION( {NOT({HAVE_UNIT( side=2 )})} )}
            {FILTER_CONDITION( {NOT({HAVE_UNIT( id=Delfador )})} )}
            {GET_COMPANION_ID}
            [message]
                speaker=$companion_id
                message=_"That’s the last one ’o them, and with all the caves collapsed there won’t be no more! Nothin’ left to do but wait for Delfador to come back out, and relax... for real this time."
            [/message]
            {ACHIEVE s09}
        [/event]
        
        
        #############################
        # SPAWN UNITS FROM CAVES
        #############################
        # store each initial cave location
        [store_locations]
            {FILTER side,type=2,"Cave Entrance"}
            variable=cave_locations
        [/store_locations]
        
        #------------------------
        # DEFINE EMERGE MACROS
        #------------------------
#define EMERGE TURN UNITS
        [event]
            name=side 2 turn {TURN}
            {VARIABLES_SPLIT emerging_units type (,) {UNITS}}
            [foreach]
                array=emerging_units
                [do]
                    [random_placement]
                        variable,num_items,allow_less=loc,1,yes
                        {FILTER_LOCATION( find_in=cave_locations {NOT({FILTER( {NOT(type=Cave Entrance)} )})} )} # pick a random cave_location, that doesn't already have a non-cave unit on it
                        [command]
                            # if there's not a cave at this location, skip spawning
                            # don't FILTER_LOCATION for caves, or else the spawn rate isn't reduced when caves get destroyed
                            [if] {NOT({HAVE_UNIT x,y,type=$loc.x,$loc.y,"Cave Entrance"})} {THEN([continue][/continue])} [/if]
                            [if] {VARIABLE_CONDITIONAL this_item.type equals none} {THEN([continue][/continue])} [/if]
                            
                            # otherwise, store the cave and spawn the unit
                            [fire_event]
                                name=store_cave
                                [primary_unit]
                                    x,y,type=$loc.x,$loc.y,"Cave Entrance"
                                [/primary_unit]
                            [/fire_event]
                            {GENERIC_UNIT 2 $this_item.type $loc.x $loc.y} {ANIMATE} {VARIATION drake}
                            
                            # prevent new zombies/ghosts from moving very far on the first turn
                            {RANDOM "1..3"}
                            {MODIFY_UNIT x,y=$loc.x,$loc.y moves $random}
                            {CLEAR_VARIABLE moves}
                            
                            # buff soulless/corpses to be more deadly, especially in the snow
                            [if]    {VARIABLE_CONDITIONAL this_item.type equals "Walking Corpse"}
                                {OR({VARIABLE_CONDITIONAL this_item.type equals "Soulless"})}
                            {THEN([object]
                                {FILTER x,y,type=$loc.x,$loc.y,$this_item.type}
                                {EFFECT hitpoints increase_total,heal_full=30%,yes}
                                {EFFECT movement_costs (replace=yes
                                    [movement_costs]
                                        frozen=1
                                    [/movement_costs])}
                                {EFFECT resistance (replace=yes
                                    [resistance]
                                        arcane=120  # weaken the shadow mage a little compared to the poacher (poacher is harder to acquire)
                                    [/resistance])} # also, I've heard that at some point all the corpses will be changed to arcane=120, so this shouldn't introduce any long-term inconsistencies
                            [/object])} [/if]
                        [/command]
                    [/random_placement]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE emerging_units,this_item,cave}
        [/event]
#enddef
#define EMERGE_CORPSE_TINY TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "none"
            "Walking Corpse"
            "Walking Corpse"
            "Walking Corpse"
        } )} #enddef
#define EMERGE_CORPSE_SMALL TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "none"
            "Walking Corpse"
            "Walking Corpse"
            "Soulless"
        } )} #enddef
#define EMERGE_CORPSE_MEDIUM TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "Walking Corpse"
            "Walking Corpse, Walking Corpse"
            "Walking Corpse, Walking Corpse"
            "Soulless,       Walking Corpse"
        } )} #enddef
#define EMERGE_CORPSE_LARGE TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "Walking Corpse, Walking Corpse"
            "Soulless,       Walking Corpse, Walking Corpse, Walking Corpse"
            "Soulless,       Walking Corpse, Walking Corpse, Walking Corpse"
            "Soulless,       Soulless,       Walking Corpse, Walking Corpse, Walking Corpse"
        } )} #enddef
#define EMERGE_CORPSE_HUGE TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "Soulless,       Walking Corpse"
            "Soulless,       Soulless,       Soulless,       Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse"
            "Soulless,       Soulless,       Soulless,       Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse"
            "Soulless,       Soulless,       Soulless,       Soulless,       Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse, Walking Corpse"
        } )} #enddef
#define EMERGE_MIXED_MEDIUM TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "none"
            "Ghost,          Walking Corpse"
            "Ghost,          Walking Corpse"
            "Ghost,          Walking Corpse, Walking Corpse"
        } )} #enddef
#define EMERGE_MIXED_LARGE TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "none"
            "Ghost,          Walking Corpse, Walking Corpse"
            "Ghost,          Walking Corpse, Walking Corpse"
            "Ghost,          Ghost,          Walking Corpse, Walking Corpse"
        } )} #enddef
#define EMERGE_MIXED_HUGE TURN
        {EMERGE {TURN} ({ON_DIFFICULTY4
            "Ghost"
            "Ghost,          Ghost,          Soulless,       Walking Corpse"
            "Ghost,          Ghost,          Soulless,       Walking Corpse"
            "Ghost,          Ghost,          Soulless,       Soulless,       Walking Corpse, Walking Corpse, Walking Corpse"
        } )}
#enddef
        #------------------------
        # SPAWN UNITS EACH TURN
        #------------------------
        {EMERGE_CORPSE_MEDIUM  1} # initial emerge must have at least 1 corpse even on Easy, or else the messages don't make sense
        {EMERGE_CORPSE_TINY    2}
        {EMERGE_CORPSE_TINY    3}
        {EMERGE_CORPSE_TINY    4}
        {EMERGE_CORPSE_SMALL   5}
        {EMERGE_CORPSE_SMALL   6}
        {EMERGE_MIXED_MEDIUM   7}
        {EMERGE_MIXED_MEDIUM   8}
        {EMERGE_CORPSE_MEDIUM  9} # remember that the player is expected to be collapsing caves, which prevents their spawns. Killing 50% of caves means only 50% of enemies spawn
        {EMERGE_MIXED_MEDIUM  10}
        {EMERGE_CORPSE_LARGE  11}
        {EMERGE_CORPSE_HUGE   12}
        {EMERGE_MIXED_LARGE   13}
        {EMERGE_MIXED_HUGE    14}
        {EMERGE_CORPSE_HUGE   15}
        {EMERGE_CORPSE_LARGE  11}
        {EMERGE_MIXED_HUGE    14}
        {EMERGE_CORPSE_HUGE   15} # this is when Delfador re-emerges, and Omaranth reappears so you can kill him and win the scenario
        {EMERGE_CORPSE_HUGE   16}
        {EMERGE_MIXED_HUGE    17}
        {EMERGE_MIXED_HUGE    18}
        {EMERGE_CORPSE_HUGE   19}
        {EMERGE_MIXED_HUGE    20}
        {EMERGE_MIXED_HUGE    21}
        {EMERGE_MIXED_HUGE    22}
        {EMERGE_CORPSE_HUGE   23}
        {EMERGE_CORPSE_HUGE   24}
        {EMERGE_MIXED_HUGE    25}
        {EMERGE_MIXED_HUGE    26}
        {EMERGE_MIXED_HUGE    27}
        {EMERGE_CORPSE_HUGE   28}
        {EMERGE_MIXED_HUGE    29}
        {EMERGE_CORPSE_HUGE   30}
        {EMERGE_CORPSE_HUGE   31}
        {EMERGE_CORPSE_HUGE   32}
        {EMERGE_MIXED_HUGE    33}
        {EMERGE_CORPSE_HUGE   34}
        {EMERGE_MIXED_HUGE    35}
        
        #######################################################################################################################################################
        #                                                                   PART 2 EVENTS
        #######################################################################################################################################################
        #############################
        # INITIAL UNDEAD CUTSCENE
        #############################
        [event]
            name=side 1 turn end
            
            #############################
            # PLACE FOG
            #############################
            {DELAY 1000}
            {SOUND wind.ogg}
            {DELAY 2000}
            [modify_side]
                side,fog=1,yes
            [/modify_side]
            [redraw]
                clear_shroud=yes
            [/redraw]
            [message]
                role=speaker1
                message=_"Brrr... It’s suddenly so c-c-cold..."
            [/message]
            
            #############################
            # PLACE SHROUD
            #############################
            {SOUND wail-long.wav} {DELAY 2000}
#define CONTRACT_SHROUD EXTRA_VISION
            # specify x,y so we don't give this to units on the recall list (since REMOVE_OBJECT's SUF doesn't catch these for some reason)
            {GIVE_OBJECT_TO (side,x,y=1,0-99,0-99) (id=bonus_vision {EFFECT vision increase={EXTRA_VISION}})}
            [modify_side]
                side,shroud=1,yes
            [/modify_side]
            [place_shroud]
                side=1
                x,y=0-99,0-99 # cover all tiles with shroud, including ones we've seen earlier
            [/place_shroud]
            [redraw]
                clear_shroud=yes
            [/redraw]
            {REMOVE_OBJECT bonus_vision ()}
            [reset_fog] # fog was already close; don't let it expand again
                side,reset_view=1,yes
            [/reset_fog]
            [redraw]
                clear_shroud=yes
            [/redraw]
            {SOUND magic-dark-big-miss.ogg} {DELAY 750}
#enddef
            {CONTRACT_SHROUD 20}
            {CONTRACT_SHROUD 10}
            {CONTRACT_SHROUD 5}
            {CONTRACT_SHROUD 0}
            [message]
                id=$companion_id
                message=_"Uhh, hello? Who’s there? Boss, is that you?"
            [/message]
            
            #############################
            # ZOMBIES APPEAR
            #############################
#define SHOW_ZOMBIE_EMERGING X Y SND X2 Y2
            {SCROLL_TO X Y}
            {DELAY 250}
            [lift_fog]
                side,x,y,radius=1,{X},{Y},1
            [/lift_fog]
            [remove_shroud]
                side,x,y,radius=1,{X},{Y},1
            [/remove_shroud]
            {DELAY 250}
            [store_unit]
                {FILTER x,y={X},{Y}}
                variable,kill=stored_cutscene_cave,yes
            [/store_unit]
            {SOUND {SND}}
            {GENERIC_UNIT 2 "Walking Corpse" {X} {Y}} {ANIMATE} {VARIATION drake}
            {DELAY 250}
            {MOVE_UNIT x,y={X},{Y} {X2} {Y2}}
#             {KILL x,y={X2},{Y2}}
            [place_shroud]
                side,x,y,radius=1,{X},{Y},1
            [/place_shroud]
            [unstore_unit]
                variable=stored_cutscene_cave
            [/unstore_unit]
            {CLEAR_VARIABLE stored_cutscene_cave}
            {DELAY 500}
#enddef
            {SHOW_ZOMBIE_EMERGING  3 15 zombie-hit-3.ogg  6 15}
            {SHOW_ZOMBIE_EMERGING 31 17 zombie-hit-4.ogg 28 17}
            {SHOW_ZOMBIE_EMERGING 24  2 zombie-hit-6.ogg 22  4}
            
            #############################
            # ZOMBIE ATTACKS
            #############################
            {GENERIC_UNIT 2 Soulless 30 20} {VARIATION drake}
            
            {STORE_UNIT_VAR role=speaker1 x victimX}
            {STORE_UNIT_VAR role=speaker1 y victimY}
            {MOVE_UNIT type=Soulless $victimX $victimY}
            {ANIMATE_ATTACK type=Soulless () no x,y=$victimX,$victimY}
            {CLEAR_VARIABLE victimX,victimY}
            [message]
                role=speaker1
                message=_"Aaaah!"
            [/message]
            {STORE_UNIT_VAR type=Soulless x victimX}
            {STORE_UNIT_VAR type=Soulless y victimY}
            {ANIMATE_ATTACK role=speaker1 () yes x,y=$victimX,$victimY}
            {KILL type=Soulless ANIMATE=yes}
            {CLEAR_VARIABLE victimX,victimY}
            
            #############################
            # DISCUSS OPTIONS
            #############################
            [message]
                role=speaker1
                message=_"Aww heck no, no no no! I didn’t sign up for fightin’ no zombies! C’mon, let’s get out o’ here before more show up!"
            [/message]
            [message]
                role=speaker2
                image_pos=right
                message=_"We can’t leave! Delfador is still inside the cave! If we run now the dead’ll knock it down for sure, and then he’ll be trapped inside forever!"
            [/message]
            [message]
                speaker=$companion_id
                message=_"Curse it all, you’re right! Fine then, c’mon everyone, grab your weapons an’ get ready. My gut says we’re about to have the fight o’ our lives!"
            [/message]
            
            # do this after the cutscene, or else we might see a zombie do something by accident
            [remove_shroud]
                side=1
                x,y,radius=17,6-7,2 # main cave
                {OR( x,y,radius=18,9,1 )}
                {OR( x,y,radius=20,10-11,1 )}
                {OR( x,y,radius=22,10,1 )}
                {OR( x,y,radius=22,14,1 )}
                {OR( x,y,radius=26,17,1 )}
                {OR( x,y,radius=30,20,1 )}
            [/remove_shroud]
            
            {REPLACE_SCENARIO_MUSIC the_city_falls.ogg}
            {APPEND_MUSIC siege_of_laurelmor.ogg}
            
            
            #############################
            # OBJECTIVES
            #############################
            [objectives]
                [objective]
                    description= _ "Protect Delfador’s cave entrance until turns run out"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Delfador’s cave entrance is destroyed" # you can still win even if your leader dies
                    condition=lose
                [/objective]
                [gold_carryover]
                    carryover_percentage,bonus=40,no
                [/gold_carryover]
                [note]
                    description= _ "Amidst the craggy mountains, daylight is scarce. <i>(shorter days / longer nights)</i>"
                [/note]
            [/objectives]
        [/event]
        
        #############################
        # CAVE EXPLANATION
        #############################
        [event]
            name=sighted
            {FILTER side,type=2,"Cave Entrance"}
            {FILTER_SECOND side=1}
            
            [message]
                speaker=$second_unit
                message=_"Look, a frozen cave, jus’ like the one Delfador went down! I’ll bet these’re where all the undead are climin’ out of. Quick now, if we knock down the entrance we can trap ’em inside!"
            [/message]
            
            [objectives]
                [objective]
                    description= _ "Protect Delfador’s cave entrance until turns run out"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Delfador’s cave entrance is destroyed" # you can still win even if your leader dies
                    condition=lose
                [/objective]
                [gold_carryover]
                    carryover_percentage,bonus=40,no
                [/gold_carryover]
                [note]
                    description= _ "Destroy hostile cave entrances to trap enemies inside."
                [/note]
                [note]
                    description= _ "Amidst the craggy mountains, daylight is scarce. <i>(shorter days / longer nights)</i>"
                [/note]
            [/objectives]
        [/event]
        
        #############################
        # FIRST PLAGUE
        #############################
        [event]
            name=last breath
            {FILTER( side=1 {NOT({FILTER_LOCATION( terrain=*^V* )})} )} # plague doesn't work on villages
            {FILTER_SECOND( type_adv_tree="Walking Corpse" )}
            {FILTER_CONDITION( {NOT( {HAVE_UNIT id=Delfador} )} )} # don't trigger if Delfador has already returned; it would sound strange
            {GET_COMPANION_ID}
            [message]
                speaker=$companion_id
                message=_"Oh no... you don’ look so good. Don’ die on me now, you hear? You got lots left to live for!"
            [/message]
            {KILL id=$unit.id ANIMATE=yes FIRE_EVENT=yes}
            {GENERIC_UNIT 2 "Walking Corpse" $unit.x $unit.y} {ANIMATE}
            {MODIFY_UNIT x,y=$unit.x,$unit.y moves 0}
            {MODIFY_UNIT x,y=$unit.x,$unit.y attacks_left 0}
            [message]
                x,y=$unit.x,$unit.y
                message=_"RraaaAAARRRGGG!"
            [/message]
        [/event]

        #############################
        # GHOST SPOTTED
        #############################
        [event]
            name=sighted
            {FILTER side,type_adv_tree=2,Ghost}
            {FILTER_SECOND side=1}
            {GET_COMPANION_ID}
            [message]
                speaker=$companion_id
                message=_"Ghost!! This jus’ keeps gettin’ worse! How’re we supposed to fight somethin’ our weapons can’t even touch!?"
            [/message]
        [/event]
        
        #############################
        # DEATH MESSAGES
        #############################
        [event]
            name=die {FILTER side=1}
            [event]
                name=die {FILTER side=1}
                [event]
                    name=die {FILTER side=1}
                    [event]
                        name=die {FILTER side=1}
                        [event]
                            name=new turn
                            {FILTER_CONDITION( {NOT( {HAVE_UNIT id=Delfador} )} )} # don't trigger if Delfador has already returned; it would sound strange
                            {GET_COMPANION_ID}
                            [message]
                                speaker=$companion_id
                                message=_"C’mon, don’t give up! We can pull through this!"
                            [/message]
                            [event] # don't track more deaths until after this message, to ensure we don't play both messages on the same turn
                                name=die {FILTER side=1}
                                [event]
                                    name=die {FILTER side=1}
                                    [event]
                                        name=die {FILTER side=1}
                                        [event]
                                            name=die {FILTER side=1}
                                            [event]
                                                name=new turn
                                                {FILTER_CONDITION( {NOT( {HAVE_UNIT id=Delfador} )} )} # don't trigger if Delfador has already returned; it would sound strange
                                                {GET_COMPANION_ID}
                                                [message]
                                                    speaker=$companion_id
                                                    message=_"...boss? Hey, boss, you comin’ out o’ that cave anytime soon? We could really use your help out here..."
                                                [/message]
                                            [/event]
                                        [/event]
                                    [/event]
                                [/event]
                            [/event]
                        [/event]
                    [/event]
                [/event]
            [/event]
        [/event]
        
        #############################
        # TRACK DEATHS
        #############################
        [event]
            name=start
            {VARIABLE s09_deaths 0}
        [/event]
        [event]
            name=die {FILTER side=1}
            first_time_only=no
            {VARIABLE_OP s09_deaths add 1}
        [/event]
        
        
        
        
        
        #######################################################################################################################################################
        #                                                                      PART 3
        #######################################################################################################################################################
        [event]
            name=time over
            {FILTER_CONDITION( {NOT({HAVE_UNIT id=Omaranth)})} )}
            
            {GET_COMPANION_ID}
            [message]
                speaker=$companion_id
                message=_"Do you hear tha’? Thank the gods, I think th’ boss’s finally back!"
            [/message]
            {FADE_MUSIC_OUT 1500}
            {DELAY 100}
            {REPLACE_SCENARIO_MUSIC silence.ogg}
            {DELAY 100}
            {FADE_MUSIC_IN 100}
            
            
            #############################
            # DELFADOR FLEES FROM OMARANTH
            #############################
#define FORCE_MOVE FLT X Y
        [store_unit]
            {FILTER x,y={X},{Y}} kill,variable=yes,force_move_stored_unit
        [/store_unit]
        {MOVE_UNIT {FLT} {X} {Y}}
        [if] {VARIABLE_CONDITIONAL force_move_stored_unit.length greater_than 0} {THEN(
            [unstore_unit]
                variable,find_vacant=force_move_stored_unit,yes
            [/unstore_unit]
            {CLEAR_VARIABLE force_move_stored_unit}
        )} [/if]
#enddef
            # Delfador appears
            {KILL id=cave00}
            {VARIABLE stored_delfador.hitpoints 40}
            {VARIABLE_OP stored_delfador.experience add 12} # 1) so you have a fighting chance if you began the scenario with low XP, and 2) to reflect XP gained from fighting Omaranth in the crypt
            [unstore_unit]
                variable=stored_delfador
                x,y,animate=16,6,yes
            [/unstore_unit]
            {CLEAR_VARIABLE stored_delfador}
            {MODIFY_UNIT id=Delfador resting no}
            [redraw]
                clear_shroud=yes
            [/redraw]
            [message]
                speaker=Delfador
                message=_"(panting) Infernal beast, why won’t you leave me be! I already said I’m sorry! It was all a big misunderstanding!"
            [/message]
            {FORCE_MOVE id=Delfador 18 8}
            [redraw]
                clear_shroud=yes
            [/redraw]
            
            # Omaranth appears
            {VARIABLE stored_omaranth.hitpoints 143} # out of 168
            [unstore_unit]
                variable=stored_omaranth
                x,y,animate=16,6,yes
            [/unstore_unit]
            [object]
                {FILTER id=Omaranth} # nerf omaranth's damage on lower difficulties
                {EFFECT attack increase_damage={ON_DIFFICULTY4 -8 -4 -4 -0}} # both melee and ranged
            [/object]
            {FORCE_MOVE id=Omaranth 17 8}
            
            
            #############################
            # BATTLE CUTSCENE
            #############################
            # Omaranth breathes fire on Delfador
            [harm_unit]
                {FILTER id=Delfador} {FILTER_SECOND id=Omaranth}
                amount,animate=4,yes
                [primary_attack]
                    range=ranged
                [/primary_attack]
                [secondary_attack]
                    range=ranged
                [/secondary_attack]
            [/harm_unit]
            {FORCE_MOVE id=Delfador 20 10}
            [redraw]
                clear_shroud=yes
            [/redraw]
            {FORCE_MOVE id=Omaranth 19 10}
            [harm_unit]
                {FILTER id=Delfador} {FILTER_SECOND id=Omaranth}
                amount,animate=4,yes
                [primary_attack]
                    range=ranged
                [/primary_attack]
                [secondary_attack]
                    range=ranged
                [/secondary_attack]
            [/harm_unit]
            
            # Delfador enervates Omaranth
            [message]
                speaker=Delfador
                message=_"You think you’re so powerful, don’t you? We’ll see who’s laughing when I take your life for myself!"
            [/message]
            {STORE_SKILLS}
            {VARIABLE skill_enervate yes}
            {FIRE_EVENT refresh_delfador_skills}
            [harm_unit]
                {FILTER id=Omaranth} {FILTER_SECOND id=Delfador}
                amount,animate=0,yes
                [primary_attack]
                    range=ranged
                [/primary_attack]
                [secondary_attack]
                    range=ranged
                [/secondary_attack]
            [/harm_unit]
            [message]
                speaker=Delfador
                message=_"What the— no healing?! Impossible! What are you?!"
            [/message]
            
            # bandits come to help
            {DELAY 500}
            [message]
                speaker=$companion_id
                message=_"Looks like th’ boss’s bit off a little more’n he could chew! Quick, we’d better save ’im from tha’ Drake!"
            [/message]
            
            [modify_turns]
                value=20
            [/modify_turns]
            {REPLACE_SCENARIO_MUSIC helios.ogg}
            
            
            #############################
            # OBJECTIVES
            #############################
            [objectives]
                [objective]
                    description= _ "Kill Omaranth"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Delfador"
                    condition=lose
                [/objective]
                [gold_carryover]
                    carryover_percentage,bonus=40,no
                [/gold_carryover]
            [/objectives]
            
            {UNSTORE_SKILLS}
            {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
        [/event]
        [event]
            name=side 1 turn end
            {FILTER_CONDITION( {HAVE_UNIT( side,count=2,3-10 {NOT type="Cave Entrance"} )} )}
            [message]
                speaker=Delfador
                message=_"Where did all these undead come from?!"
            [/message]
        [/event]
        
        
        
        
        
        #######################################################################################################################################################
        #                                                                  VICTORY / DEFEAT
        #######################################################################################################################################################
        #############################
        # OMARANTH DIES
        #############################
        [event]
            name=last breath
            {FILTER id=Omaranth}
            
            {FADE_MUSIC_OUT 1500}
            {REPLACE_SCENARIO_MUSIC heroes_rite.ogg}
            {FADE_MUSIC_IN 100}
            {SOUND lightning.ogg}
            {COLOR_ADJUST 127 64 127}
            {DELAY 100}
            {COLOR_ADJUST 0 0 0}
            [message]
                speaker=Omaranth
                message=_"THE MASTER’S HOLD IS BROKEN."
            [/message]
            
            
            #############################
            # DEATH ANIMATION
            #############################
            [store_unit]
                {FILTER id=Omaranth}
                kill,variable=yes,stored_omaranth
            [/store_unit]
            {NAMED_UNIT 2 Ghost 1 1 Omaranth _"Omaranth" ()}
            {DELAY 250}
            
            [modify_unit]
                {FILTER id=Omaranth}
                canrecruit,facing=yes,$stored_omaranth.facing
                x,y=$stored_omaranth.x,$stored_omaranth.y
                hitpoints=1
                [object]
                    id=omaranth_illusion_animation
                    {EFFECT new_animation ([standing_anim] # use a standin anim so this isn't affected by acceleration
                        base_score=99
                        {FRAME image=misc/blank-hex.png}
                        overlay_start_time =-400 {OVERLAY_FRAME  alpha,image=1~0,"units/drakes/armageddon-defend-1.png~MASK(masks/teleport-mask-[9~0].png):100"}
                        overlay2_start_time=-600 {OVERLAY2_FRAME (halo_x,halo_y,halo= 10,-30~30,halo/teleport-[9,8,1~9].png:75)}
                        overlay3_start_time=-400 {OVERLAY3_FRAME (halo_x,halo_y,halo=  0,-40~40,halo/teleport-[9,8,1~9].png:75)}
                        overlay4_start_time=-200 {OVERLAY4_FRAME (halo_x,halo_y,halo=-10,-30~30,halo/teleport-[9,8,1~9].png:75)}
                    [/standing_anim])}
                [/object]
            [/modify_unit]
            {SOUND skill-illusion.wav}
            {DELAY 1000}
            
            
            #############################
            # REVEAL TO BE GHOST
            #############################
            {KILL id=Omaranth}
            {NAMED_UNIT 2 Ghost $stored_omaranth.x $stored_omaranth.y Omaranth _"Omaranth" canrecruit,facing=yes,$stored_omaranth.facing} {ANIMATE}
            {CLEAR_VARIABLE stored_omaranth}
            
            [message]
                speaker=Delfador
                message=_"What the–"
            [/message]
            
            {SOUND wail-sml.wav}
            [message]
                speaker=Omaranth
                message=_"At last... I am... free..."
            [/message]
            {KILL id=Omaranth ANIMATE=yes}
            {DELAY 1500}
            
            {KILL_COUNT 1 (
                side=2
                {NOT type="Cave Entrance"}
                [filter_vision]
                    side=1
                [/filter_vision]
            ) ANIMATE=yes} # we already played the ghost death sound for Omaranth, so don't over-use it
            {DELAY 3000}
            
            {KILL_COUNT 3 (
                side=2
                {NOT type="Cave Entrance"}
                [filter_vision]
                    side=1
                [/filter_vision]
            ) ANIMATE=yes}
            
            {GET_COMPANION_ID}
            {RECALL_XY $companion_id 17 10} # in case they got sent to your recall list from contingency
            [if] {NOT({HAVE_UNIT id=$companion_id})} {THEN(   {NAMED_UNIT 1 Footpad 17 10 new_companion _"Hadyc" facing=se} {ANIMATE}   )} [/if] # if there's nobody left alive besides delfador, spawn someone new
            [message]
                speaker=$companion_id
                message=_"...is it finally over? I’m alive! I think we won!"
            [/message]
            
            {KILL_COUNT 3 (
                side=2
                {NOT type="Cave Entrance"}
                [filter_vision]
                    side=1
                [/filter_vision]
            ) ANIMATE=yes}
            {KILL (side=2 {NOT type="Cave Entrance"}) }
            
            
            #############################
            # DELFADOR IS CONFUSED
            #############################
            {DELAY 1500}
            [message]
                speaker=Delfador
                message=_"Umm..."
            [/message]
            {DELAY 500}
            {STORE_UNIT_VAR id=Delfador x delfX}
            {STORE_UNIT_VAR id=Delfador y delfY}
            {MOVE_UNIT id=Delfador "$($delfX+1)" "$delfY"}
            {DELAY 500}
            {MOVE_UNIT id=Delfador "$($delfX-1)" "$($delfY+1)"}
            {DELAY 500}
            {MOVE_UNIT id=Delfador "$delfX" "$($delfY-1)"}
            {CLEAR_VARIABLE delfX,delfY}
            {DELAY 500}
            [message]
                speaker=Delfador
                message=_"What madness happened out here!? You were just supposed to guard the cave entrance, not start a massacre! Waking up all those undead; you almost got me killed!"
            [/message]
            
            #############################
            # BANDITS ARE MAD
            #############################
            [message]
                speaker=$companion_id
                message=_"I— we almost got YOU killed!? Do you have any idea wha’ happened out here while you were off chasin’ that drake? I didn’t wake up them zombies, you did! After you an’ the big drake ran off, they started comin’ up out’ta the ground, everywhere all around us!"
            [/message]
            [if] {VARIABLE_CONDITIONAL s09_deaths less_than 4} {THEN(
                [message]
                    speaker=$companion_id
                    message=_"We coulda’ ran, but no, “stay an’ help Delfador” I thought! Fightin’ for our lives! Do you know how many o’ us coulda’ died?"
                [/message]
            )} {ELSE(
                [message]
                    speaker=$companion_id
                    message=_"We coulda’ ran, but no, “stay an’ help Delfador” I thought! Fightin’ for our lives! Do you know how many o’ my friends jus’ died?"
                [/message]
            )} [/if]
            {CLEAR_VARIABLE s09_deaths}
            [message]
                speaker=Delfador
                message=_"Erm, well, I didn’t quite realize—"
            [/message]
            [message]
                speaker=$companion_id
                message=_"You sound jus’ like the king. Not even the common decency to say thank you to the people fightin’ and dyin’ for you! Guess you don’ care much for farm folk down at that palace o’ yours."
            [/message]
            {DELAY 3000}
            
            [message]
                speaker=$companion_id
                message=_"Ahem?"
            [/message]
            [message]
                speaker=Delfador
                message=_"I umm, yeah, thanks. Changing the subject, did you see that drake turn into a ghost, or was it just me?"
            [/message]
            [message]
                speaker=$companion_id
                message=_"..."
            [/message]
            
            #############################
            # CHANGING THE SUBJECT
            #############################
            [message]
                speaker=$companion_id
                message=_"...sure. Yeah I saw."
            [/message]
            {DELAY 500}
            [message]
                speaker=Delfador
                message=_"So my eyes weren’t playing tricks on me after all. Then the saurian “Great One” was... a ghost?"
            [/message]
            [message]
                speaker=Delfador
                message=_"But undead always have a maker — who controlled the ghost!?"
            [/message]
            [message]
                speaker=Delfador
                message=_"Hmm..."
            [/message]
            [message]
                speaker=Delfador
                message=_"...orcs ally with saurians, who’re commanded by a drake, who’s actually a ghost, who’s in the thrall of some absent necromancer — this is starting to get ridiculous. Things were a lot simpler when I stayed in Wesnoth and fought alongside Garard’s army."
            [/message]
            [message]
                speaker=$companion_id
                message=_"..."
            [/message]
            [message]
                speaker=Delfador
                message=_"More importantly, who went through the trouble to set all this up? Someone must be pulling the strings. Someone with connections."
            [/message]
            [message]
                speaker=Delfador
                message=_"Maybe— no. Hmm..."
            [/message]
            [message]
                speaker=Delfador
                message=_"What about if—? Mmm, that’s not right either."
            [/message]
            [message]
                speaker=Delfador
                message=_"Ugh, forget it. Enough mystery; I want something to fireball! With the drake — ghost, whatever — defeated, we’re closer than ever to winning the war against the orcs."
            [/message]
            [message]
                speaker=Delfador
                message=_"For now, I need to focus on defeating Clan Blackcrest — that’s what a really great hero would do, not mess around with mysteries. And now that we know what the saurians’ “Great One” was, I may know just how to do it..."
            [/message]
            
            
            #############################
            # CLEANUP AND VICTORY
            #############################
            {MODIFY_UNIT canrecruit=yes canrecruit no}
            {MODIFY_UNIT id=Delfador    canrecruit yes}
            
            {CLEAR_VARIABLE saurian_guide_id,saurian_guide_name,s09_tod}
            {CLEAR_VARIABLE next_defender,cave_locations}
            {CLEAR_VARIABLE cave00,cave01,cave02,cave03,cave04,cave05,cave06,cave07,cave08,cave09,cave10,cave11,cave12}
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 40}
            [/endlevel]
        [/event]
        
        
        #############################
        # CAVE IS DESTROYED
        #############################
        [event]
            name=die
            {FILTER id=cave00}
            
            {GET_COMPANION_ID}
            [message]
                side=1 {NOT id=$companion_id}
                message=_"The center crypt’s collapsin’! Weren’t we supposed to keep it open?"
            [/message]
            [message]
                speaker=$companion_id
                message=_"Th’ boss ’aint comin’ back out anytime soon. Guess we’d better scram back down south before th’ same happens to us."
            [/message]
            
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
        
        
        #############################
        # TIME OVER
        #############################
        [event]
            name=time over
            {FILTER_CONDITION( {HAVE_UNIT id=Omaranth)} )}
            
            [message]
                speaker=Omaranth
                message=_"THIS IS POINTLESS.
YOU ARE WEAK.
FAREWELL, HUMANS."
            [/message]
            {MOVE_UNIT id=Omaranth 16 6}
            {KILL id=Omaranth}
            [message]
                speaker=Delfador
                message=_"No, it’s gone! We needed that drake!"
            [/message]
        [/event]
    [/event]
    
    {HERODEATHS}
[/scenario]





