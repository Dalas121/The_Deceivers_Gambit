#textdomain wesnoth-tdg


#
# this is a puzzle sceneario
# even the combat part is a puzzle - attacks never miss and the AI is predictable
#

#
# my (Dalas's) best strategy for this scenario on Nightmare, as of 2024-02-23
# assuming you don't have a leveled familiar (which is very helpful)
#
# take Find Familiar and Polymorph
# turn 1:
#   leave your familiar next to mirror-kalenz, who will attack it. This gives regular-kalenz the edge he needs to win the duel
#   have Deoran hide in the bottom left. Mirror-deoran will 1-shot him
#   have Chantal start running towards Delfador
#   have Delfador start moving towards mirror-deoran (so mirror-deoran aggros onto him instead of regular-deoran)
# turn 2:
#   eventuall, have kalenz fight his mirror. He'll win now that the familiar has done 4 damage
#   polymorph Delfador into a roc, and with Chantal's help he can kill mirror-chantal
#   keep running Deoran away
# turn 3:
#   polymorph Delfador into a crab, and with Chantal's help he can kill mirror-deoran
#   make sure Chantal slows mirror-chantal before roc-delfador uses beak, or else roc-delfador won't have enough HP to survive mirror-deoran
# mirror-delfador 1:
#   don't kill him right away. His damage is bad, so take a moment to regroup. You need all units in the right side of the center area for delfador2
# mirror-delfador 2:
#   need to maneuver so that you can strike at him with both roc and another unit. It's possible to send kalenz southeast while deoran tanks from the northeast path
# mirror-delfador 3:
#   pretty easy to kill. Take him down immediately, because you need to be in the southeast
# mirror-delfador 4:
#   flee to the southeast for 1 turn, to separate mirror-delfador-4 from his guardians, then pounce and destroy multiple fire guardians before he can time dilate
#   he doesn't dialate until at least two of his units can reach you, so take advantage of that to set up the engagement
#   if you've followed the previous steps Delfador should be your healthiest unit, so the others get focused down first
#
# because there's no RNG and the AI is predictable, this strategy has worked 100% of the times I've tried it
#   of course the player may have a leveled familiar who can help fight, in which case this precise strategy isn't necessary any-more
#


[scenario]
    id,map_file,name=04_The_Sylvan_Seer,04_The_Sylvan_Seer.map,_"The Sylvan Seer"
    next_scenario,victory_when_enemies_defeated=05_The_Deceiver,no
    turns=-1
    [time]
        id,name,image=dusk,_"Dusk",misc/time-schedules/default/schedule-dusk.png
        red,green,blue=10,-20,-35
    [/time]
    {SCENARIO_MUSIC silvan_sanctuary.ogg}
    
    {DE_TRACK {JOURNEY_04_NEW}}
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name,user_team_name=wesnoth,_"Isle of Alduin"
        {FLAG_VARIANT loyalist}
        income=-2
    [/side]
    
    
    #############################
    # LINTANIR
    #############################
    [side]
        side,controller,color=2,ai,green
        no_leader,hidden=yes,yes
        team_name,user_team_name=wesnoth,_"Lintanir"
    [/side]
    [side]
        side,controller,color=3,ai,green
        no_leader,hidden=yes,yes
        team_name,user_team_name=enemies,_"Lintanir"
    [/side]
#define RESET_ENEMY_AI
    {RESET_SIDE_AI 2,3 no 0.99 0.01} 
    {MODIFY_SIDE_AI 2,3 leader_aggression=1}
    {MODIFY_SIDE_AI 2,3 leader_ignores_keep=yes}
    {MODIFY_SIDE_AI 2,3 ({GOAL_SEEK_SIDE 9 1 0})}
#enddef
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        {RESET_ENEMY_AI}
        
        #############################
        # ELVISH LEADERS
        #############################
        [unit]
            side,type,x,y=2,Elvish Marshal,15,7
            id,name=Eloreis,_"Eloreis"
            canrecruit=yes
            [modifications]
                {TRAIT_LOYAL} {TRAIT_STRONG}
                {TEAM_COLOR_OVERRIDE () brown}
            [/modifications]
            facing=nw
        [/unit]
        {CAPTURE_VILLAGES 2 1 1 999}
        
        [unit]
            side,type,x,y=2,Elvish Lady,17,6
            id,name=Quaenathiel,_"Quaenathiel"
            [modifications]
                {TRAIT_LOYAL} {TRAIT_QUICK}
                {TEAM_COLOR_OVERRIDE () brightgreen}
            [/modifications]
            facing=sw
        [/unit]
        
        [unit]
            side,type,x,y=2,Elvish High Lord,15,5
            id,name,profile=Kalenz,_"Kalenz",portraits/kalenz.webp
            [modifications]
                {TRAIT_LOYAL_HERO} {TRAIT_AGED}
                {TEAM_COLOR_OVERRIDE () green}
            [/modifications]
            facing=se
        [/unit]
        
        [unit]
            side,type,x,y=2,Elvish Druid,13,5
            id,name,profile=Chantal,_"Chantal",portraits/chantal-druid.webp
            [modifications]
                {TRAIT_LOYAL_HERO} {TRAIT_INTELLIGENT}
                {TEAM_COLOR_OVERRIDE () brightgreen}
                [object]
                    {EFFECT remove_advancement (types=Elvish Shyde)} # don't let her advance, so the player doesn't feed her XP and be disappointed when she leaves
                    {EFFECT new_advancement ({AMLA_DEFAULT})}
                [/object]
            [/modifications]
            facing=se
        [/unit]
        
        
        #############################
        # ELVISH CITIZENS
        #############################
#define GENERIC_CITIZEN X Y IMG
        {GENERIC_UNIT 2 (Elvish Shaman) {X} {Y}}
        {ADD_MODIFICATION([object]
            {EFFECT new_animation ([standing_anim]
                base_score=99
                {FRAME image="units/civilian/{IMG}.png"}
            [/standing_anim])}
        [/object])}
#enddef
        {GENERIC_CITIZEN  1  6 elf1}
        {GENERIC_UNIT 2 (Elvish Shaman) 4 7} {FACING sw}
        {GENERIC_UNIT 2 (Elvish Shaman) 2 9} {FACING se}
        {GENERIC_CITIZEN 20  2 elf2}
        {GENERIC_CITIZEN 21 13 elf3}
        
        {GENERIC_UNIT 2 (Elvish Archer)  8 4} {FACING sw}
        {GENERIC_UNIT 2 (Elvish Archer) 10 2} {FACING se}
        {GENERIC_UNIT 2 (Elvish Hero)   12 2} {FACING sw}
        {GENERIC_UNIT 2 (Elvish Fighter)      19 10} {FACING se}
        {GENERIC_UNIT 2 (Elvish Sharpshooter) 18  9} {FACING sw}
        
        
        #############################
        # HUMANS
        #############################
        {RECALL_XY Deoran 12 6}
        {MODIFY_UNIT id=Delfador facing ne}
        
        {RECALL_XY Delfador 13 8}
        {MODIFY_UNIT id=Delfador facing ne}
        
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        [message]
            speaker=Delfador
            #po: Delfador is trying to speak, but gets interrupted by an elvish marshal
            message=_"Ok, yes, but—"
        [/message]
        [message]
            speaker=Eloreis
            #po: Delfador has brought a message from King Garard to the elves, asking them to attack the whitefang orcs
            message=_"I understand Weldyn’s stance on orcs, but Garard cannot change the facts: our rangers have neither the training nor the elfpower to fight an offensive war on open ground! What your king asks of us is impossible."
        [/message]
        [message]
            speaker=Quaenathiel
            message=_"And why would we want to? The orcs stay out of our forests and we stay out of their hills; this is the way things have been for over a century. Your king promises us snow-covered mountains and barren desert as spoil, yet what desire have we for more territory when the Lintanir’s broad eaves could support ten times our numbers?"
        [/message]
        [message]
            speaker=Deoran
            message=_"My honorable lords and ladies, I understand your duty to safeguard your lands and your people. And is that not what Weldyn does now? King Garard must know the orcs threaten all peoples of Wesnoth, or why else would he wage this war?"
        [/message]
        [message]
            speaker=Delfador
            message=_"Ah, actually—"
        [/message]
        [message]
            speaker=Deoran
            message=_"You are, of course, welcome to scorn my King’s call; to loiter in the Lintanir; to live and laugh and <i>linger</i>, until Wesnoth’s strength is spent towards a pyrrhic victory or a bloody defeat.

But know that I shall answer my King’s summons; I shall march to war. In honor of the friendship we have built over my many years here, I would hope Lintanir will as well."
        [/message]
        {DELAY 500}
        {MODIFY_UNIT id=Eloreis facing ne}
        {DELAY 100}
        {MODIFY_UNIT id=Kalenz facing ne}
        {DELAY 500}
        {MODIFY_UNIT id=Eloreis facing sw}
        {DELAY 100}
        {MODIFY_UNIT id=Kalenz facing sw}
        {DELAY 500}
        [message]
            speaker=Kalenz
            message=_"Truly, a moving speech..."
        [/message]
        [message]
            speaker=Kalenz
            message=_"Deoran, I am sorry, but Eloreis is right. This is not our fight. I value your friendship and would honor the time you have spent here, but if Wesnoth goes to war we cannot march alongside you."
        [/message]
        [message]
            speaker=Chantal
            #po: 'grandfather' means Kalenz. Chantal is Kalenz's granddaughter
            message=_"Grandfather, how can you say such things! Deoran is risking— these humans are risking their lives in battle, and in all the vastness of Lintanir we can find naught to offer but kind words? Surely there is <i>something</i> we can do? Force-of-arms is not the only strength of the elves."
        [/message]
        [message]
            speaker=Kalenz
            message=_"Chantal, sometimes you remind me so much of your grandmother... perhaps you are right. I have seen too many friends fall during my unnaturally long life; sometimes to battle, sometimes to age. I would postpone that fate for Deoran if I can, for both your sakes."
        [/message]
        [message]
            speaker=Kalenz
            message=_"Deoran, Delfador, what I now speak to you concerns one of our great secrets; you are not to speak of this to anyone, even to your king."
        [/message]
        [message]
            speaker=Kalenz
            message=_"Within the Lintanir resides our sylph — an elven seer. We both favor and fear Elende’s fractured, arcane sight; her strands of reflected prophecy. Perhaps her visions may illuminate some measure of your futures, and in doing so help you blaze brighter ones."
        [/message]
        [message]
            speaker=Eloreis
            message=_"Kalenz, are you sure this is wise? Seers are known to be... esoteric... and Elende has been particularly cloistered these last few decades."
        [/message]
        [message]
            speaker=Chantal
            message=_"Of course it’s wise! I will accompany them! I wish to spend some time with De— with these humans before they depart."
        [/message]
        [message]
            speaker=Kalenz
            message=_"And so do and so shall I. Come, follow me."
        [/message]
        
        {FIRE_EVENT play_puzzle}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                     PLAY PUZZLE
    #######################################################################################################################################################
    [event]
        name=play_puzzle
        {SCREEN_FADER 0,0,0 255 500}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [replace_map]
            map_file=04b_The_Sylvan_Seer.map
            expand,shrink=yes,yes
        [/replace_map]
        [replace_schedule]
            [time]
                id,name,image=midnight,_"Midnight",misc/time-schedules/schedule-midnight.png
                red,green,blue=-75,-45,-13
                lawful_bonus=-25
            [/time]
        [/replace_schedule]
        [modify_side]
            side,shroud=1,yes
        [/modify_side]
        {SCROLL_TO 11 20}
        
        {GOLD_PICKUP 26 19 scenery/wreck.png             5 "" _"Look, there’s  5 gold pieces in this old boat! I suppose it’s better than nothing."}
        {GOLD_PICKUP 22  4 scenery/gold-coins-small.png 20 "" _"Look, buried treasure! There’s 20 gold pieces in this scarab hole. Not much use now, but I’m sure this’ll come in handy for our next battle."}
        {PLACE_IMAGE items/ball-blue.png  7 16}
        {PLACE_IMAGE items/ball-blue.png  8 12}
        {PLACE_IMAGE items/ball-blue.png  8  2}
        {PLACE_IMAGE items/ball-blue.png 14  4}
        {PLACE_IMAGE items/ball-blue.png 23  2}
        {PLACE_IMAGE items/ball-blue.png 23  8}
        {PLACE_IMAGE items/ball-blue.png 22 11}
        {PLACE_IMAGE items/ball-blue.png 18 11}
        {PLACE_IMAGE items/ball-blue.png 22 16}
        {PLACE_IMAGE items/ball-blue.png 17 18}
        
        {TELEPORT_UNIT id=Kalenz   11 19}  {MODIFY_UNIT id=Kalenz   side 1}
        {TELEPORT_UNIT id=Chantal  10 19}  {MODIFY_UNIT id=Chantal  side 1}
        {TELEPORT_UNIT id=Deoran   11 20}
        {TELEPORT_UNIT id=Delfador 12 19}
        {MODIFY_UNIT id=Kalenz   facing nw}
        {MODIFY_UNIT id=Delfador facing nw}
        {KILL side=2}
        
        [modify_side]
            side,team_name=2,enemies
        [/modify_side]
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)          (Great Wolf)    (Great Wolf)    (Great Wolf)   }  1  1  {GUARDIAN}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Horned Scarab) (Horned Scarab) (Horned Scarab) (Horned Scarab)} 22  4  {GUARDIAN}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)          (Horned Scarab) (Horned Scarab) (Horned Scarab)} 26  4  {GUARDIAN}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)          (none)          (none)          (Horned Scarab)} 24  2  {GUARDIAN}}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)          (Silverback)    (Silverback)    (Silverback)   } 20 17  {GUARDIAN}}
        {GIVE_OBJECT_TO type=Silverback ({EFFECT image_mod add={ON_DIFFICULTY4 "~SCALE(70,70)" "~SCALE(80,80)" "~SCALE(80,80)" "~SCALE(90,90)"}})}
        [event]
            name=sighted {FILTER (type=Great Wolf,Horned Scarab,Silverback)}
            {FIRE_EVENT explain_beasts}
        [/event]
        [event]
            name=moveto {FILTER ([filter_adjacent]
                type=Great Wolf,Horned Scarab,Silverback
            [/filter_adjacent])}
            {FIRE_EVENT explain_beasts}
        [/event]
        [event]
            name=explain_beasts
            [message]
                speaker=Delfador
                #po: said after a Great Wolf, Horned Scarab, or Silverback (a gorilla) attacks one of the player's units
                message=_"Look out! There’s beasts in the forest!"
            [/message]
        [/event]
        
        
        #############################
        # DISABLE SPELLCASTING
        #############################
        {VARIABLE no_spellcasting_event explain_no_spellcasting}
        [event]
            name=explain_no_spellcasting
            first_time_only=no
            {DELAY 500} # otherwise sometimes you automatically clear the message? Doesn't happen on my PC but Yumi said it happened on hers
            [message]
                speaker=Deoran
                #po: said after the player double-clicks on Delfador to try and cast a spell
                message=_"No magic, Delfador. We don’t want to appear threatening."
            [/message]
        [/event]
        
        # give delfador a L2 fireball and no other skills (i.e. a generic red mage)
        {STORE_SKILLS}
        {VARIABLE skill_fireball2 yes}
        {FIRE_EVENT refresh_delfador_skills}
        [event]
            name=play_challenge
            {UNSTORE_SKILLS} # restore the skills we chose in S03 (the player can reselect them, but restore the old ones anyway)
            {FIRE_EVENT refresh_delfador_skills}
        [/event]
        
        
        #############################
        # INTRO DIALOGUE
        #############################
        [message]
            speaker=narrator
            message=_"Kalenz leads Delfador, Deoran, and Chantal down a labyrinthian path through the deep wood, past twists and turns and over winding tracks. In many places there is no path at all, and Delfador senses they are guided more by the elves’ connection to the faerie than by conventional pathfinding."
        [/message]
        [message]
            speaker=narrator
            message=_"The sun sets like a dying ember quenched beneath the horizon, and the forest grows dim. Several times even Kalenz becomes lost, but each time manages to find the way again. At last, in the dead of night, a small structure looms out of the forest..."
        [/message]
        [change_theme] # back to default
        [/change_theme]
        {REPLACE_SCENARIO_MUSIC into_the_shadows.ogg}
        {APPEND_MUSIC phase_shift.ogg}
        {SCREEN_FADER 0,0,0 000 500}
        [message]
            speaker=Kalenz
            message=_"We have arrived. The seer’s mirror pool is just ahead; she herself should be close by."
        [/message]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find the Sylph"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Delfador, Deoran, Chantal, or Kalenz"
                condition=lose
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=100,no
            [/gold_carryover]
            [note]
                description=_"Kalenz and Chantal will not follow you to the next scenario."
            [/note]
        [/objectives]
        
        
        #############################
        # REVEAL PUZZLE
        #############################
        [event]
            name=moveto {FILTER side,y=1,0-15}
            [remove_shroud]
                side,x,y,radius=1,13,10,3}
            [/remove_shroud]
            {SCROLL_TO 13 10}
            [message]
                speaker,scroll=Kalenz,no
                #po: there is a pool of water in the middle of the map. Right now the pool is mostly dry - your objective is to solve a puzzle to fill the pool with water
                message=_"There lies the mirror pool, but it is strangely dry..."
            [/message]
            
            [objectives]
                [objective]
                    description= _ "Fill the central pool with water"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Delfador, Deoran, Chantal, or Kalenz"
                    condition=lose
                [/objective]
                [gold_carryover]
                    carryover_percentage,bonus=100,no
                [/gold_carryover]
                [note]
                    description=_"Kalenz and Chantal will not follow you to the next scenario."
                [/note]
            [/objectives]
            
            [listen_for_mousemove]
            [/listen_for_mousemove]
            [event]
                name=mousemove_synced
                [do_command]
                    [fire_event]
                        raise=mousemove # convert to a synced context
                    [/fire_event]
                [/do_command]
            [/event]
            [event]
                name=select
                [do_command]
                    [fire_event]
                        raise=mousemove # convert to a synced context
                    [/fire_event]
                [/do_command]
            [/event]
            [event]
                name=mousemove,recruit,recall,side 1 turn end
                [message]
                    speaker,image=narrator,wesnoth-icon.png
                    message=_"This is a puzzle segment. If you don’t like puzzles or find it too difficult, you can choose to skip it."
                    [option]
                        label= _ "Play the puzzle (includes some Gold and XP)"
                    [/option]
                    [option]
                        label= _ "Skip the puzzle"
                        [command]
                            {FIRE_EVENT deoran_dialogue}
                            {DELAY 1500}
                            {FIRE_EVENT chantal_dialogue}
                            {DELAY 500}
                            {FIRE_EVENT chantal_dialogue2}
                            {DELAY 1500}
                            {FIRE_EVENT play_challenge}
                        [/command]
                    [/option]
                [/message]
            [/event]
        [/event]
        
        
        #############################
        # FLAVOR DIALOGUE
        #############################
#ifdef EASY
        [event]
            name=enter hex {FILTER side,x,y=1,15-99,0-13}
            [cancel_action]
            [/cancel_action]
            {FIRE_EVENT delfador_dialogue}
        [/event] #endif
        [event]
            name=moveto {FILTER side,x,y=1,8,2}
            [event]
                name=new turn
                [event]
                    name=new turn
                    {FIRE_EVENT deoran_dialogue}
                [/event]
            [/event]
        [/event]
        [event]
            name=deoran_dialogue
            [message]
                speaker=Delfador
                #po: referencing the events in The South Guard
                message=_"Deoran, I took an exam on you during my second year at Alduin. Is it true you single-handedly retook Westin from a gang of bandits, and then returned to Wesnoth proper to become the King’s high advisor? You’re famous!"
            [/message]
            [message]
                speaker=Delfador
                message=_"But what’re you doing all the way out here? I’ve never heard of a permanent ambassador this far north."
            [/message]
            [message]
                speaker=Deoran
                #po: this is what has happened to Deoran since ending The South Guard
                message=_"The king and I had a... disagreement, regarding his treatment of the young queen Asheviere. Words became heated, and things were said that could not be taken back. Shortly thereafter I was reassigned to Lintanir; I suspect so that I would cease to meddle in the kingdom’s politics."
            [/message]
            [message]
                speaker=Deoran
                message=_"And so my reputation in Wesnoth is not what it used to be, but yet I hold no grudge. Ambassador to the Lintanir is a prestigious position, in name if nothing else, and I have learned to value my time amongst the elves."
            [/message]
            [message]
                speaker=Deoran
                message=_"I must confess I look forward to once-again marching in company with others of my own ilk, yet still I hope to return to Lintanir once my war-duty is done."
            [/message]
        [/event]
#ifdef EASY
        [event]
            name=enter hex {FILTER side,x,y=1,21-99,0-13}
            [cancel_action]
            [/cancel_action]
            {FIRE_EVENT chantal_dialogue}
        [/event] #endif
        [event]
            name=moveto {FILTER side,x,y=1,17,18}
            [event]
                name=new turn
                {FIRE_EVENT chantal_dialogue}
            [/event]
        [/event]
        [event]
            name=chantal_dialogue
            [message]
                speaker=Kalenz
                message=_"Chantal, we have much to speak about. It is clear you have feelings for the ambassador. Deoran is no fool; if he does not already know, he certainly suspects."
            [/message]
            [message]
                speaker=Chantal
                message=_"—who? What? Grandfather, I have no idea what you’re talking about."
            [/message]
            [event]
                name=select,moveto,turn end,chantal_dialogue2
                [message]
                    speaker=Chantal
                    #po: continuing the "Chantal has feelings for Deoran" conversation, a moment after it ended
                    message=_"Ok-fine, yes, but Deoran is a good man! Wise and kind, and quietly bearing his burden of exile, so far away from his people? And he’s <i>human</i>! Even a crusty old elf like you has to admit that round ears and stubble are exotic."
                [/message]
                [message]
                    speaker=Kalenz
                    message=_"The lives of men burn brightly, but briefly. Even if he returns to Lintanir, what future could you build together? I will not stop you if you want to pursue this, but I know all-too-well the pain from outliving those you love. Your grandmother was just as stubborn as you..."
                [/message]
            [/event]
        [/event]
        
        
        #############################
        # EXPLAIN ORBS
        #############################
        [event]
            name=explain_orbs
            [message]
                speaker=Chantal
                #po: the player has just moved a unit onto one of several blue orbs scattered around the map, which has caused a river to change direction. This is part of the puzzle
                message=_"Look, the stream is changing direction!"
            [/message]
        [/event]
        [event]
            name=explain_gurgle
            [message]
                speaker=Delfador
                #po: a monster has just drowned in the river, as a result of the player redirecting the river into the beast's hex
                message=_"Odd, the water appears shallow but the beast has vanished entirely."
            [/message]
        [/event]
        
        
        #############################
        # IMPLEMENT ORBS
        #############################
        [event]
            name=enter hex
            id=orbs_implementation
            first_time_only=no
            {FILTER side=1} # a more selective query fails if we move through allies
    #         {FILTER (side=1
    #             {FILTER_LOCATION (
    #                 x= 7, 8, 8,14,23,23,22,18,22,17 # refresh whenever we enter or exit an orb's hex
    #                 y=16,12, 2, 4, 2, 8,11,11,16,18 # (can't use exit hex, because that triggers *before* exiting)
    #                 radius=1 )}
    #         )}
            {FIRE_EVENT refresh_rivers}
            [allow_undo]
            [/allow_undo]
            [on_undo]
                {FIRE_EVENT refresh_rivers}
            [/on_undo]
        [/event]
#define TERRAINIFY TERRAIN X Y
        [if] {HAVE_LOCATION (x,y={X},{Y} {NOT terrain={TERRAIN}})} {THEN(
            {MODIFY_TERRAIN {TERRAIN} {X} {Y}}
            {FIRE_EVENT explain_orbs}
            {FIRE_EVENT play_orb_sound}
            [redraw]
                side=1
            [/redraw]
            {DELAY 50}
            [if] {HAVE_UNIT x,y,defense={X},{Y},100} {THEN(
                [if] {HAVE_UNIT side,x,y=1,{X},{Y}} {THEN(
                    [message]
                        x,y={X},{Y}
                        #po: a player unit has just drowned in the river, as a result of the player redirecting the river into the beast's hex
                        message=_"This sandbed is shallow, but the water is suddenly deep and a strange magic tugs at my legs! I am drowning!"
                    [/message]
                    {KILL x,y={X},{Y} ANIMATE=yes}
                    [endlevel]
                        result=defeat
                    [/endlevel]
                )} {ELSE(
                    [message]
                        x,y={X},{Y}
                        #po: a monster has just drowned in the river, as a result of the player redirecting the river into the beast's hex
                        message=_"<i>Gurgle gurgle gurgle...</i>"
                    [/message]
                    [if] {HAVE_UNIT x,y,type={X},{Y},Silverback} {THEN({ACHIEVE s04})} [/if]
                    {KILL x,y={X},{Y} ANIMATE=yes FIRE_EVENT=yes}
                    {FIRE_EVENT explain_gurgle}
                )} [/if]
            )} [/if]
        )} [/if]
#enddef
        [event]
            name=refresh_rivers
            first_time_only=no
            [allow_undo]
            [/allow_undo]
            
            # play the sound only once per event
            [event]
                name,id=play_orb_sound,play_orb_sound
                {SOUND sylph-orb-water.wav}
            [/event]
            
            #--------------------
            # SOUTHWEST RIVER
            #--------------------
            [if] {HAVE_UNIT side,x,y=1,7,16} {THEN(
                {TERRAINIFY Wo  8 15}
                {TERRAINIFY Wo  9 16}
                {TERRAINIFY Wo 10 15}
                {TERRAINIFY Wo 11 15-16}
                {TERRAINIFY Wo 12 14}
                {TERRAINIFY Wo 13 14}
                {TERRAINIFY Dd 7-8 14}
                {TERRAINIFY Dd   8 13}
                {TERRAINIFY Dd   9 13}
                
                {TERRAINIFY Dd  10 12} # right branch
                {TERRAINIFY Dd  11 12}
                {TERRAINIFY Dd  11 11}
                {TERRAINIFY Dd^Qhux 12 10}
                {TERRAINIFY Dd^Qhux 13 11}
                
                {TERRAINIFY Dd   9 12} # left branch
                {TERRAINIFY Dd 8-9 11}
                {TERRAINIFY Dd   8 10}
                {TERRAINIFY Dd   7 10}
            )} {ELSE(
                {TERRAINIFY Wo 7-8 14}
                {TERRAINIFY Wo   8 13}
                {TERRAINIFY Wo   9 13}
                [if] {HAVE_UNIT side,x,y=1,8,12} {THEN(
                    {TERRAINIFY Wo  10 12} # right branch
                    {TERRAINIFY Wo  11 12}
                    {TERRAINIFY Wo  11 11}
                    {TERRAINIFY Wo^Qhux 12 10}
                    {TERRAINIFY Wo^Qhux 13 11}
                    {TERRAINIFY Dd   9 12}
                    {TERRAINIFY Dd 8-9 11}
                    {TERRAINIFY Dd   8 10}
                    {TERRAINIFY Dd   7 10}
                )} {ELSE(
                    {TERRAINIFY Wo   9 12} # left branch
                    {TERRAINIFY Wo 8-9 11}
                    {TERRAINIFY Wo   8 10}
                    {TERRAINIFY Wo   7 10}
                    {TERRAINIFY Dd  10 12}
                    {TERRAINIFY Dd  11 12}
                    {TERRAINIFY Dd  11 11}
                    {TERRAINIFY Dd^Qhux 12 10}
                    {TERRAINIFY Dd^Qhux 13 11}
                )} [/if]
                
                {TERRAINIFY Dd  8 15}
                {TERRAINIFY Dd  9 16}
                {TERRAINIFY Dd 10 15}
                {TERRAINIFY Dd 11 15-16}
                {TERRAINIFY Dd 12 14}
                {TERRAINIFY Dd 13 14}
            )} [/if]
            
            
            #--------------------
            # NORTH RIVER
            #--------------------
            [if] {HAVE_UNIT side,x,y=1,23,2} {THEN(
                {TERRAINIFY Wo 22-23 3}
                {TERRAINIFY Wo 22-23 4}
                {TERRAINIFY Wo 24  2-4}
                {TERRAINIFY Wo 25  4-5}
                {TERRAINIFY Wo 26  3-4}
                {TERRAINIFY Dd 20 2-3}
                {TERRAINIFY Dd 19 3-4}
                {TERRAINIFY Dd 18 2-3}
                {TERRAINIFY Dd 17 3  }
                {TERRAINIFY Dd 16 2-3}
                {TERRAINIFY Dd 15 2  }
                {TERRAINIFY Dd 16 4  }
                {TERRAINIFY Dd 15 4  }
                {TERRAINIFY Dd 14 2-3}
                {TERRAINIFY Dd 13 3-4}
                
                {TERRAINIFY Dd 15 5} # first branch
                {TERRAINIFY Dd 15 6}
                {TERRAINIFY Dd 16 6}
                
                {TERRAINIFY Dd 13 5} # second branch
                {TERRAINIFY Dd 12 5}
                {TERRAINIFY Dd 13 6}
                {TERRAINIFY Dd 12 6}
                
                {TERRAINIFY Dd 12 2-3} # main
                {TERRAINIFY Dd 11 3  }
                {TERRAINIFY Dd 10 2-3}
                {TERRAINIFY Dd  9 2-3}
                {TERRAINIFY Dd  8 3  }
                
                {TERRAINIFY Dd 7 3  } # third branch
                {TERRAINIFY Dd 6 2-3}
                {TERRAINIFY Dd 5 3-4}
                {TERRAINIFY Dd 4 4}
                {TERRAINIFY Dd 4 5}
                {TERRAINIFY Dd 5 6}
                {TERRAINIFY Dd 4 6}
                {TERRAINIFY Dd 5 7}
                
                {TERRAINIFY Dd  8 4} # main
                {TERRAINIFY Dd  8 5}
                {TERRAINIFY Dd  9 6}
                {TERRAINIFY Dd 10 6}
                {TERRAINIFY Dd 10 7}
                {TERRAINIFY Dd 10 8}
                {TERRAINIFY Dd 11 9}
                {TERRAINIFY Dd^Qhux 11 10}
                {TERRAINIFY Dd^Qhux 12  9}
            )} {ELSE(
                {TERRAINIFY Wo 20 2-3}
                {TERRAINIFY Wo 19 3-4}
                {TERRAINIFY Wo 18 2-3}
                {TERRAINIFY Wo 17 3  }
                {TERRAINIFY Wo 16 2-3}
                {TERRAINIFY Wo 15 2  }
                {TERRAINIFY Wo 16 4  }
                {TERRAINIFY Wo 15 4  }
                {TERRAINIFY Wo 14 2-3}
                {TERRAINIFY Wo 13 3-4}
                
                [if] {HAVE_UNIT side,x,y=1,14,4} {THEN(
                    {TERRAINIFY Wo 13 5} # second branch
                    {TERRAINIFY Wo 12 5}
                    {TERRAINIFY Wo 13 6}
                    {TERRAINIFY Wo 12 6}
                    {TERRAINIFY Dd 15 5}
                    {TERRAINIFY Dd 15 6}
                    {TERRAINIFY Dd 16 6}
                )} {ELSE(
                    {TERRAINIFY Wo 15 5} # first branch
                    {TERRAINIFY Wo 15 6}
                    {TERRAINIFY Wo 16 6}
                    {TERRAINIFY Dd 13 5}
                    {TERRAINIFY Dd 12 5}
                    {TERRAINIFY Dd 13 6}
                    {TERRAINIFY Dd 12 6}
                )} [/if]
                
                {TERRAINIFY Wo 12 2-3}
                {TERRAINIFY Wo 11 3  }
                {TERRAINIFY Wo 10 2-3}
                {TERRAINIFY Wo  9 2-3}
                {TERRAINIFY Wo  8 3  }
                
                [if] {HAVE_UNIT side,x,y=1,8,2} {THEN(
                    {TERRAINIFY Wo 7 3  } # third branch
                    {TERRAINIFY Wo 6 2-3}
                    {TERRAINIFY Wo 5 3-4}
                    {TERRAINIFY Wo 4 4}
                    {TERRAINIFY Wo 4 5}
                    {TERRAINIFY Wo 5 6}
                    {TERRAINIFY Wo 4 6}
                    {TERRAINIFY Dd 5 7}
                    {TERRAINIFY Dd  8 4}
                    {TERRAINIFY Dd  8 5}
                    {TERRAINIFY Dd  9 6}
                    {TERRAINIFY Dd 10 6}
                    {TERRAINIFY Dd 10 7}
                    {TERRAINIFY Dd 10 8}
                    {TERRAINIFY Dd 11 9}
                    {TERRAINIFY Dd^Qhux 11 10}
                    {TERRAINIFY Dd^Qhux 12  9}
                )} {ELSE(
                    {TERRAINIFY Wo  8 4} # main
                    {TERRAINIFY Wo  8 5}
                    {TERRAINIFY Wo  9 6}
                    {TERRAINIFY Wo 10 6}
                    {TERRAINIFY Wo 10 7}
                    {TERRAINIFY Wo 10 8}
                    {TERRAINIFY Wo 11 9}
                    {TERRAINIFY Wo^Qhux 11 10}
                    {TERRAINIFY Wo^Qhux 12  9}
                    {TERRAINIFY Dd 7 3  }
                    {TERRAINIFY Dd 6 2-3}
                    {TERRAINIFY Dd 5 3-4}
                    {TERRAINIFY Dd 4 4}
                    {TERRAINIFY Dd 4 5}
                    {TERRAINIFY Dd 5 6}
                    {TERRAINIFY Dd 4 6}
                    {TERRAINIFY Dd 5 7}
                )} [/if]
                
                {TERRAINIFY Dd 22-23 3}
                {TERRAINIFY Dd 22-23 4}
                {TERRAINIFY Dd 24  2-4}
                {TERRAINIFY Dd 25  4-5}
                {TERRAINIFY Dd 26  3-4}
            )} [/if]
            
            
            #--------------------
            # EAST RIVER
            #--------------------
            [if] {HAVE_UNIT side,x,y=1,23,8} {THEN(
                {TERRAINIFY Wo 23 9}
                {TERRAINIFY Wo 22 8}
                {TERRAINIFY Wo 21 8}
                {TERRAINIFY Wo 20 7}
                {TERRAINIFY Wo 20 8}
                {TERRAINIFY Wo 20 6}
                {TERRAINIFY Wo 19 7}
                {TERRAINIFY Wo 19 8}
                {TERRAINIFY Wo 18 8}
                {TERRAINIFY Wo 17 9}
                {TERRAINIFY Wo 16 8}
                {TERRAINIFY Wo 15 9}
                {TERRAINIFY Wo^Qhux 13 9}
                {TERRAINIFY Wo^Qhux 14 9}
                {TERRAINIFY Dd 24 8}
                {TERRAINIFY Dd 24 7}
            )} {ELSE(
                {TERRAINIFY Wo 24 8}
                {TERRAINIFY Wo 24 7}
                {TERRAINIFY Dd 23 9}
                {TERRAINIFY Dd 22 8}
                {TERRAINIFY Dd 21 8}
                {TERRAINIFY Dd 20 7}
                {TERRAINIFY Dd 20 8}
                {TERRAINIFY Dd 20 6}
                {TERRAINIFY Dd 19 7}
                {TERRAINIFY Dd 19 8}
                {TERRAINIFY Dd 18 8}
                {TERRAINIFY Dd 17 9}
                {TERRAINIFY Dd 16 8}
                {TERRAINIFY Dd 15 9}
                {TERRAINIFY Dd^Qhux 13 9}
                {TERRAINIFY Dd^Qhux 14 9}
            )} [/if]
            
            
            [if] {HAVE_UNIT side,x,y=1,22,11} {THEN(
                {TERRAINIFY Wo 22 10}
                {TERRAINIFY Wo 21 10}
                {TERRAINIFY Wo 21 11}
                {TERRAINIFY Wo 20 10}
                {TERRAINIFY Wo 19 11}
                {TERRAINIFY Wo 18 10}
                {TERRAINIFY Wo 17 11}
                [if] {HAVE_UNIT side,x,y=1,18,11} {THEN(
                    {TERRAINIFY Wo 16 11}
                    {TERRAINIFY Wo 15 11}
                    {TERRAINIFY Wo^Qhux 14 10}
                    {TERRAINIFY Wo^Qhux 15 10}
                    {TERRAINIFY Dd 17 12}
                    {TERRAINIFY Dd 18 12}
                    {TERRAINIFY Dd 17 13}
                )} {ELSE(
                    {TERRAINIFY Wo 17 12}
                    {TERRAINIFY Wo 18 12}
                    {TERRAINIFY Wo 17 13}
                    {TERRAINIFY Dd 16 11}
                    {TERRAINIFY Dd 15 11}
                    {TERRAINIFY Dd^Qhux 14 10}
                    {TERRAINIFY Dd^Qhux 15 10}
                )} [/if]
                {TERRAINIFY Dd 23 11}
                {TERRAINIFY Dd 23 12}
                {TERRAINIFY Dd 24 12}
                {TERRAINIFY Dd 23 13}
                {TERRAINIFY Dd 24 13}
                {TERRAINIFY Dd 25 14}
            )} {ELSE(
                {TERRAINIFY Wo 23 11}
                {TERRAINIFY Wo 23 12}
                {TERRAINIFY Wo 24 12}
                {TERRAINIFY Wo 23 13}
                {TERRAINIFY Wo 24 13}
                {TERRAINIFY Wo 25 14}
                {TERRAINIFY Dd 22 10}
                {TERRAINIFY Dd 21 10}
                {TERRAINIFY Dd 21 11}
                {TERRAINIFY Dd 20 10}
                {TERRAINIFY Dd 19 11}
                {TERRAINIFY Dd 18 10}
                {TERRAINIFY Dd 17 11}
                {TERRAINIFY Dd 17 12}
                {TERRAINIFY Dd 18 12}
                {TERRAINIFY Dd 17 13}
                {TERRAINIFY Dd 16 11}
                {TERRAINIFY Dd 15 11}
                {TERRAINIFY Dd^Qhux 14 10}
                {TERRAINIFY Dd^Qhux 15 10}
            )} [/if]
            
            
            #--------------------
            # SOUTHEAST RIVER
            #--------------------
            [if] {HAVE_UNIT side,x,y=1,22,16} {THEN(
                {TERRAINIFY Wo 22 15}
                {TERRAINIFY Wo 22 14}
                {TERRAINIFY Wo 23 15}
                {TERRAINIFY Wo 23 16}
                {TERRAINIFY Wo 24 15}
                {TERRAINIFY Dd 20 15}
                {TERRAINIFY Dd 20 14}
                {TERRAINIFY Dd 19 15}
                {TERRAINIFY Dd 19 14}
            )} {ELSE(
                {TERRAINIFY Wo 20 15}
                {TERRAINIFY Wo 20 14}
                {TERRAINIFY Wo 19 15}
                {TERRAINIFY Wo 19 14}
                {TERRAINIFY Dd 22 15}
                {TERRAINIFY Dd 22 14}
                {TERRAINIFY Dd 23 15}
                {TERRAINIFY Dd 23 16}
                {TERRAINIFY Dd 24 15}
            )} [/if]
            
            
            [if] {HAVE_UNIT side,x,y=1,17,18} {THEN(
                {TERRAINIFY Wo 15 19}
                {TERRAINIFY Wo 15 18}
                {TERRAINIFY Wo 14 18}
                {TERRAINIFY Wo 13 18}
                {TERRAINIFY Wo 13 19}
                {TERRAINIFY Wo 12 19}
                {TERRAINIFY Wo 13 20}
                {TERRAINIFY Wo 12 20}
                {TERRAINIFY Dd 16 17}
                {TERRAINIFY Dd 17 17}
                {TERRAINIFY Dd 16 16}
                {TERRAINIFY Dd 15 16}
                {TERRAINIFY Dd 14 16}
                {TERRAINIFY Dd 14 15}
            )} {ELSE(
                {TERRAINIFY Wo 16 17}
                {TERRAINIFY Wo 17 17}
                {TERRAINIFY Wo 16 16}
                {TERRAINIFY Wo 15 16}
                {TERRAINIFY Wo 14 16}
                {TERRAINIFY Wo 14 15}
                {TERRAINIFY Dd 15 19}
                {TERRAINIFY Dd 15 18}
                {TERRAINIFY Dd 14 18}
                {TERRAINIFY Dd 13 18}
                {TERRAINIFY Dd 13 19}
                {TERRAINIFY Dd 12 19}
                {TERRAINIFY Dd 13 20}
                {TERRAINIFY Dd 12 20}
            )} [/if]
            
            
            #--------------------
            # IS THE POOL FULL?
            #--------------------
            [if] {HAVE_LOCATION( x,y=13,10
                [filter_adjacent_location]
                    count,terrain=6,Wo^*
                [/filter_adjacent_location]
            )} {THEN(
                {FIRE_EVENT play_challenge}
            )} [/if]
        [/event]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   PLAY CHALLENGE
    #######################################################################################################################################################
    [event]
        name=play_challenge
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [item]
            x,y,halo=13,10,halo/elven/faerie-fire-halo[1~7].png
        [/item]
        {SCROLL_TO 13 10}
        [message]
            speaker=Delfador
            #po: the player has completed their puzzle, and filled the central "mirror pool" with water
            message=_"There! The pool is full!"
            scroll=no
        [/message]
        {DELAY 1000}
        {SOUND bell.ogg}
        {DELAY 680}
        {SCREEN_FADER 0,0,0 255 0}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        
        [replace_map]
            map_file=04c_The_Sylvan_Seer.map
            expand,shrink=yes,yes
        [/replace_map]
        {REMOVE_IMAGE 0-99 0-99}
        [remove_event]
            id=gold_pickup_22_4
        [/remove_event]
        [remove_event]
            id=gold_pickup_26_19
        [/remove_event]
        {PLACE_IMAGE items/brazier.png 31 20}
        [replace_schedule]
            [time]
                id,name,image=void,_"Void",misc/schedule-void.png
                red,green,blue=-45,-75,-13
            [/time]
        [/replace_schedule]
        [modify_side]
            side,shroud=1,no
        [/modify_side]
        {SCROLL_TO 31 20}
        
        {TELEPORT_UNIT id=Kalenz   26 12}  {MODIFY_UNIT id=Kalenz   facing ne}
        {TELEPORT_UNIT id=Chantal  41 18}  {MODIFY_UNIT id=Chantal  facing sw}
        {TELEPORT_UNIT id=Deoran   35 28}  {MODIFY_UNIT id=Deoran   facing ne}
        {TELEPORT_UNIT id=Delfador 31 20}
        [modify_unit]
            {FILTER side=1}
            moves=$( $this_unit.max_moves )
            attacks_left=1
        [/modify_unit]
        {KILL side=2}
        
        [modify_turns]
            value,current=25,1
        [/modify_turns]
        [event]
            name=turn 20
            {SOUND rumble.ogg}
            {EARTHQUAKE ()}
            [message]
                speaker=Delfador
                message=_"What was that?!"
            [/message]
        [/event]
        [event]
            name=turn 21
            {SOUND rumble.ogg}
            {EARTHQUAKE ()}
            {EARTHQUAKE ()}
            [message]
                speaker=Delfador
                message=_"I think this whole mirror world is starting to fall apart! I have to hurry!"
            [/message]
        [/event]
        [event]
            name=time over
            {SOUND rumble.ogg}
            {EARTHQUAKE ()}
            {EARTHQUAKE ()}
            {EARTHQUAKE ()}
            {EARTHQUAKE ()}
            {KILL id=Delfador FIRE_EVENT=yes}
        [/event]
        [remove_event]
            id=orbs_implementation
        [/remove_event]
        
        {DELAY 4000}
        [change_theme]
            theme= # back to default
        [/change_theme]
        {REPLACE_SCENARIO_MUSIC decoherence.ogg}
        {SOUND door-close.wav}
        {SCREEN_FADER 0,0,0 000 0}
        {DELAY 1000}
        {SCROLL_TO 35 28} {DELAY 700}
        {SCROLL_TO 41 18} {DELAY 700}
        {SCROLL_TO 26 12} {DELAY 700}
        
        
        #####################
        # FORCE ACCURACY
        #####################
        # because there's so few units and RNG has a big impact, give all units 100% accuracy
        {FORCE_CHANCE_TO_HIT () () 100 ()}
        
        
        #############################
        # INTRODUCE MIRRORS
        #############################
#define MIRROR_EFFECTS
        # vary on all difficulties even though we claim to only change gold between Normal/Hard, because gold is useless in this scenario
        {EFFECT hitpoints increase_total={ ON_DIFFICULTY4 -99%  -0%  -0% -0%}}
        {EFFECT attack    increase_damage={ON_DIFFICULTY4 -99% -67% -33% -0%}}
#         {EFFECT level ({FILTER level=2-99} set=1)} # disabled because it messes with L2 delfador's leadership
        {EFFECT movement_costs (replace=yes
            [movement_costs]
                shallow_water,reef=1,1
            [/movement_costs])}
        {EFFECT halo halo="halo/holy/light-beam-5.png~CROP(0,0,150,500)~SCALE(108,144)~CS(-159,-255,-159)~MASK(terrain/misc/smoke-A[01~12].png~SCALE(108,144)):100"}
        {EFFECT new_animation ([animation]
            apply_to=post_teleport
            {TELEPORT_IN_ANIMATION}
        [/animation])}
        {EFFECT new_animation ([animation]
            apply_to,base_score=death,99 # override other death animations
            smoke_1_start_time,start_time,smoke_2_start_time=0,200,400
            [smoke_1_frame]
                sound=skill-polymorph-quiet.wav
                image="terrain/misc/smoke-A[01~12,01~12,01~12,01~12,01~12,01~12].png~SCALE([72~143],[144~215]):50"
                y,auto_vflip,image_mod=0~-200,no,"~CS(-31,-255,-31)"
                alpha=0~1,1,1,1~0
            [/smoke_1_frame]
            [frame]
                duration,image_mod=500,"~CS(127,0,127)~BL([15,10,20,30,40,50,60,70])"
                blend_ratio,blend_color=0~1,255,255,255
                alpha=1,1~0
            [/frame]
            [smoke_2_frame]
                image="terrain/misc/smoke-A[01~12,01~12,01~12,01~12,01~12,01~12].png~SCALE([72~143],[144~215]):50"
                y,auto_vflip,image_mod=0~-200,no,"~CS(-31,-255,-31)"
                alpha=0~1,1,1,1~0
            [/smoke_2_frame]
        [/animation] )}
#enddef
        [message]
            speaker,image=Kalenz,portraits/kalenz-mirror.webp
            #po: the player's units have just been transported into a strange realm, and aren't sure what's going on. Kalenz probably knows more than anybody else, and is calling out to see where Elende is (and what exactly she's doing)
            message=_"Elende!"
        [/message]
        {DELAY 2000}
        [message]
            speaker,image=Kalenz,portraits/kalenz-mirror.webp
            message=_"Elende, I come with friends, seeking foresight! Deoran and Del-"
        [/message]
        [message]
            speaker,image=narrator,portraits/elende-mirror.webp
            #po: immediately after this, magically created "mirror image" units of younger/older versions of Kalenz, Chantal, and Deoran appear
            message=_"I know who you are, Delfador of Alduin. But how well do you know yourselves?"
        [/message]
        
        {SCROLL_TO 32 14}
        [unit]
            side,type,x,y=2,Elvish Lord,32,14
            id,name=kalenz_mirror,_"Kalenz"
            [modifications]
                {TRAIT_LOYAL_HERO} {TRAIT_STRONG}
                {TEAM_COLOR_OVERRIDE () green}
                [object] {MIRROR_EFFECTS} [/object]
            [/modifications]
            facing=nw
        [/unit]
        {SOUND skill-illusion-quiet.wav}
        {ANIMATE_UNIT id=kalenz_mirror post_teleport}
        {DELAY 750}
        
        {SCROLL_TO 41 12}
        [unit]
            side,type,x,y=2,Elvish Shyde,41,12
            id,name=chantal_mirror,_"Chantal"
            [modifications]
                {TRAIT_LOYAL_HERO} {TRAIT_INTELLIGENT}
                {TEAM_COLOR_OVERRIDE () brightgreen}
                [object] {MIRROR_EFFECTS} [/object]
            [/modifications]
            facing=ne
        [/unit]
        {SOUND skill-illusion-quiet.wav}
        {ANIMATE_UNIT id=chantal_mirror post_teleport}
        {DELAY 750}
        
        {SCROLL_TO 40 26}
        [unit]
            side,type,x,y=2,Mounted General,40,26
            id,name=deoran_mirror,_"Deoran"
            [modifications]
                {TRAIT_LOYAL_HERO} {TRAIT_INTELLIGENT}
                {TEAM_COLOR_OVERRIDE () red}
                [object] {MIRROR_EFFECTS} [/object]
            [/modifications]
            facing=sw
        [/unit]
        {SOUND skill-illusion-quiet.wav}
        {ANIMATE_UNIT id=deoran_mirror post_teleport}
        {DELAY 750}
        
        [message]
            speaker,image=Chantal,portraits/chantal-druid-mirror.webp
            #po: referencing the mirror image of Deoran. Currently, the unit uses the old sprite of Deoran from TSG
            message=_"Deoran, is that... you? You look so much younger."
        [/message]
        [message]
            speaker,image=Deoran,portraits/deoran-old-mirror.webp
            message=_"What’s going on?! Kalenz, is this normal?"
        [/message]
        {SCROLL_TO 31 20}
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Defeat all enemies"
                condition=win
            [/objective]
            [objective]
                #po: if reduced to 0 hp, Delfador doesn't die. Instead, he's kicked out of the mirror world, and fails the scenario
                description= _ "Loss of Delfador"
                condition=lose
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=100,no
            [/gold_carryover]
            [note]
                description=_"Kalenz and Chantal will not follow you to the next scenario."
            [/note]
            [note]
                description=_"In this strange world, fate guides every strike. <i>(attacks never miss)</i>"
            [/note]
        [/objectives]
        
        {CLEAR_VARIABLE no_spellcasting_event}
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
        
        
        #############################
        # ALLOW HERO DEATHS
        #############################
        # requiring no heroes die makes the scenario less fun to play. Better to allow them to "die", as long as Delfador remains alive
        [remove_event]
            id=herodeath_delfador12,herodeath_deoran,herodeath_kalenz,herodeath_chantal
        [/remove_event]
#define DEATH_BANISH ID MIRROR_ID MESSAGE
        [event]
            name=last breath {FILTER id={ID}}
            [message]
                speaker={ID}
                message={MESSAGE}
            [/message]
            {SOUND skill-illusion-quiet.wav}
            {PUT_TO_RECALL_LIST id={ID}}
            {FULL_HEAL id={ID}}
            {KILL id={MIRROR_ID}} # kill the mirror so that you don't get to hear {ID}'s part of the property if they die
        [/event]
#enddef
        {DEATH_BANISH Deoran  deoran_mirror  _"The mortal world beckons; tell me the rest of the prophecy when next we meet!"}
        {DEATH_BANISH Kalenz  kalenz_mirror  _"Elende, I hope you know what you’re doing. Good luck, the rest of you!"}
        {DEATH_BANISH Chantal chantal_mirror _"Owww! Elende, it’s very rude to banish someone without their permission!"}
        # if your familiar dies, it dies. Delfador summoned it in here, so it doesn't work the same way as the 4 heroes.
        #   also, I'm lazy and don't want to write+test new logic for the familiar
        [event]
            name=last breath {FILTER id=Delfador}
            [message]
                speaker=Delfador
                #po: Delfador has just been reduced to 0hp, and been "kicked out" of Elenede's "mirror realm" or wherever she was giving the prophecy
                message=_"Hey, stop—"
            [/message]

            {SCREEN_FADER 0,0,0 255 0}
            {SOUND door-close.wav}
            {REPLACE_SCENARIO_MUSIC silence.ogg}
            [change_theme]
                theme=Cutscene_Minimal
            [/change_theme]
            
            [replace_map]
                map_file=04d_The_Sylvan_Seer.map
                expand,shrink=yes,yes
            [/replace_map]
            {REMOVE_IMAGE 0-99 0-99}
            [replace_schedule]
                [time]
                    id,name,image=dawn,_"Dawn",misc/time-schedules/default/schedule-dawn.png
                    red,green,blue=-25,-15,0
                [/time]
            [/replace_schedule]
            {SCROLL_TO 10 13}
            
            {RECALL_XY Kalenz   12  8}  {MODIFY_UNIT id=Kalenz   facing se}
            {RECALL_XY Chantal  15  9}  {MODIFY_UNIT id=Chantal  facing sw}
            {RECALL_XY Deoran   11 11}  {MODIFY_UNIT id=Deoran   facing ne}
            {RECALL_XY Delfador 15 11}  {MODIFY_UNIT id=Delfador facing nw}
            {FULL_HEAL id=Delfador}
            
            {DELAY 500}
            [change_theme]
                theme= # back to default
            [/change_theme]
            {SOUND door-close.wav}
            
            {SCREEN_FADER 0,0,0 0 0}
            
            {DELAY 1000}
            [message]
                speaker=Delfador
                #po: Delfador has missed the ending of the prophecy, and the player loses the scenario
                message=_"I didn’t get to finish hearing everything..."
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        [/event]
        
        
        #############################
        # MIRROR VOICELINES
        #############################
        # trigger Kalenz as soon as the mirror takes damage
        [event]
            name=attacker hits {FILTER_SECOND id=kalenz_mirror}
            {FIRE_EVENT elende_speaks_to_kalenz}
        [/event]
        [event]
            name=defender hits {FILTER id=kalenz_mirror}
            {FIRE_EVENT elende_speaks_to_kalenz}
        [/event]
        [event]
            name=elende_speaks_to_kalenz
            {ANIMATE_UNIT   id=kalenz_mirror levelout}
            {TRANSFORM_UNIT id=kalenz_mirror Lich}
            {ANIMATE_UNIT   id=kalenz_mirror levelin}
            [message]
                speaker,image=kalenz_mirror,portraits/lich-mirror.webp
                #po: spoken by Elende (through Kalenz's mirror image), referencing Legend of Wesmere's invisibility potion and Landar
                message=_"Lich’s eye and brother’s bone; what have you sacrificed to save your people, Kalenz? Your greatest fear stands before you... ahead of you?"
            [/message]
            [message]
                speaker,image=Kalenz,portraits/kalenz-mirror.webp
                message=_"That was long ago, Elende! This is about the humans’ story, not mine."
            [/message]
        [/event]
        
        # don't trigger Deoran until the second turn
        [event]
            name=new turn
            [event]
                name=new turn
                [event]
                    name=attacker hits {FILTER_SECOND id=deoran_mirror}
                    {FIRE_EVENT elende_speaks_to_deoran}
                [/event]
                [event]
                    name=defender hits {FILTER id=deoran_mirror}
                    {FIRE_EVENT elende_speaks_to_deoran}
                [/event]
            [/event]
        [/event]
        [event]
            name=last breath {FILTER id=deoran_mirror}
            {FIRE_EVENT elende_speaks_to_deoran}
        [/event]
        [event]
            name=elende_speaks_to_deoran
            [message]
                speaker,image=deoran_mirror,portraits/deoran-sad-mirror.webp
                #po: spoken by Elende (through Deoran's mirror image), referencing his exile. I intend "nation" more in the "people" sense than the "country" sense.
                message=_"Deoran the exile returns home; returns to a nation that scorned him, ignored his counsel and cast him away. What will become of the life he has built amongst the Lintanir’s twilight eaves?"
            [/message]
            [message]
                speaker,image=Deoran,portraits/deoran-old-mirror.webp
                message=_"I know my duty! A captain of Wesnoth will never entertain doubts of loyalty, whether to his country or his King."
            [/message]
        [/event]
        
        # trigger Chantal when the mirror dies
        [event]
            name=last breath {FILTER id=chantal_mirror}
            [message]
                speaker,image=chantal_mirror,portraits/shyde-mirror.webp
                #po: spoken by Elende (through Chantal's mirror image), referencing Cleodil's historic death and foreshadowing Deoran's upcoming death
                message=_"Chantal—"
            [/message]
            [message]
                speaker,image=Chantal,portraits/chantal-druid-mirror.webp
                message=_"I already know what you’re going to say Elende! Don’t you dare; I will when I’m ready."
            [/message]
            [message]
                speaker,image=chantal_mirror,portraits/shyde-mirror.webp
                message=_"Then you may soon understand some measure of your grandfather’s bygone sorrows..."
            [/message]
        [/event]
        
        
        #############################
        # DELFADOR MIRROR MACROS
        #############################
#define CREATE_DELFADOR X Y EXTRA_WML SPELL1_HELPTEXT SPELL2_HELPTEXT
        [store_unit]
            {FILTER x,y={X},{Y}}
            variable,kill=stored_unit,yes
        [/store_unit]
        [unit]
            {SINGLEUNITWML_DELFADOR}
            {MODIFICATIONS(
                [object] {EFFECT new_ability( [abilities]
                    [dummy]
                        {SPELL1_HELPTEXT}
                    [/dummy]
                    [dummy]
                        {SPELL2_HELPTEXT}
                    [/dummy]
                [/abilities] )} [/object]
            )}
            x,y={X},{Y}
            {EXTRA_WML}
        [/unit]
        [if] {VARIABLE_CONDITIONAL stored_unit.length greater_than 0} {THEN(
            [unstore_unit]
                variable=stored_unit
                find_vacant,animate=yes,no
            [/unstore_unit]
        )} [/if]
        {SOUND skill-illusion-quiet.wav}
        {ANIMATE_UNIT x,y={X},{Y} post_teleport}
        {DELAY 500}
#enddef
#define CREATE_MINION SIDE TYPE X Y
        [store_unit]
            {FILTER x,y={X},{Y}}
            variable,kill=stored_unit,yes
        [/store_unit]
        {GENERIC_UNIT {SIDE} {TYPE} {X} {Y}} {ANIMATE} {PASSABLE} {ADD_MODIFICATION ([object]{MIRROR_EFFECTS}[/object])}
        [if] {VARIABLE_CONDITIONAL stored_unit.length greater_than 0} {THEN(
            [unstore_unit]
                variable=stored_unit
                find_vacant,animate=yes,no
            [/unstore_unit]
        )} [/if]
#enddef
#define CAST_EVERY_TURN ID XP SKILL
        [event]
            name=side 2 turn refresh
            first_time_only=no
            {FILTER_CONDITION( {HAVE_UNIT( id,formula={ID},"(self.experience>={XP})" {NOT status=petrified} )} )}
            [modify_unit]
                {FILTER id={ID}}
                experience=$( $this_unit.experience - {XP})
            [/modify_unit]
            {MIMIC_DELFADOR {ID} ({FIRE_EVENT {SKILL}})}
        [/event]
#enddef
        
        #############################
        # L1 DELFADOR MIRROR
        #############################
        [event]
            name=die,turn end {FILTER_CONDITION( {NOT( {HAVE_UNIT(id=kalenz_mirror,deoran_mirror,chantal_mirror)} )} )}
            [event]
                name=new turn
                [message]
                    speaker,image=narrator,portraits/elende-mirror.webp
                    caption=_"Elende"
                    #po: Elende reaveals that she's the one who gave the weird prophecy thing to Delfador at Alduin, even though she wasn't physically there
                    message=_"And what of the fire mage? Young but ambitious, brilliant yet foolish. It has been many moons since I spoke to you at Alduin."
                [/message]
                [message]
                    speaker,image=Delfador,portraits/younger_delfador-mirror.webp
                    message=_"That was you, back at graduation? I knew I heard a voice! Master Hudell thought I was going crazy..."
                [/message]
                {CREATE_DELFADOR 40 21 (side,type,experience,id,name=2,Delfador L1,25,delfador_mirror1,_"Delfador") 
                                       (name,description=levitate,_"Spend 8 mana to gain flight and the skirmisher ability until the start of your next turn or until cancelled.") ()}
                {MIMIC_DELFADOR delfador_mirror1 (
                    {VARIABLE skill_magic_missile   yes}
                    {VARIABLE skill_levitate        yes}
                    {FIRE_EVENT refresh_delfador_skills}
                    {GIVE_OBJECT_TO id=Delfador {MIRROR_EFFECTS}} )}
                [if] {VARIABLE_CONDITIONAL side_number equals 2}{THEN(  {MODIFY_UNIT side=2 moves 0}  {MODIFY_UNIT side=2 attacks_left 0}  )}[/if]
                {CAST_EVERY_TURN delfador_mirror1 8 skill_levitate}
                {MODIFY_SIDE_AI (2) ([avoid] # don't end our turn levitating over impassable terrain, or we'd fall to our deaths
                    terrain=Q*^*
                [/avoid])}
            [/event]
        [/event]
        
        
        #############################
        # L2 DELFADOR MIRROR
        #############################
        [event]
            name=last breath {FILTER id=delfador_mirror1}
            {RESET_ENEMY_AI}
            [message]
                speaker,image=delfador_mirror1,portraits/younger_delfador-mirror.webp
                #po: pale spy meaning Asheviere. Referencing Asheviere resolving to kill Garard, and working with orcs to arrange the events of the next two scenarios
                message=_"I see secrets in the dark; a pale spy slips their bonds. A death, a deceiver. Ringed swords, cold blood, false friends."
            [/message]
            [event]
                name=new turn
                {CREATE_DELFADOR 26 22 (side,type,experience,id,name=3,Delfador L2,45,delfador_mirror2,_"Delfador") () ()}
                {MIMIC_DELFADOR delfador_mirror2 (
                    {VARIABLE skill_animate_mud yes}
                    {VARIABLE skill_chill_touch yes} # this prevents him from being one-shot by a charging roc delfador
                    {VARIABLE skill_glamour     yes}
                    {FIRE_EVENT refresh_delfador_skills}
                    {GIVE_OBJECT_TO id=Delfador {MIRROR_EFFECTS}} )}
                {CREATE_MINION 3 (Mudcrawler)       26 21}
                {CREATE_MINION 3 (Giant Mudcrawler) 27 22} # giant mudcrawlers are fast enough that mirror_delfador isn't exposed on the first turn
                {CREATE_MINION 3 (Giant Mudcrawler) 27 23}
                {CREATE_MINION 3 (Mudcrawler)       26 23}
                {CREATE_MINION 3 (Mudcrawler)       25 24}
                
                # sit back and lead, until most of our mudcrawlers are dead
                {DISABLE_ATTACKING 2}
                {MODIFY_SIDE_AI 2 ({GOAL_SEEK_SIDE 99 1 2})}
                {MODIFY_SIDE_AI 2 ([avoid]
                    {FILTER side=1} radius=1
                [/avoid])}
                {SILENTLY_LIMIT_MOVES 2 id=delfador_mirror2 4} # otherwise we run in ahead of the mudcrawlers
                [event]
                    name=side 2 turn
                    {FILTER_CONDITION( {NOT( {HAVE_UNIT count,type_adv_tree=2-99,Mudcrawler} )} )}
                    {RESET_ENEMY_AI}
                [/event]
                
                # we're normally on the same side as the mudcrawlers (so leadership applies),
                # but only act on side 2's turn so that we always move first
                [event]
                    name=side 2 turn
                    first_time_only=no
                    {MODIFY_UNIT id=delfador_mirror2 side 2}
                [/event]
                [event]
                    name=side 3 turn refresh
                    first_time_only=no
                    {MODIFY_UNIT id=delfador_mirror2 side 3}
                [/event]
            [/event]
        [/event]
        
        
        #############################
        # L3 DELFADOR MIRROR
        #############################
        [event]
            name=last breath {FILTER id=delfador_mirror2}
            {KILL type_adv_tree=Mudcrawler}
            [message]
                speaker,image=delfador_mirror2,portraits/younger_delfador-mirror.webp
                #po: referencing Delfador's adventures in scenarios 8-10, where he works with (or kills) poachers to fight saurians, then fights undead and a ghost given the appearance of a living drake.
                message=_"The dark swamp looms. Purses and poachers, mirror and smoke. A figure of shadow cloaked in the spirits of the dead. Battles won while wars are lost."
            [/message]
            [event]
                name=new turn
                {CREATE_DELFADOR 36 21 (side,type,experience,id,name=2,Delfador L3,65,delfador_mirror3,_"Delfador")
                                       (name,description=counterspell,_"Spend 16 mana to disallow magical attacks in a 3-hex radius, until cancelled.") ()}
                {MIMIC_DELFADOR delfador_mirror3 (
                    {VARIABLE skill_magic_missile   yes} # to demonstrate that counterspell works on allied spells too
                    {VARIABLE skill_chill_touch     yes}
                    {VARIABLE skill_dancing_daggers yes}
                    {VARIABLE skill_counterspell    yes}
                    {FIRE_EVENT refresh_delfador_skills}
                    {FIRE_EVENT skill_counterspell}
                    {GIVE_OBJECT_TO id=Delfador {MIRROR_EFFECTS}} )}
            [/event]
        [/event]
        
        
        #############################
        # L4 DELFADOR MIRROR
        #############################
        [event]
            name=last breath {FILTER id=delfador_mirror3}
            [message]
                speaker,image=delfador_mirror3,portraits/younger_delfador-mirror.webp
                #po: referencing the civil war when Asheviere takes power
                message=_"Brother against brother, father against child. From the barren throne will rise an angel of ashes; both great and terrible alike. The delicate balance of mankind will be broken, and flames shall blaze anew across the embers of Haldric’s people."
            [/message]
            [event]
                name=new turn
                {CREATE_DELFADOR 25 26 (side,type,experience,id,name=2,Delfador L4,60,delfador_mirror4,_"Delfador")
                                       (name,description=time dilation,_"Spend 48 mana to grant yourself and all allies double movement and a second attack this turn. When this turn ends, affected units become slowed.")
                                       (name,description=levitate,_"Spend 8 mana to gain flight and the skirmisher ability until the start of your next turn or until cancelled.")}
                {MIMIC_DELFADOR delfador_mirror4 (
                    {VARIABLE skill_levitate      yes}
                    {VARIABLE skill_fireball2     yes}
                    {VARIABLE skill_animate_fire  yes}
                    {VARIABLE skill_time_dilation yes}
                    {FIRE_EVENT refresh_delfador_skills}
                    {GIVE_OBJECT_TO id=Delfador {MIRROR_EFFECTS}} )}
                {CREATE_MINION 2 (Fire Guardian) 22 25}
                {CREATE_MINION 2 (Fire Guardian) 27 27}
                {CREATE_MINION 2 (Fire Guardian) 28 24}
                [event]
                    name=side 1 turn end
                    [event]
                        name=side 2 turn refresh
                        [modify_unit]
                            {FILTER id=delfador_mirror4}
                            experience=$( $this_unit.experience - 8) # yes, yes, levitate+dilation ignores the one-spell-per-turn rule. This is complicated enough already; I don't care.
                        [/modify_unit]
                        {MIMIC_DELFADOR delfador_mirror4 ({FIRE_EVENT skill_levitate})}
                        
                        # manually move off our island
                        # he's on an island to prevent spawn-camping, but the AI likes to end its turns over void
                        # and if I put in an avoid he struggles to move off the island at all unless there's enemies in range
                        # plus, an avoid hurts behavior of the fire guardian
                        # the player can control max 5 units (4 heroes + familiar), so at least 1 of these hexes is guaranteed to be open
                        [if]         {NOT({HAVE_UNIT x,y=25,24})} {THEN( {MOVE_UNIT id=delfador_mirror4 25 24} {MODIFY_UNIT id=delfador_mirror4 moves 3} )}
                            [elseif] {NOT({HAVE_UNIT x,y=26,23})} {THEN( {MOVE_UNIT id=delfador_mirror4 26 23} {MODIFY_UNIT id=delfador_mirror4 moves 2} )} [/elseif]
                            [elseif] {NOT({HAVE_UNIT x,y=26,22})} {THEN( {MOVE_UNIT id=delfador_mirror4 26 22} {MODIFY_UNIT id=delfador_mirror4 moves 0} )} [/elseif]
                            [elseif] {NOT({HAVE_UNIT x,y=27,23})} {THEN( {MOVE_UNIT id=delfador_mirror4 27 23} {MODIFY_UNIT id=delfador_mirror4 moves 1} )} [/elseif]
                            [elseif] {NOT({HAVE_UNIT x,y=28,22})} {THEN( {MOVE_UNIT id=delfador_mirror4 28 22} {MODIFY_UNIT id=delfador_mirror4 moves 0} )} [/elseif]
                            [elseif] {NOT({HAVE_UNIT x,y=25,22})} {THEN( {MOVE_UNIT id=delfador_mirror4 25 22} {MODIFY_UNIT id=delfador_mirror4 moves 0} )} [/elseif]
                        [/if]
                        {REMOVE_OBJECT skill_levitate id=delfador_mirror4}
                        
                        # cast time dilation when appropriate (only once)
                        [event]
                            name=side 3 turn
                            {FILTER_CONDITION( {HAVE_UNIT( id=delfador_mirror4 {NOT status=petrified} )} )}
                            {FILTER_CONDITION(                   {HAVE_UNIT(side,count=2,3-99 {FILTER_LOCATION( radius=5 {FILTER(side=1)} )} )}    # dilate when at least 3 of our untis are in range
                                {OR( {HAVE_UNIT(side,count=2,2)} {HAVE_UNIT(side,count=2,2    {FILTER_LOCATION( radius=5 {FILTER(side=1)} )} )} )} # or we only have 2 units, and they're both in range
                                {OR( {HAVE_UNIT(side,count=2,1)} {HAVE_UNIT(side,count=1,1    {FILTER_LOCATION( radius=5 {FILTER(side=1)} )} )} )} # or we only have 1 unit, and it's in range
                            )}
                            {MIMIC_DELFADOR delfador_mirror4 ({FIRE_EVENT skill_time_dilation})}
                            [modify_unit]
                                {FILTER id=delfador_mirror4}
                                experience=$( $this_unit.experience - 48)
                            [/modify_unit]
                            [store_unit]
                                {FILTER( id=delfador_mirror4 )}
                                mode,variable=append,time_dilation_units # delfador_mirror4 gets removed from this array when his ID changes
                            [/store_unit]
                            {CLEAR_VARIABLE time_dilation_units[0]} # this is our regular human delfador, so remove it
                            
                            # time dilation implementation
                            [event]
                                name=side 3 turn refresh
                                {MODIFY_UNIT side=2 side 3}
                                [event]
                                    name=side 3 turn end
                                    {MODIFY_UNIT side=3 side 2}
                                    {CAST_EVERY_TURN delfador_mirror4 8 skill_levitate}
                                [/event]
                            [/event]
                        [/event]
                    [/event]
                [/event]
                {RESET_ENEMY_AI}
            [/event]
        [/event]
        
        
        #############################
        # FINAL SPEECH
        #############################
        [event]
            name=last breath {FILTER id=delfador_mirror4}
            {KILL (type_adv_tree=Fire Guardian)}
            [message]
                speaker,image=delfador_mirror4,portraits/younger_delfador-mirror.webp
                #po: referncing the future events of HttT; Konrad and Li'Sar retriving the sceptre of fire
                message=_"Black soot rains over Weldyn. The line of kings sundered; the sceptre of the wesfolk restored. The nameless son and the ashen daughter."
            [/message]
            {KILL id=delfador_mirror4 ANIMATE=yes}
            {DELAY 500}
            [message]
                speaker,image=narrator,portraits/elende-mirror.webp
                caption=_"Elende"
                #po: referencing Delfador's choice in S10x
                message=_"But this fate is not the only path. Mage of Alduin, you stand at a knot in the strands, a nexus of the shards. For one brief moment, you will possess the power to alter the currents of time; to rewrite the future that is written."
            [/message]
            [message]
                speaker,image=narrator,portraits/elende-mirror.webp
                caption=_"Elende"
                #po: referencing Delfador's choice in S10x. He can either listen to a drunk Garard and kill Garard's brother Arand based on false reports of a betrayal, or refuse, stay with Garard, and find out more about Arand before attacking
                message=_"When that moment comes, remember... endeavor to bestow not destruction with that fire that you possess, but the gleaming light of truth instead. Quench the flames of fear before all your world is consumed."
            [/message] # but the gleaming light of truth instead  # but the kindling warmth of compassion instead
            [message]
                speaker,image=Delfador,portraits/younger_delfador-mirror.webp
                message=_"But, what? I don’t understa—"
            [/message]
            {FIRE_EVENT play_ending}
        [/event]
    [/event]
        
    
    
    
    
    #######################################################################################################################################################
    #                                                                  VICTORY CUTSCENE
    #######################################################################################################################################################
    [event]
        name=play_ending
        
        {SCREEN_FADER 0,0,0 255 0}
        {SOUND door-close.wav}
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [change_theme]
            theme=Cutscene_Minimal
        [/change_theme]
        [if] {HAVE_UNIT id=familiar} {THEN(
            [store_unit] # only do this if the familiar actually exists, otherwise we overwrite the variable
                {FILTER id=familiar}
                variable,kill=stored_familiar,yes
            [/store_unit]
        )} [/if]
        {PUT_TO_RECALL_LIST side=1} # before changing the map
        [replace_map]
            map_file=04d_The_Sylvan_Seer.map
            expand,shrink=yes,yes
        [/replace_map]
        {REMOVE_IMAGE 0-99 0-99}
        [replace_schedule]
            [time]
                id,name,image=dawn,_"Dawn",misc/time-schedules/default/schedule-dawn.png
                red,green,blue=-25,-15,0
            [/time]
        [/replace_schedule]
        {SCROLL_TO 10 13}
        
        {RECALL_XY Kalenz   12  8}  {MODIFY_UNIT id=Kalenz   facing se}
        {RECALL_XY Chantal  15  9}  {MODIFY_UNIT id=Chantal  facing sw}
        {RECALL_XY Deoran   11 11}  {MODIFY_UNIT id=Deoran   facing ne}
        {RECALL_XY Delfador 15 11}  {MODIFY_UNIT id=Delfador facing nw}
        
        {DELAY 500}
        [change_theme]
            theme= # back to default
        [/change_theme]
        {SOUND door-close.wav}
        
        {SCREEN_FADER 0,0,0 0 0}
        
        [message]
            speaker=Delfador
            #po: Delfador previously said "But, what? I don’t understa—", but has now been kicked out of Elende's 'mirror world' and is back in the normal world. The scenario is over.
            message=_"-nd what you’re saying..."
        [/message]
        {DELAY 2000}
        
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 100}
        [/endlevel]
    [/event]
    
    {HERODEATHS}
[/scenario]






