#textdomain wesnoth-tdg


#define TURN_LIMIT
70#enddef

[scenario]
    id,map_file,name=10_Houses_of_the_Dead,10_Houses_of_the_Dead.map,_"Houses of the Dead"
    next_scenario,victory_when_enemies_defeated=10x_Elensefar_Outskirts,no
    {UNDERGROUND} turns={TURN_LIMIT}
    current_time=3
          {SCENARIO_MUSIC the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}
    {EXTRA_SCENARIO_MUSIC suspense.ogg}
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,0
        team_name,user_team_name=wesnoth,_"Delfador"
        income,village_gold=-2,0
        fog,shroud=yes,yes
        {FLAG_VARIANT loyalist}
    [/side]
    
    #############################
    # UNDEAD
    #############################
    [side]
        side,controller,color=2,ai,white
        no_leader,hidden=yes,yes
        team_name,user_team_name=undead,_"Omaranth’s Flight"
        {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=side 2 turn
        first_time_only=no
        {RESET_SIDE_AI  2 no 0.99 0.01}
        {MODIFY_SIDE_AI 2 retreat_factor=0}
    [/event]
    
    #############################
    # FAUNA
    #############################
    [side]
        side,controller,color=3,ai,green
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=fauna,_"Fauna"
        {FLAG_VARIANT6 ragged}
    [/side]
    [event]
        name=side 3 turn
        first_time_only=no
        {RESET_SIDE_AI  3 no 0.99 0.01}
        {MODIFY_SIDE_AI 3 retreat_factor=0}
    [/event]
    
    [side]
        side,controller,color=4,ai,white
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name=wesnoth
        {FLAG_VARIANT6 ragged}
    [/side]
    
    
    
    
    #######################################################################################################################################################
    #                                                                    ENTRYWAY
    #######################################################################################################################################################
    [event]
        name=prestart
        {PLACE_IMAGE "items/bones.png" 11 29}
        {GENERIC_UNIT 3 (Giant Rat) 11 29} {GUARDIAN}
        {GENERIC_UNIT 3 (Giant Rat) 12 30} {GUARDIAN}
        {GENERIC_UNIT 3 (Giant Rat)  7 26} {GUARDIAN}
        [unit]
            {SINGLEUNITWML_OMARANTH}
            x,y,facing,animate=6,31,se,yes
        [/unit]
        {SCROLL_TO 1 37} # bottom-left-hand corner, with a lot of empty space. This stops the portraits from [message]s in the initial cutscene from covering up Delfador/Omaranth
    [/event]
    #############################
    # INITIAL CUTSCENE
    #############################
    [event]
        name=start
        # store Delfador's skills.
        # 1) this lets the player delay until they've verified they're fighting undead, and
        # 2) this means we don't have to worry about the player being polymorphed/counterspelling when they meet the first ghost
        {STORE_SKILLS}
        {VARIABLE skill_fireball3 yes}
        {FIRE_EVENT refresh_delfador_skills}
        
        [message]
            speaker,caption,image=Omaranth,"",wesnoth-icon.png # can't use narrator unless I recall Delfador
            #po: notice that appears at the beginning of the scenario if you select Brutal difficulty
            message=_"Meanwhile..."
        [/message]
        
        #############################
        # OMARANTH FLEES INTO THE CAVES
        #############################
        {DELAY 250}
        {RECALL_XY    Delfador 1 32} {REFRESH_FOG} {DELAY 250}
        {MOVE_UNIT id=Delfador 2 31} {REFRESH_FOG}
        {MOVE_UNIT id=Delfador 3 32} {REFRESH_FOG}
        {MOVE_UNIT id=Delfador 4 31} {REFRESH_FOG} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"Stand and fight me, drake! You and your saurians have caused Wesnoth enough harm. In the name of King Garard, I’m ending it here and now!"
        [/message]
        [message]
            speaker=Omaranth
            message=_"..."
        [/message]
        {MOVE_UNIT id=Omaranth 9 30}
        {KILL id=Omaranth}
        {DELAY 750}
        [message]
            speaker=Delfador
            message=_"...I suppose we’ll have to do this the hard way."
        [/message]
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find Omaranth"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()}
    [/event]
    
    
    
    
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    ANTECHAMBER
    #######################################################################################################################################################
#define DRAKE_HALO X Y HALO
    [item]
        x,y={X},{Y}
        halo=units/drakes/{HALO}~GS()~CS(-75,-75,-50)
        visible_in_fog=no
    [/item]
#enddef
#define DRAKE_ITEM X Y IMG
    [item]
        x,y={X},{Y}
        image=units/drakes/{IMG}~GS()~CS(-25,-500,-500)
        visible_in_fog=no
    [/item]
#enddef
#define COFFIN X Y
    {PLACE_IMAGE "items/coffin-closed.png~CS(-50,-100,-150)" {X} {Y}}
#enddef
#define COFFIN_EMERGE X Y TYPE
    {REMOVE_IMAGE {X} {Y}}
    {PLACE_IMAGE "items/coffin-open.png~CS(-50,-100,-150)" {X} {Y}}
    {GENERIC_UNIT 2 {TYPE} {X} {Y}} {ANIMATE} {VARIATION drake}
#enddef
    #############################
    # PRESTART
    #############################
    [event]
        name=prestart
        {COFFIN  9 23}
        {COFFIN 10 22}
        {COFFIN 11 22}
        {COFFIN 13 25}
        {COFFIN 14 24}
        {COFFIN 15 24}
        {DRAKE_ITEM  8 23 "enforcer-blade-2.png"}
        {DRAKE_ITEM 12 25 "glider-kick-5.png"}
        {DRAKE_HALO 15 20 "enforcer-blade-2.png~FL()"}
        {DRAKE_HALO 19 22 "blademaster-fire-se-2.png~FL()"}
        {DRAKE_HALO 16 21 "flare-lead-2.png~FL()"}
    [/event]
    #############################
    # FORESHADOWING
    #############################
    [event] 
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=14,24,4} )}
        [event]
            name=side 1 turn end
            [message]
                speaker=Delfador
                message=_"A drakish tomb? This looks ominous..."
            [/message]
        [/event]
    [/event]
    
    #############################
    # FIRST GHOST APPEARS
    #############################
    [event]
        name=capture
        {FILTER side=1}
        [event]
            name=new turn
            [event]
                name=enter hex
                {FILTER side=1}
                [cancel_action][/cancel_action]
                {FIRE_EVENT trigger_first_ghost}
            [/event]
        [/event]
    [/event]
    [event]
        name=enter hex
        {FILTER( side=1 {FILTER_LOCATION(
            x=13,14,15,16,17
            y=21,21,22,22,23 )} )}
        [cancel_action][/cancel_action]
        {FIRE_EVENT trigger_first_ghost}
    [/event]
    [event]
        name=trigger_first_ghost
        
        {SOUND zombie-attack.wav}
        
        {COFFIN_EMERGE 11 22 "Walking Corpse"}
        {COFFIN_EMERGE 10 22 "Walking Corpse"}
#ifndef EASY
        {COFFIN_EMERGE 13 25 "Soulless"}
        {COFFIN_EMERGE 15 24 "Walking Corpse"}
#endif
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none" "Walking Corpse" "Walking Corpse"}) 18 21 ({ANIMATE} {VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none" "Walking Corpse" "Walking Corpse"}) 17 21 ({ANIMATE} {VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none" "none" "Soulless"       "Soulless"      }) 16 20 ({ANIMATE} {VARIATION drake})}
        
        # maybe the same Aethyr from TRoW, maybe just a coincidence
        # spawn him out of sight, and have him run straight towards Delfador
        {NAMED_UNIT 2 Wraith 27 16 Aethyr "" (facing=sw)}
    [/event]
    
    #############################
    # CONVERT AETHYR
    #############################
    [event]
        name=sighted
        {FILTER id=Aethyr}
        {FILTER_SECOND side=1}
        [event]
            name=new turn,side 1 turn end
            {FIRE_EVENT convert_aethyr}
        [/event]
    [/event]
    [event]
        name=moveto
        {FILTER_CONDITION({HAVE_UNIT( id=Delfador {FILTER_ADJACENT id=Aethyr} )})}
        {FIRE_EVENT convert_aethyr}
    [/event]
    [event]
        name=convert_aethyr
        [message]
            speaker=Delfador
            message=_"Walking corpses are a great evil, but mastery over spirits is far fouler still. Damned vessels, conscious but enslaved... but where there are enchantments, there are opportunities."
        [/message]
        {FIRE_EVENT remove_polymorph}
        {FIRE_EVENT skill_counterspell_cancel}
        {STORE_UNIT_VAR id=Aethyr x x}
        {STORE_UNIT_VAR id=Aethyr y y}
        {MOVE_UNIT id=Delfador $x "$($y+1)"}
        {CLEAR_VARIABLE x,y}
        [message]
            speaker=Delfador
            message=_"I must concentrate. The slightest mistake in the casting of this spell could be fatal."
        [/message]
        {DELAY 750}
        {ANIMATE_UNIT id=Delfador skill_blizzard}
        {GIVE_OBJECT_TO id=Delfador (id=skill_blizzard_animation) }
        {SOUND lightning.ogg} {DELAY 50}
        {COLOR_ADJUST  200  100  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        {SOUND lightning.ogg} {DELAY 50}
        {COLOR_ADJUST  100  200  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        {SOUND lightning.ogg} {DELAY 50}
        {COLOR_ADJUST  100  100  200} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"I call upon the name of An-Usrukhar the Great. I invoke the Mirror of Evanescent Time."
        [/message]
        {SOUND lightning.ogg} {DELAY 50}
        {COLOR_ADJUST  100  200  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"I challenge life against death! I invoke chaos against order! I wield light against darkness!"
        [/message]
        {SOUND lightning.ogg} {DELAY 50}
        {COLOR_ADJUST  200  100  100} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        [message]
            speaker=Delfador
            message=_"May the coils of servitude be broken! Spirit of the damned, be freed from your master."
        [/message]
        {REMOVE_OBJECT skill_blizzard_animation id=Delfador}
        {ANIMATE_UNIT id=Delfador skill_blizzard_end}
        {DELAY 250}
        
        #############################
        # AETHYR SPEAKS
        #############################
        {MODIFY_UNIT id=Aethyr side 4}
        {DELAY 250}
        [message]
            speaker=Aethyr
            message=_"..."
        [/message]
        [message]
            speaker=Aethyr
            message=_"My mind... is my own..."
        [/message]
        [message]
            speaker=Delfador
            message=_"Speak, spectre! Tell me of this place. Where is the drake they call the “Great One”?"
        [/message]
        {MODIFY_UNIT id=Aethyr name _"Aethyr"}
        [message]
            speaker=Aethyr
            message=_"I do not know. I know nothing of drakes. I am a man. My name is Aethyr... but I died long ago, in a great battle. I have almost forgotten..."
        [/message]
        [message]
            speaker=Delfador
            message=_"You are the spirit of a human? How did you come to roam these drakish halls, so far from the lands of men?"
        [/message]
        [message]
            speaker=Aethyr
            message=_"Iliah-Malal brought me here. He made me promises of life renewed, but instead bound me to his will. Perhaps Iliah-Malal will know of your drake."
        [/message]
        [message]
            speaker=Delfador
            message=_"A necromancer? That explains things. Yes, I should very much like to meet this Iliah-Malal."
        [/message]
        {MODIFY_UNIT id=Aethyr side 1}
        {FIRE_EVENT restore_polymorph}
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Find Iliah-Malal or Omaranth"
                condition=win
            [/objective]
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            [note]
                description= _ "Delfador can capture hostile ghosts by moving adjacent to them, if not polymorphed."
            [/note]
        [/objectives]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   EXIT / THE SUN
    #######################################################################################################################################################
    #############################
    # PRESTART
    #############################
    [event]
        name=prestart
        {GENERIC_UNIT 2 "Walking Corpse" 3 18} {VARIATION drake} {ROLE sun3} {ZONE_GUARDIAN 3 13 (x,y=1,1)}
        {GENERIC_UNIT 2 "Walking Corpse" 4 17} {VARIATION drake} {ROLE sun1} {ZONE_GUARDIAN 4 17 (x,y=1,1)} # zone_guardian prevents them from moving
        {GENERIC_UNIT 2 "Soulless"       6 17} {VARIATION drake} {ROLE sun2} {ZONE_GUARDIAN 6 17 (x,y=1,1)}
    [/event]
    #############################
    # DELFADOR APPROACHES
    #############################
    [event]
        name=moveto
        {FILTER( side=1 {FILTER_LOCATION x,y,radius=5,18,4} )}
        
        {REVEAL x,y,radius=2,18,5}
        {SCROLL_TO 2 18}
        {DELAY 250}
        {MOVE_UNIT role=sun1 1 19} {KILL role=sun1}
        {MOVE_UNIT role=sun2 1 19} {KILL role=sun2}
        {MOVE_UNIT role=sun3 1 19} {KILL role=sun3}
        {DELAY 500}
        
        {STORE_UNIT_VAR side,type_adv_tree=1,Ghost id   sun_id}
        {STORE_UNIT_VAR side,type_adv_tree=1,Ghost name sun_name}
        [if] {HAVE_UNIT side,id=1,$sun_id}
            [then]
                [message]
                    id=$sun_id
                    message=_"A passage to the world above! Oh, how I long to go through and see the sun again..."
                [/message]
                [message]
                    speaker=Delfador
                    message=_"Focus, $sun_name. Iliah-Malal must have raised these corpses and sent them against my allies on the surface — if you and I delay too long, they will assuredly be overrun."
                [/message]
            [/then]
        [/if]
        {CLEAR_VARIABLE sun_id,sun_name}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                      MUSHROOMS
    #######################################################################################################################################################
#define GHOST_CAPTURE_EVENT GHOST_ID WML
    [event]
        # trigger this if Delfador  moves adjacent to a ghost, Delfador starts his turn adjacent to a ghost, or we cancel polymorph while adjacent to a ghost
        name=new turn,moveto,skill_polymorph_stoat_cancel,skill_polymorph_bear_cancel,skill_polymorph_crab_cancel,skill_polymorph_roc_cancel
        {FILTER_CONDITION({VARIABLE_CONDITIONAL $side_number equals 1})}
        {FILTER_CONDITION({HAVE_UNIT( id,race=Delfador,human {FILTER_ADJACENT id={GHOST_ID}} )})}
        
        {FIRE_EVENT skill_counterspell_cancel} # it's not great to waste the player's XP like this, but counterspell is 100% useless in this scenario anyway
        {SOUND lightning.ogg} {DELAY 50}
        {COLOR_ADJUST  100  100  200} {DELAY 150}
        {COLOR_ADJUST    0    0    0} {DELAY 250}
        {MODIFY_UNIT id={GHOST_ID} side 4}
        {DELAY 250}
        {WML}
        {MODIFY_UNIT side,id=4,{GHOST_ID} side 1} # don't change side if {WML} has made the ghost hostile
    [/event]
#enddef
    #############################
    # PRESTART
    #############################
    [event]
        name=prestart
        {NAMED_UNIT 2 Ghost 10 11 Sythan _"Sythan" ()} {GUARDIAN}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 9 15 ({GUARDIAN}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 8 13 ({GUARDIAN}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 9 13 ({GUARDIAN}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 12 9 ({GUARDIAN}{VARIATION drake})}  
    [/event]
    {GHOST_CAPTURE_EVENT Sythan (
        [message]
            speaker=Sythan
            message=_"I was once a great lord... I commanded armies! Iliah-Malal promised I would lead again."
        [/message]
        [message]
            speaker=Sythan
            message=_"It was all a lie. I became only his slave."
        [/message]
    )}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    WATER / FLOODED
    #######################################################################################################################################################
    [event]
        name=prestart
        {NAMED_UNIT 2 Ghost 17 5 VellinKa _"Vellin Ka" ()} {GUARDIAN} {GENDER female}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 19 11 ({GUARDIAN}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 21  9 ({GUARDIAN}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 23 11 ({GUARDIAN}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 18 10 ({GUARDIAN}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 16  8 ({GUARDIAN}{VARIATION swimmer})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 17  8 ({GUARDIAN}{VARIATION swimmer})}
        {PLACE_IMAGE scenery/gate-rusty-sw.png 21 4}
    [/event]
    {GHOST_CAPTURE_EVENT VellinKa (
        [message]
            speaker=VellinKa
            message=_"Your banners were red.
Your spears were sharp.
Your hearts were cold."
        [/message]
        [message]
            speaker=VellinKa
            message=_"Iliah-Malal led your army.
Iliah-Malal burned our Eyrie.
Iliah-Malal will die."
        [/message]
        [message]
            speaker=Delfador
            message=_"Iliah-Malal fought you with an army of living men? And what of the drake Omaranth; how did he survive if the rest of you did not?"
        [/message]
        [message]
            speaker=VellinKa
            message=_"Omaranth was Dominant in our Eyrie.
Omaranth was strongest of our Flight.
Omaranth’s fate was not seen by I."
        [/message]
    )}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                      SOUTHEAST
    #######################################################################################################################################################
    [event]
        name=prestart
        {NAMED_UNIT 2 Wraith 31 21 HaghaTan _"Hagha-Tan" ()} {GUARDIAN}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 33 17 ({GUARDIAN}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 30 16 ({GUARDIAN}{VARIATION drake})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 35 19 ({GUARDIAN}{VARIATION drake})}
    [/event]
    {GHOST_CAPTURE_EVENT HaghaTan (
        [message]
            speaker=HaghaTan
            message=_"The chief called me to war... I knew the attack was risky, but I was willing..."
        [/message]
        [message]
            speaker=Delfador
            message=_"If you’re a recently-dead orc, what can you tell me about battle plans? Troop movements? Wesnoth can use any help we can get."
        [/message]
        {MODIFY_UNIT id=HaghaTan side 2}
        [message]
            speaker=HaghaTan
            message=_"You are no lord of mine, man of Wesnoth. I am loyal only to my clan."
        [/message]
    )}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                        LAVA
    #######################################################################################################################################################
    # this one needs to be lured out onto solid land, so Delfador can convert her
    [event]
        name=prestart
        {NAMED_UNIT 2 Shadow 23 24 Melinna _"Melinna" ()} {GUARDIAN} {GENDER female}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "Walking Corpse" "Walking Corpse" "Soulless"       "Soulless"      }) 26 20 ({GUARDIAN}{VARIATION bat})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "Walking Corpse" "Walking Corpse" "Walking Corpse"}) 25 20 ({GUARDIAN}{VARIATION bat})}
        {GENERIC_UNITC 2 ({ON_DIFFICULTY4 "none"           "none"           "Walking Corpse" "Walking Corpse"}) 24 21 ({GUARDIAN}{VARIATION bat})}
    [/event]
    {GHOST_CAPTURE_EVENT Melinna (
        [message]
            speaker=Delfador
            message=_"Are you a drake? Do you know anything about Omaranth, or this new Iliah-Malal?"
        [/message]
        [message]
            speaker=Melinna
            message=_"I know only what I knew in life, Delfador. Yes, I recognize you... Garard’s famous attack dog..."
        [/message]
        [message]
            speaker=Melinna
            message=_"I was once a lady of the court. I only wanted to make peace, to stop the fighting."
        [/message]
        [message]
            speaker=Melinna
            message=_"But the dead found me in the night. Now I find myself here, in a form reflecting my fate. Why did they hunt me? Why didn’t you keep us all safe..."
        [/message]
    )}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                  VICTORY / DEFEAT
    #######################################################################################################################################################
    #############################
    # OMARANTH DIES
    #############################
    [event]
        name=lorem_ipsum
        
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    {HERODEATHS}
[/scenario]





