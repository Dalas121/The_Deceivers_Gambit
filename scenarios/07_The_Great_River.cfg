#textdomain wesnoth-tdg

# give the player extra time on lower difficulties, instead of removing lots of guards
# having enough guards to be meaningful makes the scenario more fun
#undef TURNS
#define TURNS
    25#enddef
#define TURNS_LOW_WARNING
    20#enddef
#define TURNS2
    35#enddef
#define TURNS2_LOW_WARNING
    32#enddef

[scenario]
    id,map_file,name=07_The_Great_River,07_The_Great_River.map,_"The Great River"
    next_scenario,victory_when_enemies_defeated=07x_Weldyn_Court,no
    {DAWN_HOUR}       {DAWN_HOUR}
    {DAWN_HOUR}       {DAWN_HOUR}
    {MORNING_HOUR1}   {MORNING_HOUR1}
    {MORNING_HOUR2}   {MORNING_HOUR2}
    {MORNING_HOUR3}   {MORNING_HOUR3}
    {MORNING_HOUR4}   {MORNING_HOUR4}
    {MIDDAY_HOUR}     {MIDDAY_HOUR}
    {AFTERNOON_HOUR1} {AFTERNOON_HOUR1}
    {AFTERNOON_HOUR2} {AFTERNOON_HOUR2}
    {AFTERNOON_HOUR3} {AFTERNOON_HOUR3}
    {AFTERNOON_HOUR4} {AFTERNOON_HOUR4}
    {AFTERNOON_HOUR5} {AFTERNOON_HOUR5}
    {AFTERNOON_HOUR6} {AFTERNOON_HOUR6}
    {DUSK_HOUR}       {DUSK_HOUR}
    {DUSK_HOUR}       {DUSK_HOUR}
    {FIRST_WATCH_HOUR1}
    turns={TURNS}
          {SCENARIO_MUSIC knolls.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    
    [story]
        [part]
            #po: newlines at the beginning help to (depending on the screne size) center this vertically. The space at the end stops the last letter from getting cut off
            title=_"<span font_family='Oldania ADF Std' size='90000'>


<i>Part 2 </i></span>"
            title_alignment=center
        [/part]
        [part]
            story=_"The entry of Clan Blackcrest into the war opens up a new front further west, demanding swift response. Wesnoth fully mobilizes, and a series of bloody battles at the Ford of Abez end in deadlock for both sides. The ford is heavily fortified, and river commerce grinds to a halt. Many years pass, with neither side able to gain an advantage."
            background=story/fort-wp.png
        [/part]
        [part]
            story=_"Meanwhile, Asheviere gives birth to a healthy baby boy - the crown prince Eldred. Under heavy pressure from both parents and via the tutelage of General Lionel, Eldred rapidly matures into a princeling soldier. Prince Arand takes Eldred under his wing, and working in tandem the uncle and nephew are able to stabilize the eastern front around Fort Garard. Whitefang orcs still firmly hold the hills, but limited settlement begins."
            background=story/baby-wp.png
        [/part]
        [part]
            story=_"Delfador grows somewhat older, slightly wiser, and significantly more powerful. He makes a name for himself as the King’s premier war-mage, and quickly gains a reputation as a ferocious fighter. His bold maneuvers break through orcish lines several times at the Ford of Abez, but continually become stymied by saurian reinforcements."
            background=story/river-wp.png
        [/part]
        [part]
            story=_"As Wesnoth’s casualties continue to mount, and with no end in sight, Delfador decides to take matters into his own hands. The war-mage prepares a force of mercenary northmen to sneak behind enemy lines and determine the nature of Clan Blackcrest’s orc-saurian alliance..."
            background=story/graves-wp.png
        [/part]
    [/story]
    {DE_TRACK {JOURNEY_07_NEW}}
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   DEFINE SIDES
    #######################################################################################################################################################
    #############################
    # DELFADOR
    #############################
    [side]
        side,controller,color=1,human,red
        id,defeat_condition,gold=Delfador,never,{ON_DIFFICULTY4 40 35 30 20}
        team_name,user_team_name=wesnoth,_"Delfador’s Hirelings"
        fog=yes
        {FLAG_VARIANT loyalist}
    [/side]
    {STARTING_VILLAGES_AREA 1 9 24 10}
    
    
    #############################
    # SAURIANS
    #############################
    [side]
        side,controller,color=2,ai,black
        type=Saurian Ambusher
        id,name,facing=Ysaxis,_"Ysaxis",sw
        {MODIFICATIONS( {TRAIT_RESILIENT} {TRAIT_QUICK} )}
        team_name,user_team_name=saurians,_"Clan Blackcrest"
        fog=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    {STARTING_VILLAGES_AREA 2 25 1 20}
    [side]
        side,controller,color=3,ai,black
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=saurians,_"Clan Blackcrest"
        fog=yes
        {FLAG_VARIANT6 ragged}
    [/side]
    
    
    #############################
    # FISH
    #############################
    [side]
        side,controller,color=4,ai,blue
        no_leader,hidden,gold,income=yes,yes,0,-2
        team_name,user_team_name=saurians,_"Fish (and Beacon)"
        fog,share_vision=yes,none # no shared vision, or else the beacon can spot delfador
    [/side]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                    PREPARE MAP
    #######################################################################################################################################################
    [event]
        name=prestart
        
        #############################
        # SCENERY
        #############################
        {GENERIC_UNIT 4 Beacon 14 3} # beacon is on side 4 with no shared vision, or else it can spot delfador
        {SET_LABEL 14 3 ( _ "Mount Oromore")}
        
        
        #############################
        # ENEMIES
        #############################
        # main camp guards
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)               (Saurian Augur)      (Saurian Augur)      (Saurian Skirmisher)} 35 10 ({FACING nw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)               (Saurian Augur)      (Saurian Skirmisher) (Saurian Skirmisher)} 33 11 ({FACING nw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Saurian Augur)      (Saurian Augur)      (Saurian Skirmisher) (Saurian Skirmisher)} 32 13 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)               (Saurian Augur)      (Saurian Augur)      (Saurian Skirmisher)} 34 15 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)               (none)               (none)               (Saurian Skirmisher)} 36 15 ({FACING se})}
        
        # stationary sentries
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)   } 32 18 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)   } 23 18 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)   } 19 15 ({FACING se})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)   } 10 10 ({FACING sw})}
        
        # roving patrols
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)               (none)               (Saurian Augur)      (Saurian Augur)     }  6  7 ({FACING se} {ROLE patrol1})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)               (Saurian Augur)      (Saurian Augur)      (Saurian Augur)     } 25 17 ({FACING se} {ROLE patrol2})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)               (none)               (none)               (Saurian Augur)     } 21 15 ({FACING se} {ROLE patrol3})}
        {GENERIC_UNITC 3 {ON_DIFFICULTY4 (none)               (none)               (Saurian Augur)      (Saurian Augur)     } 15  3 ({FACING se} {ROLE patrol4})}
        
        # beacon guards
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Saurian Skirmisher) (Saurian Skirmisher) (Saurian Skirmisher) (Saurian Skirmisher)} 15 6 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)               (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)   } 17 4 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)    (Goblin Spearman)   } 11 4 ({FACING sw})}
        {GENERIC_UNITC 2 {ON_DIFFICULTY4 (none)               (none)               (Saurian Skirmisher) (Saurian Skirmisher)} 12 2 ({FACING sw})}
        
        
        #############################
        # UNIT MODIFICATIONS
        #############################
        [remove_trait]
            type=Goblin Spearman
        [/remove_trait]
        [modify_unit]
            {FILTER (type=Goblin Spearman)}
            {ON_DIFFICULTY4 {TRAIT_SLOW} {TRAIT_DIM} {TRAIT_DIM} {TRAIT_DIM}}
            [object]
                id=sleeping_goblins
                {EFFECT new_animation ([standing_anim]
                    base_score=99
                    {FRAME image="units/goblins/spearman-idle-[4~12].png:[300,150*8]"}
                [/standing_anim])}
            [/object]
        [/modify_unit]
        [event]
            name=attack end
            first_time_only=no
            {FILTER_SECOND (type=Goblin Spearman)}
            {REMOVE_OBJECT sleeping_goblins id=$second_unit.id}
        [/event]
        
        [remove_trait]
            role=patrol1 {OR role=patrol2} {OR role=patrol3} {OR role=patrol4}
        [/remove_trait]
        [modify_unit]
            {FILTER( role=patrol1 {OR role=patrol2} {OR role=patrol3} {OR role=patrol4} )}
            {TRAIT_QUICK} {TRAIT_INTELLIGENT} # standardize these guys, so the patrol speed doesn't vary
            moves=7 # otherwise they're stuck with 6 on the first turn
        [/modify_unit]
        
        # reset hitpoints, in case we removed/added a hitpoint-modifying trait
        [modify_unit]
            {FILTER ()}
            hitpoints=1
        [/modify_unit]
        {FULL_HEAL ()}
        
        
        
        #############################
        # ASSIGN PATROLS
        #############################
        [micro_ai]
            side,action,ai_type=3,add,patrol {FILTER role=patrol1}
            waypoint_x=6,13
            waypoint_y=7,8
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=3,add,patrol {FILTER role=patrol2}
            waypoint_x=25,32
            waypoint_y=17,17
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=3,add,patrol {FILTER role=patrol3}
            waypoint_x=14,21
            waypoint_y=13,15
        [/micro_ai]
        [micro_ai]
            side,action,ai_type=3,add,patrol {FILTER role=patrol4}
            waypoint_x=15,21
            waypoint_y=3,6
        [/micro_ai]
        
        # every other turn, set each patrol's move speed to 0.  So they wait briefly at each end, and give time for Delfador to sneak by.
        [event]
            name=side 3 turn refresh
            first_time_only=no
            {FILTER_CONDITION( {LUA(<< return wesnoth.current.turn%2==0 >>)} )}
            {MODIFY_UNIT( role=patrol2 {OR role=patrol4} ) moves 0}
        [/event]
        [event]
            name=side 3 turn refresh
            first_time_only=no
            {FILTER_CONDITION( {LUA(<< return wesnoth.current.turn%2==1 >>)} )}
            {MODIFY_UNIT( role=patrol1 {OR role=patrol3} ) moves 0}
        [/event]
        
        
        #############################
        # FISH
        #############################
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 none    Nibbler Nibbler Nibbler}  6 16 ()}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 none    none    Nibbler Nibbler} 15 17 ()}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 Nibbler Nibbler Nibbler Nibbler} 22 23 ()}
        {GENERIC_UNITC 4 {ON_DIFFICULTY4 none    none    none    Nibbler} 31 25 ()}
        [micro_ai]
            side,action,ai_type=4,add,zone_guardian {FILTER ()}
            {FILTER_LOCATION terrain=W*^*}
            [filter_location_enemy]
                [filter_adjacent_location]
                    terrain=W*^*
                [/filter_adjacent_location]
            [/filter_location_enemy]
        [/micro_ai]
        
        
        #############################
        # HUMANS
        #############################
        {RECALL_XY Delfador 9 24}
        [store_unit]
            {FILTER id=Delfador}
            variable,kill=delfador,yes
        [/store_unit]
        {KILL id=Delfador}
        [unit]
            {SINGLEUNITWML_DELFADOR}
            type,name,experience=Delfador L3,_"Delfador",$delfador.experience
            x,y,profile=$delfador.x,$delfador.y,portraits/young_delfador.webp~FL()
        [/unit]
        {CLEAR_VARIABLE delfador}
        {MODIFY_UNIT id=Delfador facing ne}
        [set_extra_recruit]
            id=Delfador
            extra_recruit={DELFADOR_BANDIT_RECRUIT}
        [/set_extra_recruit]
        
        {NAMED_NOTRAIT_UNIT 1 Thief       10 24 Lynyan    _"Lynyan"   } {FACING ne} {EXPERIENCE 13} {GENDER female} 
        {ADD_MODIFICATION( {TRAIT_LOYAL}{TRAIT_RESILIENT} )}
        {GIVE_OBJECT_TO id=Lynyan ({EFFECT profile portrait="portraits/humans/thief+female.webp"}) } # keep her portrait from changing on level-up, so she feels like the same unit throughout
        
        {NAMED_NOTRAIT_UNIT 1 "Rogue Mage" 8 24 Ritharran _"Ritharran"} {FACING ne} {EXPERIENCE  9} {GENDER male}
        {ADD_MODIFICATION( {TRAIT_RESILIENT}{TRAIT_STRONG} )}
        
        [lift_fog]
            {FILTER_SIDE side=1}
            x,y,radius=1-14,27,7
            multiturn=yes
        [/lift_fog]
        {SCROLL_TO 1 27}
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                   PLAY SCENARIO
    #######################################################################################################################################################
    [event]
        name=start
        
        [message]
            speaker=Delfador
            message=_"Alright men—"
        [/message]
        [message]
            speaker=Lynyan
            #po: and women
            message=_"And wom’n!"
        [/message]
        [message]
            speaker=Delfador
            #po: Delfador is paying these mercenaries himself; they're not wesnoth regulars
            message=_"—and women. I’ve selected you because you’re fast, you’re stealthy, and most importantly: you work for cheap. <span size='x-small'>Lousy Eldred wouldn’t give me any of my veterans.</span>"
        [/message]
        [message]
            speaker=Delfador
            #po: cross the Great River. Not at the Ford of Abez, but near.
            message=_"This is the perfect time for us to cross! It’s dawn, which means most of the orcs and saurians will be sleeping, and there’s a heavy winter fog to cover our movements. We should have time to clear this saurian outpost and sneak past the frontline before the main orcish army wakes at nightfall."
        [/message]
        [message]
            speaker=Delfador
            #po: there's a large metal braizer on a mountain filled with wood. If lit, the main orcish army will see it and come to fight Delfadaor
            message=_"But first, we need to destroy this outpost’s signal beacon."
        [/message]
        [lift_fog]
            {FILTER_SIDE side=1}
            x,y,multiturn=14,3,yes
        [/lift_fog]
        {HIGHLIGHT_IMAGE 14 3 items/gohere.png ()}
        {REMOVE_IMAGE 14 3}
        [message]
            speaker=Delfador
            #po: there's a large metal braizer on a mountain filled with wood. If lit, the main orcish army will see it and come to fight Delfadaor
            message=_"Even through the fog, a beacon fire that large will be visible for miles. If the orcish host at the Ford of Abez is alerted before we can get through to the swamp, we’ll be slaughtered!

Not that I wouldn’t mind a chance to incinerate more of those greasy buggers..."
        [/message]
        [message]
            speaker=Ritharran
            #po: hey genius, you forget there's a river there? I couldn't swim that far even if it weren't the middle of winter
            message=_"Hey genius, you forget about the river? I got expelled long before learning how to levitate, and the girl ’haint swimming that far even if’t it weren’t the middle of winter."
        [/message]
        {DELAY 500}
        {MOVE_UNIT id=Delfador 13 23}
        {DELAY 500}
        {FIRE_EVENT skill_blizzard}
        {MOVE_UNIT id=Delfador 9 24}
        {DELAY 100}
        {MODIFY_UNIT id=Delfador facing ne}
        {DELAY 400}
        [message]
            speaker=Ritharran
            message=_"Oh."
        [/message]
        
        
        #############################
        # OBJECTIVES
        #############################
        [objectives]
            [objective]
                description= _ "Destroy the signal beacon"
                condition=win
            [/objective]
            [objective]
                description= _ "An enemy sees you during their turn"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
            [note]
                description=_"Killing enemies swiftly will not raise the alarm."
            [/note]
        [/objectives]
        
        
        #############################
        # EXPLAIN SPELL SELECTION
        #############################
        {VARIABLE unlock_glamour      yes}
        {VARIABLE unlock_fireball3    yes} # not dancing daggers! In combo with levitate/polymorph and familiar, this lets Delfador solo the beacon and bypass the entire first phase (though that also makes the second phase harder)
        {VARIABLE unlock_animate_fire yes}
        {RESELECT_SKILLS_AFTER_OBJECTIVES (
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message=_"Your regular soldiers cannot sneak north with you, but you can instead recruit Footpads and Thieves!

FOOTPADS are quick-but-fragile scouts, with equally weak melee and ranged attacks. THIEVES trade the footpad’s ranged attack for improved melee damage, and are particularly deadly when attacking an enemy from behind.

<b><i>In fog, each unit can see 1 hex further than it can move. If an enemy spots you on their turn, they’ll call out to their allies and light the beacon, ruining Delfador’s plans.</i></b>"
            [/message]
            [message]
                speaker,image=narrator,wesnoth-icon.png
                message=_"This is a stealth segment. If you don’t like stealth or find it too difficult, you can choose to skip past."
                [option]
                    label= _ "Play the stealth segment (includes gold and XP)"
                [/option]
                [option]
                    label= _ "Skip the stealth segment"
                    [command]
                        {KILL type=Beacon}
                        {KILL side,x=2,0-15}
                        {KILL side,x=3,0-15}
                        {TELEPORT_UNIT id=Delfador  14 3}
                        {TELEPORT_UNIT id=Lynyan    13 3}
                        {TELEPORT_UNIT id=Ritharran 13 4}
                        [gold]
                            side,amount=1,30
                        [/gold]
                        [modify_turns]
                            current={TURNS}
                        [/modify_turns]
                        {FIRE_EVENT beacon_dies}
                        [return][/return] # don't select spells twice
                    [/command]
                [/option]
            [/message]
        ) ()}
    [/event]
    
    
    #############################
    # PREVENT SIDE 2 FROM ACTING
    #############################
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {FILTER_CONDITION({HAVE_UNIT(  type=Beacon  )})}
        {MODIFY_UNIT side=2 moves 0}
    [/event]
    
    
    #############################
    # REDUCE MAGICAL RNG
    #############################
    # Delfador is orders of magnitude more powerful than your other units, and missing multiple strikes in a row can lose you the scenario (since we rely on assassination)
    # during the stealth section, force all magical attacks to always hit 3/4 consistently
#define FORCE_MAGICAL_ACCURACY VALUE
    {REMOVE_OBJECT force_cth_magical ()}
    [modify_unit]
        {FILTER id=$unit.id}
        [object]
            id=force_cth_magical
            {EFFECT attack ([set_specials]
                mode=append
                [chance_to_hit]
                    value={VALUE}
                    overwrite_specials=both_sides
                [/chance_to_hit]
            [/set_specials])}
        [/object]
    [/modify_unit]
#enddef
    [event]
        name=attack
        first_time_only=no
        {FILTER side=1} {FILTER_ATTACK special_id_active=magical}
        {FILTER_CONDITION({HAVE_UNIT type=Beacon})}
        {FORCE_MAGICAL_ACCURACY 100} # first attack always hits
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        {FILTER side=1} {FILTER_ATTACK special_id_active=magical}
        {FILTER_CONDITION({HAVE_UNIT type=Beacon})}
        [if]{VARIABLE_CONDITIONAL hit_once not_equals yes}
            {THEN( {VARIABLE hit_once yes} )}
            {ELSE( {CLEAR_VARIABLE hit_once} {FORCE_MAGICAL_ACCURACY 0} )}
        [/if]
    [/event]
    [event]
        name=attacker misses
        first_time_only=no
        {FILTER side=1} {FILTER_ATTACK special_id_active=magical}
        {FILTER_CONDITION({HAVE_UNIT type=Beacon})}
        {CLEAR_VARIABLE hit_once}
        {FORCE_MAGICAL_ACCURACY 100}
    [/event]
    [event]
        name=attack end
        first_time_only=no
        {REMOVE_OBJECT force_cth_magical ()} # otherwise the player can see this
    [/event]
    
    
    #############################
    # REDUCE NONMAGICAL RNG
    #############################
    # during the stealth section, always hit every second strike vs units with 40-60% defense (which is most of them), 
    # and 100% of strikes vs the few units with 0-30% defense
    # this is an anti-frustration feature, to make sure you don't lose if you happen to get unlucky
#define FORCE_NONMAGIC_ACCURACY VALUE
    {REMOVE_OBJECT force_cth_nonmagic ()}
    [modify_unit]
        {FILTER id=$unit.id}
        [object]
            id=force_cth_nonmagic
            {EFFECT attack ([set_specials]
                mode=append
                [chance_to_hit]
                    value={VALUE}
                    overwrite_specials=both_sides
                [/chance_to_hit]
            [/set_specials])}
        [/object]
    [/modify_unit]
#enddef
    [event]
        name=attack
        first_time_only=no
        {FILTER side=1} {FILTER_ATTACK({NOT special_id_active=magical})}
        {FILTER_CONDITION({HAVE_UNIT type=Beacon})}
        {FORCE_NONMAGIC_ACCURACY 100} # first attack always hits. If defense isn't 40-60, this never changes, so all attacks will hit
    [/event]
    [event]
        name=attacker hits
        first_time_only=no
        {FILTER side=1} {FILTER_ATTACK({NOT special_id_active=magical})}
        {FILTER_SECOND defense=40-60}
        {FILTER_CONDITION({HAVE_UNIT type=Beacon})}
        {FORCE_NONMAGIC_ACCURACY 0}
    [/event]
    [event]
        name=attacker misses
        first_time_only=no
        {FILTER side=1} {FILTER_ATTACK({NOT special_id_active=magical})}
        {FILTER_SECOND defense=40-60}
        {FILTER_CONDITION({HAVE_UNIT type=Beacon})}
        {FORCE_NONMAGIC_ACCURACY 100}
    [/event]
    [event]
        name=attack end
        first_time_only=no
        {REMOVE_OBJECT force_cth_nonmagic ()} # otherwise the player can see this
    [/event]
    
    
    
    #############################
    # INSTRUCTIONAL MESSAGES
    #############################
    [event]
        name=sighted
        {FILTER side=2,3}
        [message]
            speaker=Delfador
            #po: the player has spotted a goblin or saurian on lookout duty
            message=_"Look out for that guard! If it spots us on its turn it’ll alert all the others."
        [/message]
    [/event]
    [event]
        name=exit hex
        {FILTER( role=patrol1 {OR role=patrol2} {OR role=patrol3} {OR role=patrol4} )}
        {FILTER( {FILTER_VISION visible,side=yes,1} )} # if a patrol unit moves while in vision of Delfador
        [message]
            speaker=Lynyan
            #po; the player has just sighted a saurian who patrols back and forth along a fixed path
            #po: that one's patrolling back and forth! Those lizards are ugly
            message=_"That one’s patrollin’ back an’ forth! Them lizards sure are ugly..."
        [/message]
    [/event]
    [event]
        name=die
        {FILTER_CONDITION({HAVE_UNIT(  type=Beacon  )})}
        {FILTER side=2,3}
        [message]
            speaker=$unit
            #po: an enemy has died swiftly, without making much noise
            message=_"Urk—"
        [/message]
        [message]
            speaker=Delfador
            message=_"Excellent! That one died before getting a chance to raise the alarm."
        [/message]
    [/event]
    [event]
        name=turn {TURNS_LOW_WARNING}
        {FILTER_CONDITION({HAVE_UNIT(  type=Beacon  )})}
        [message]
            speaker=Delfador
            message=_"I have to hurry! The fog is already starting to clear."
        [/message]
    [/event]
    
    
    #############################
    # YSAXIS NOTICES DELFADOR
    #############################
    [event]
        name=side 2 turn,enter hex
        {FILTER_CONDITION({VARIABLE_CONDITIONAL side_number not_equals 1})} # saurians only notice delfador on their turn
        {FILTER_CONDITION({HAVE_UNIT(  type=Beacon  )})}
        {FILTER_CONDITION({HAVE_UNIT(  side=1  {FILTER_VISION visible,side=yes,2-3}  )})}
        
        # find the unit that (hopefully) spotted the human, so we can have it say a voiceline
        [store_unit]
            {FILTER(  side=1  {FILTER_VISION visible,side=yes,2-3}  )}
            variable=visible_human
        [/store_unit]
        {FIND_NEARBY (side=2-3 {NOT type=Beacon}) $visible_human.x $visible_human.y 99}
        [lift_fog]
            x,y=0-99,0-99 # reveal the entire area, so we can see which unit spotted us
        [/lift_fog]
        [if] {VARIABLE_CONDITIONAL $found_unit.race equals lizard} {THEN(
            [message]
                speaker=$found_unit.id
                #po: presumably these saurians have fought Delfador before. They recognize him even if he's polymorphed
                #po: look, it's that wizard again! Light the fire, sound the alarm.
                message=_"Look, it’sss that wisssard again! Light the fire, sssound the alarm!"
            [/message]
        )} {ELSE(
            [message]
                speaker=$found_unit.id
                message=_"Look, it’s that wizard again! Light the fire, sound the alarm!"
            [/message]
        )} [/if]
        {CLEAR_VARIABLE visible_human,found_unit}
        
        {FIRE_EVENT notice_delfador}
    [/event]
    [event]
        name=die
        {FILTER type=Beacon}
        {FIRE_EVENT beacon_dies}
    [/event]
    [event]
        name=beacon_dies
        [message]
            speaker=Delfador
            message=_"The beacon is destroyed! And just in time too: the fog is starting to clear."
        [/message]
        [modify_side]
            {FILTER_SIDE()} fog=no
        [/modify_side]
        [message]
            speaker=Ysaxis
            #po: look, it's that wizard again! Light the fire, sound the alarm.
            message=_"Look, it’sss that wisssard again! Light the fire, sssound the alarm!"
        [/message]
        {FIRE_EVENT notice_delfador}
    [/event]
    [event]
        name=turn {TURNS} end
        {FILTER_CONDITION({HAVE_UNIT(  type=Beacon  )})}
        [message]
            speaker=Delfador
            message=_"I’ve tarried too long, the fog is already clearing!"
        [/message]
        [modify_side]
            {FILTER_SIDE()} fog=no
        [/modify_side]
        [message]
            speaker=Ysaxis
            #po: look, it's that wizard again! Light the fire, sound the alarm.
            message=_"Look, it’sss that wisssard again! Light the fire, sssound the alarm!"
        [/message]
        {FIRE_EVENT notice_delfador}
    [/event]
    [event]
        name=notice_delfador
        {REMOVE_OBJECT sleeping_goblins ()}
        [lift_fog]
            x,y,radius=35,13,1
        [/lift_fog]
        {DELAY 500}
        [if] {HAVE_UNIT type=Beacon} {THEN( # if we have the beacon
            [if] {HAVE_UNIT side,x,y=2-3,10-18,0-7} {THEN( # do we have a unit to light the beacon?
                [message]
                    speaker=Delfador
                    message=_"We’ve been spotted, and soon this outpost will be swarming with orcs! I hate running from a fight, but I have to retreat... "
                [/message]
                [endlevel]
                    result=defeat
                [/endlevel]
            )} {ELSE(
                {DELAY 1000}
                [message]
                    speaker=Ysaxis
                    #po: Ysaxis is ordering his minions to light the beacon fire, but there's nobody left to light the beacon
                    #po: I said, light the fire!
                    message=_"I sssaid, light the fire!"
                [/message]
                {DELAY 1000}
                {VARIABLE part2_message _"Cursssesss, the moutain guards are ssslain, and there is nobody to light the beacon!"}
                {FIRE_EVENT play_part2}
            )} [/if]
        )} {ELSE(
            {DELAY 1000}
            [message]
                speaker=Ysaxis
                #po: Ysaxis is ordering his minions to light the beacon fire, but the beacon is destroyed
                message=_"I sssaid, light the fire!"
            [/message]
            {DELAY 1000}
            {VARIABLE part2_message _"Cursssesss, the beacon is destroyed and the orcs still slumber!"}
            {FIRE_EVENT play_part2}
        )} [/if]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                       PART 2
    #######################################################################################################################################################
    [event]
        name=play_part2
        {KILL type=Beacon}
        [modify_side]
            {FILTER_SIDE()} fog=no # in case we took a path where this didn't happen before
        [/modify_side]
        
        [message]
            speaker=Ysaxis
            #po: no matter, my saurains will slip past and warn the army! Everyone, escape to the west!
            message=_"$part2_message No matter, my sssaurians will ssslip past and warn the army! Everyone, essscape to the west!"
        [/message]
        {CLEAR_VARIABLE part2_message}
        [message]
            speaker=Delfador
            #po: saurians are trying to run past Delfador's army and get orcs to come fight Delfador
            message=_"They’re making a run for it! Don’t let a single one get away, or this outpost will be swarming with orcs!"
        [/message]
        
        [modify_turns]
            value={TURNS2}
        [/modify_turns]
        
        {MODIFY_UNIT side=3 side 2}
        {MODIFY_UNIT role=patrol1 role ""}
        {MODIFY_UNIT role=patrol2 role ""}
        {MODIFY_UNIT role=patrol3 role ""}
        {MODIFY_UNIT role=patrol4 role ""}
        
        [micro_ai]
            side,action,ai_type=2,add,goto
            {FILTER ()}
            {FILTER_LOCATION x,y=1,1-12}
#             avoid_enemies=1 # this slowed down the battle too much
        [/micro_ai]
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 2 main_loop healing} # don't retreat
        {MODIFY_AI_DELETE_CANDIDATE_ACTION 2 main_loop villages}# don't try to grab villages (since we lose them when leader changes sides)
#         [event]
#             name=side 3 turn refresh
#             first_time_only=no
#             {MODIFY_UNIT side=2 side 3}
#             {MODIFY_UNIT side=3 moves 0}
#             {MODIFY_UNIT side=3 attacks_left 1} # goto MAI usually disables attacking; swap to side 3 so they still get a chance to attack
#         [/event]
#         [event]
#             name=side 3 turn end
#             first_time_only=no
#             {MODIFY_UNIT side=3 side 2}
#         [/event]
        
        [objectives]
            [objective]
                description= _ "Defeat enemies before any escape"
                condition=win
            [/objective]
            [objective]
                description= _ "Any enemy reaches the west edge of the map"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Delfador"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                carryover_percentage,bonus=40,yes
            [/gold_carryover]
        [/objectives]
        {RESELECT_SKILLS_AFTER_OBJECTIVES () ()} # objectives have changed, so allow reselecting your spells
    [/event]
    
    
    #############################
    # INSTRUCTIONAL MESSAGES
    #############################
    [event]
        name=turn {TURNS2_LOW_WARNING}
        [message]
            speaker=Delfador
            message=_"We must defeat these saurians and escape before nightfall, or the main orcish camp will wake and be upon us!"
        [/message]
    [/event]
    
    
    #############################
    # ORCS ARE ALERTED
    #############################
    [event]
        name=moveto
        {FILTER side,x=2-3,1}
        [message]
            speaker=$unit
            #po: I have escaped!
            message=_"I have essscaped!"
        [/message]
        [message]
            speaker=Delfador
            message=_"One of them has gotten away to warn the orcish army! I hate running from a fight, but we have to retreat..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=turn {TURNS2} end
        {GENERIC_UNIT 2 (Orcish Grunt)       1 7} {ANIMATE} {FACING ne}
        {GENERIC_UNIT 2 (Orcish Crossbowman) 2 8} {ANIMATE} {FACING se}
        {GENERIC_UNIT 2 (Orcish Archer)     1 10} {ANIMATE} {FACING se}
        {GENERIC_UNIT 2 (Goblin Pillager)    2 6} {ANIMATE} {FACING se}
        {GENERIC_UNIT 2 (Orcish Warrior)     3 9} {ANIMATE} {FACING ne}
        {GENERIC_UNIT 2 (Orcish Warlord)     3 8} {ANIMATE} {FACING se}
        [message]
            type=Orcish Warlord
            #po: an orc has just woken up and found Delfador fighting saurians
            message=_"<i>Yaawwnn</i> ...what’s all this noise about?"
        [/message]
        [message]
            speaker=Delfador
            message=_"We’ve taken too long, now it’s nighttime and the orcish camp has awoken! I hate running from a fight, but we have to retreat..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    
    
    
    
    
    #######################################################################################################################################################
    #                                                                       VICTORY
    #######################################################################################################################################################
    #############################
    # YSAXIS DIES
    #############################
    [event]
        name=last breath
        {FILTER id=Ysaxis}
        [message]
            speaker=Ysaxis
            message=_"Cursssesss..."
        [/message]
    [/event]
    
    
    #############################
    # ALL ENEMIES ARE DEAD
    #############################
    [event]
        name=die
        {FILTER_CONDITION( {NOT( {HAVE_UNIT( side=2-3 )} )} )}
        
        {SAY_IF_NOT_SUMMON second_unit _"Ah-ha, got you!"}
        [message]
            speaker=Delfador
            message=_"That’s the last one! Excellent work, we’ve wiped out this outpost and are still undetected! Now onwards to the Swamp of Dread, to find out why these saurians are fighting alongside orcs..."
        [/message]
        
        [if] {LUA(<< return wesnoth.current.turn<=20 >>)} {THEN({ACHIEVE s07})} [/if]
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
    
    
    {HERODEATHS}
[/scenario]





#undef TURNS
#undef TURNS_LOW_WARNING
#undef TURNS2
#undef TURNS2_LOW_WARNING
